<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LexiFlow MTI v8.3 (Cloud + AI PDF)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Noto+Serif+SC:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #4F46E5; --bg: #F8FAFC; --card-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); }
        html.dark { background-color: #0F172A; }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; transition: background 0.3s ease; min-height: 100vh; color: #1E293B; }
        .dark body { color: #F1F5F9; background-color: #0F172A; }
        .serif { font-family: 'Noto Serif SC', serif; }
        .hide { display: none !important; }
        
        .nav-capsule { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; padding: 12px 30px; border-radius: 100px; display: flex; gap: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); z-index: 100; border: 1px solid rgba(0,0,0,0.05); }
        .dark .nav-capsule { background: #1E293B; border-color: rgba(255,255,255,0.1); }
        .nav-link { font-size: 24px; transition: all 0.2s; opacity: 0.2; cursor: pointer; border:none; background:none; }
        .nav-link.active { opacity: 1; transform: scale(1.1); }

        .card-base { background: white; border-radius: 2rem; box-shadow: var(--card-shadow); transition: all 0.3s; border: 1px solid transparent; }
        .dark .card-base { background: #1E293B; border: 1px solid rgba(255,255,255,0.05); }
        
        .expandable-content { max-height: 0; overflow: hidden; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; }
        .expanded .expandable-content { max-height: 2000px; opacity: 1; padding-top: 1rem; }
        .expanded .chevron { transform: rotate(180deg); }

        .card-container { perspective: 2000px; width: 90%; max-width: 380px; height: 520px; margin: auto; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 2.5rem; background: white; padding: 2.5rem; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.08); }
        .dark .card-face { background: #1E293B; border: 1px solid rgba(255,255,255,0.1); }
        .card-back { transform: rotateY(180deg); }
        
        .weight-black { font-weight: 800; }
        .btn-active:active { transform: scale(0.95); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .book-checkbox { position: absolute; top: 1.25rem; right: 1.25rem; width: 1.5rem; height: 1.5rem; border-radius: 0.5rem; border: 2px solid rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center; transition: all 0.2s; cursor: pointer; z-index: 10; }
        .book-checkbox.active { background: white; color: #4F46E5; border-color: white; }

        .dark input, .dark textarea, .dark select { background-color: #1E293B !important; color: #F1F5F9 !important; border: 1px solid rgba(255,255,255,0.1) !important; }
    </style>
</head>
<body>

    <section id="auth-screen" class="fixed inset-0 bg-white dark:bg-slate-900 z-[1000] flex flex-col items-center justify-center p-8 text-slate-800 dark:text-white">
        <h1 class="text-4xl weight-black italic mb-2">Lexi<span class="text-indigo-600">MTI</span></h1>
        <p class="text-[9px] weight-black opacity-30 tracking-widest mb-8 uppercase">Cloud Edition</p>
        <div id="auth-box" class="w-full max-w-xs space-y-4">
            <input id="auth-email" type="email" placeholder="é‚®ç®± (Email)" class="w-full bg-slate-50 p-5 rounded-2xl outline-none text-center font-bold dark:bg-slate-800 border-2 border-transparent focus:border-indigo-500 transition-all">
            <input id="auth-pass" type="password" placeholder="å¯†ç  (Password)" class="w-full bg-slate-50 p-5 rounded-2xl outline-none text-center font-bold dark:bg-slate-800 border-2 border-transparent focus:border-indigo-500 transition-all">
            <button onclick="handleAuth('login')" class="w-full bg-indigo-600 text-white py-5 rounded-2xl weight-black shadow-lg btn-active">ç«‹å³ç™»å½•</button>
            <div class="flex justify-center gap-4 text-[10px] font-bold opacity-50 uppercase mt-4">
                <button onclick="handleAuth('signup')" class="hover:text-indigo-600">æ³¨å†Œæ–°è´¦å·</button>
            </div>
            <div id="auth-msg" class="text-center text-xs text-red-500 font-bold mt-2 hide"></div>
        </div>
    </section>

    <div id="app-content" class="hide flex flex-col max-w-2xl mx-auto w-full min-h-screen">
        <header class="p-8 flex justify-between items-center">
            <div>
                <h2 class="text-2xl weight-black italic dark:text-white">Lexi<span class="text-indigo-600">MTI</span></h2>
                <p class="text-[8px] weight-black opacity-30 tracking-[0.2em] uppercase dark:text-white">Master of Translation & Interpreting</p>
            </div>
            <button onclick="toggleSidebar(true)" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full shadow-sm flex items-center justify-center border border-slate-100 dark:border-slate-700">â˜°</button>
        </header>

        <main class="flex-1 px-8 pb-32">
            <div id="view-home" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div onclick="prepStudy('new')" class="card-base p-6 border-b-4 border-indigo-500 btn-active cursor-pointer">
                        <p class="text-[10px] weight-black opacity-30 uppercase mb-1 dark:text-slate-400">New Words</p>
                        <p id="num-new" class="text-4xl weight-black text-indigo-600">0</p>
                    </div>
                    <div onclick="prepStudy('review')" class="card-base p-6 border-b-4 border-emerald-500 btn-active cursor-pointer">
                        <p class="text-[10px] weight-black opacity-30 uppercase mb-1 dark:text-slate-400">Review</p>
                        <p id="num-rev" class="text-4xl weight-black text-emerald-500">0</p>
                    </div>
                </div>

                <div class="card-base p-5 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-slate-50 dark:bg-slate-800 rounded-xl flex items-center justify-center text-lg">ğŸ“š</div>
                        <div><h4 class="text-xs weight-black dark:text-white">æ´»è·ƒè¯ä¹¦</h4><p id="plan-text" class="text-[9px] opacity-40 uppercase tracking-widest dark:text-slate-400">---</p></div>
                    </div>
                    <span id="active-book-count" class="text-xl weight-black opacity-20 italic pr-6 dark:text-white">0</span>
                </div>

                <div onclick="switchTab('archive-mgr')" class="card-base p-5 flex items-center justify-between btn-active cursor-pointer">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-slate-50 dark:bg-slate-800 rounded-xl flex items-center justify-center text-lg">ğŸ“¥</div>
                        <div><h4 class="text-xs weight-black dark:text-white">å½’æ¡£ç®¡ç†</h4><p class="text-[9px] opacity-40 uppercase tracking-widest dark:text-slate-400">Archive Manager</p></div>
                    </div>
                    <span id="mastered-count" class="text-xl weight-black opacity-20 italic pr-6 dark:text-white">0</span>
                </div>

                <div class="bg-gradient-to-br from-indigo-600 to-blue-700 rounded-[2.5rem] p-8 text-white shadow-xl space-y-4 relative overflow-hidden">
                    <p id="quote-en" class="text-lg weight-black leading-tight italic tracking-tight relative z-10">Loading...</p>
                    <p id="quote-zh" class="text-sm serif opacity-80 relative z-10">---</p>
                </div>
            </div>

            <div id="view-books" class="hide">
                <div class="flex justify-between items-end mb-8"><h3 class="text-2xl weight-black italic dark:text-white">æˆ‘çš„ä¹¦æ¶</h3></div>
                <div id="book-grid" class="grid grid-cols-2 gap-5"></div>
            </div>

            <div id="view-explore" class="hide space-y-6">
                <input type="text" id="search-box" oninput="runSearch()" placeholder="æœç´¢è¯æ¡..." class="w-full p-5 rounded-2xl bg-white dark:bg-slate-800 shadow-sm outline-none font-bold text-sm dark:text-white">
                <div class="flex items-center gap-2 overflow-hidden">
                    <div id="cat-tags-container" class="flex gap-2 overflow-x-auto no-scrollbar py-2 flex-nowrap"></div>
                    <button onclick="createNewCategory()" class="w-10 h-10 bg-indigo-600 text-white rounded-full flex-shrink-0 text-xl font-bold btn-active">+</button>
                </div>
                <div id="search-list" class="space-y-4"></div>
            </div>

            <div id="view-book-detail" class="hide space-y-6">
                <div class="flex items-center gap-4">
                    <button onclick="switchTab('books')" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center dark:text-white shadow-sm btn-active">â†</button>
                    <h3 id="book-title-h" class="text-xl weight-black serif dark:text-white">---</h3>
                </div>
                <div id="book-item-list" class="space-y-4"></div>
            </div>

            <div id="view-import" class="hide space-y-6">
                <div class="card-base p-6 bg-indigo-50 dark:bg-indigo-900/10 border-2 border-dashed border-indigo-200 dark:border-indigo-800">
                    <p class="text-[10px] weight-black text-indigo-600 uppercase mb-4 text-center">AI PDF æ‰¹é‡åˆ†æ (Local App)</p>
                    <input type="file" id="pdf-file" accept=".pdf" class="hidden" onchange="updateFileName(this)">
                    <div id="pdf-file-name" class="text-[10px] text-center mb-2 opacity-50 dark:text-white">æœªé€‰æ‹©æ–‡ä»¶</div>
                    <button onclick="document.getElementById('pdf-file').click()" class="w-full py-3 bg-white dark:bg-slate-800 rounded-2xl text-xs weight-black shadow-sm btn-active mb-3">é€‰æ‹©æœ¬åœ° PDF</button>
                    <button id="pdf-btn" onclick="handlePDFUpload()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl text-[10px] weight-black uppercase shadow-lg btn-active">ç«‹å³åŒæ­¥è‡³äº‘ç«¯è¯åº“</button>
                </div>

                <div class="card-base p-8 space-y-6">
                    <div><p class="text-[9px] weight-black opacity-30 uppercase mb-2 dark:text-white">ç›®æ ‡è¯ä¹¦</p>
                    <select id="import-book-sel" class="w-full bg-slate-50 p-4 rounded-xl text-xs font-bold outline-none dark:bg-slate-800 dark:text-white"></select></div>
                    <div><p class="text-[9px] weight-black opacity-30 uppercase mb-2 dark:text-white">åˆ†ç±»</p>
                    <select id="import-cat-sel" class="w-full bg-slate-50 p-4 rounded-xl text-xs font-bold outline-none dark:bg-slate-800 dark:text-white"></select></div>
                    <input id="in-en" type="text" placeholder="English Term" class="w-full bg-slate-50 p-4 rounded-xl text-lg weight-black outline-none dark:bg-slate-800 dark:text-white">
                    <input id="in-zh" type="text" placeholder="ä¸­æ–‡ç¿»è¯‘" class="w-full bg-slate-50 p-4 rounded-xl text-lg serif outline-none dark:bg-slate-800 dark:text-white">
                    <textarea id="in-ai" placeholder="è§£é‡Šä¸ä¾‹å¥..." class="w-full bg-slate-50 p-4 rounded-xl text-xs h-32 resize-none serif outline-none dark:bg-slate-800 dark:text-white"></textarea>
                    <button onclick="doImport()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl weight-black shadow-lg btn-active">å­˜å…¥è¯åº“</button>
                </div>
            </div>

            <div id="view-archive-mgr" class="hide space-y-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4"><button onclick="switchTab('home')" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center dark:text-white shadow-sm btn-active">â†</button><h3 class="text-xl weight-black serif dark:text-white">å¾…å½’æ¡£</h3></div>
                    <button onclick="batchArchive()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] weight-black btn-active">å…¨éƒ¨ç¡®è®¤</button>
                </div>
                <div id="archive-list" class="space-y-4"></div>
            </div>
        </main>

        <nav class="nav-capsule">
            <button onclick="switchTab('home')" id="nav-home" class="nav-link active">ğŸ </button>
            <button onclick="switchTab('explore')" id="nav-explore" class="nav-link">ğŸ”</button>
            <button onclick="switchTab('books')" id="nav-books" class="nav-link">ğŸ“š</button>
            <button onclick="switchTab('import')" id="nav-import" class="nav-link">ğŸ“¥</button>
        </nav>
    </div>

    <section id="study-layer" class="fixed inset-0 bg-slate-50 dark:bg-slate-900 z-[200] hide flex flex-col">
        <header class="p-8 flex justify-between items-center">
            <button onclick="closeStudy()" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full shadow-sm flex items-center justify-center dark:text-white">âœ•</button>
            <div id="study-p" class="text-[10px] weight-black opacity-30 dark:text-white">0 / 0</div>
            <button onclick="playTTS()" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full shadow-sm flex items-center justify-center dark:text-white">ğŸ”Š</button>
        </header>
        <div class="flex-1 flex items-center justify-center p-6">
            <div class="card-container" id="studyCard">
                <div class="flip-card-inner" id="study-card-inner" onclick="handleCardFlip(event)">
                    <div class="card-face flex items-center justify-center px-10 text-center">
                        <span id="card-source" class="absolute top-6 px-3 py-1 bg-slate-100 dark:bg-slate-700 rounded-full text-[8px] weight-black opacity-40 uppercase tracking-widest dark:text-white">Source</span>
                        <h2 id="card-en" class="text-3xl weight-black italic tracking-tighter dark:text-white">Term</h2>
                    </div>
                    <div class="card-face card-back no-scrollbar overflow-y-auto" id="card-back-ui"></div>
                </div>
            </div>
        </div>
        <footer class="p-10 pb-16 flex gap-4 max-w-2xl mx-auto w-full">
            <button onclick="finishSRS(1)" class="flex-1 py-5 bg-slate-100 dark:bg-slate-800 rounded-2xl weight-black text-[11px] uppercase text-slate-400 btn-active">é—å¿˜ (1)</button>
            <button onclick="finishSRS(2)" class="flex-1 py-5 bg-indigo-50 dark:bg-indigo-900/30 rounded-2xl weight-black text-[11px] uppercase text-indigo-400 btn-active">é™Œç”Ÿ (2)</button>
            <button onclick="finishSRS(3)" class="flex-1 py-5 bg-indigo-600 text-white rounded-2xl weight-black text-[11px] uppercase shadow-lg btn-active">è®¤è¯† (3)</button>
        </footer>
    </section>

    <div id="notice-layer" class="fixed inset-0 bg-black/60 z-[500] hide flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-10 w-full max-w-sm shadow-2xl">
            <div id="notice-content" class="space-y-6"></div>
            <button onclick="toggleNotice(false)" class="w-full mt-8 py-4 bg-indigo-600 text-white rounded-2xl weight-black text-xs uppercase shadow-lg">æˆ‘æ˜ç™½äº†</button>
        </div>
    </div>

    <div id="side-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[300] hide"></div>
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-72 bg-white dark:bg-slate-900 z-[301] p-10 translate-x-full transition-transform duration-300 flex flex-col shadow-2xl">
        <div class="flex items-center gap-4 mb-8">
            <div id="user-avatar" class="w-12 h-12 rounded-2xl flex items-center justify-center text-white font-bold text-xl shadow-lg bg-indigo-600">ID</div>
            <div><p id="user-id-display" class="text-xs weight-black dark:text-white truncate w-32">æœªç™»å½•</p><p class="text-[8px] opacity-40 uppercase font-bold dark:text-slate-500">Cloud User</p></div>
        </div>
        <div class="flex-1 space-y-8 overflow-y-auto no-scrollbar">
            <div><p class="text-[10px] weight-black opacity-30 mb-4 uppercase dark:text-slate-400">å‘éŸ³åå¥½</p>
                <select id="voice-lang" class="w-full p-4 bg-slate-50 dark:bg-slate-800 rounded-xl text-xs font-bold outline-none dark:text-white">
                    <option value="en-US">ç¾å¼å‘éŸ³ (en-US)</option>
                    <option value="en-GB">è‹±å¼å‘éŸ³ (en-GB)</option>
                </select>
            </div>
            <div><p class="text-[10px] weight-black opacity-30 mb-4 uppercase dark:text-slate-400">å­¦ä¹ é™é‡: <span id="limit-val">20</span></p><input type="range" id="daily-limit" min="5" max="100" step="5" class="w-full accent-indigo-600" oninput="document.getElementById('limit-val').innerText=this.value"></div>
            <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl">
                <span class="text-xs font-bold dark:text-slate-300">å¤œé—´æ¨¡å¼</span>
                <input type="checkbox" id="dark-toggle" onchange="toggleDarkMode()" class="w-5 h-5 accent-indigo-600">
            </div>
            <button onclick="showAnnouncements()" class="w-full flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl btn-active"><span class="text-xs font-bold dark:text-slate-300">ç³»ç»Ÿå…¬å‘Š</span><span class="opacity-30">ğŸ“£</span></button>
        </div>
        <div class="pt-8 space-y-4">
            <button onclick="saveSettings()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl weight-black text-xs uppercase btn-active">ä¿å­˜è®¾ç½®</button>
            <button onclick="handleLogout()" class="w-full py-4 bg-slate-100 dark:bg-slate-800 text-red-500 rounded-2xl weight-black text-xs uppercase btn-active">é€€å‡ºè´¦å·</button>
        </div>
    </aside>

    <script>
        // --- 1. Cloud Config ---
        const SB_URL = "https://dxrswsuuuvstfipcldpz.supabase.co";
        const SB_KEY = "sb_publishable_qU3plC-_p-LY2p91i21n3g_0zrWuAV8";
        let sb; 

        // --- 2. State & Constants (ä¿ç•™ 8.2 å…¨éƒ¨å­—æ®µ) ---
        const APP_ANNOUNCEMENTS = [{ id: 3, date: "2026-02-11", title: "v8.3 AI PDFç‰ˆ", body: "1. å…¨é¢æ”¯æŒæœ¬åœ° PDF æ‰¹é‡è§£ææ¥å£ã€‚\n2. ä¿ç•™äº‘ç«¯åŒæ­¥ä¸å½’æ¡£ç®¡ç†ã€‚\n3. ä¼˜åŒ–åˆ†ç±»è¿‡æ»¤é€»è¾‘ã€‚" }];
        const QUOTES = [
            { en: "To translate, one must have a style of his own, for without it the translation will have no rhythm or nuance.", zh: "ç¿»è¯‘è€…å¿…é¡»æœ‰è‡ªå·±çš„é£æ ¼ï¼Œå¦åˆ™è¯‘æ–‡å°†ç¼ºä¹èŠ‚å¥ä¸ç»†å¾®å·®åˆ«ã€‚" },
            { en: "Translation is not a matter of words only: it is a matter of making intelligible a whole culture.", zh: "ç¿»è¯‘ä¸ä»…ä»…æ˜¯æ–‡å­—çš„é—®é¢˜ï¼Œå®ƒå…³ä¹è®©æ•´ä¸ªæ–‡åŒ–å˜å¾—æ˜“äºç†è§£ã€‚" }
        ];

        let state = { 
            user: null, uid: null, books: {}, mem: {}, 
            settings: { dailyLimit: 20, selectedBooks: [], dark: false, voice: 'en-US' }, 
            activeTab: 'home', curCat: 'ALL', queue: [], idx: 0, 
            categories: ["æ”¿æ²»", "ç»è´¸", "ç§‘æŠ€", "æ–‡åŒ–", "ä¿—è¯­"], activeBook: null 
        };

        // --- 3. Core Initialization (v8.2 é€»è¾‘) ---
        window.onload = function() {
            try {
                sb = window.supabase.createClient(SB_URL, SB_KEY);
                sb.auth.getSession().then(({ data: { session } }) => { if (session) initUser(session); });
                sb.auth.onAuthStateChange((_event, session) => {
                    if (session) initUser(session);
                    else { state.user = null; state.uid = null; document.getElementById('auth-screen').classList.remove('hide'); document.getElementById('app-content').classList.add('hide'); }
                });
            } catch (e) { alert("äº‘ç«¯è¿æ¥å¤±è´¥"); }
        };

        function initUser(session) {
            state.user = session.user.email; state.uid = session.user.id;
            document.getElementById('user-id-display').innerText = state.user;
            document.getElementById('auth-screen').classList.add('hide');
            document.getElementById('app-content').classList.remove('hide');
            loadData();
        }

        // --- 4. æ³¨å…¥ï¼šPDF ä¸šåŠ¡é€»è¾‘ ---
        function updateFileName(input) {
            document.getElementById('pdf-file-name').innerText = input.files[0] ? input.files[0].name : "æœªé€‰æ‹©æ–‡ä»¶";
        }

        async function handlePDFUpload() {
            const fileInput = document.getElementById('pdf-file');
            const btn = document.getElementById('pdf-btn');
            if (!fileInput.files[0]) return alert("è¯·å…ˆé€‰æ‹© PDF æ–‡ä»¶");

            btn.innerText = "æ­£åœ¨é€šè¿‡æœ¬åœ° AI è§£æå¹¶åŒæ­¥äº‘ç«¯..."; btn.disabled = true;
            const formData = new FormData();
            formData.append('pdf_file', fileInput.files[0]);

            try {
                const response = await fetch('http://127.0.0.1:5000/import_pdf', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.success) {
                    const bName = data.book_title || "PDF å¯¼å…¥è¯åº“";
                    if (!state.books[bName]) state.books[bName] = { items: [] };
                    
                    const newItems = data.items.map(i => ({
                        ...i, cat: "PDFè§£æ", from: bName, ts: Date.now()
                    }));

                    state.books[bName].items = [...newItems, ...state.books[bName].items];
                    await save(); // ç«‹å³è§¦å‘äº‘åŒæ­¥
                    alert(`åŒæ­¥æˆåŠŸï¼å·²å¯¼å…¥ ${data.items.length} æ¡è¯é¡¹`);
                    switchTab('books'); renderBooks();
                } else { alert("è§£æå¤±è´¥: " + data.error); }
            } catch (e) { alert("è¿æ¥å¤±è´¥ï¼šè¯·ç¡®ä¿æœ¬åœ° Flask (app.py) æ­£åœ¨è¿è¡Œã€‚"); }
            finally { btn.innerText = "ç«‹å³åŒæ­¥è‡³äº‘ç«¯è¯åº“"; btn.disabled = false; }
        }

        // --- 5. åŸæœ‰é€»è¾‘ï¼šæ•°æ®åŒæ­¥ (v8.2) ---
        async function loadData() {
            const localKey = `lexi_v82_${state.uid}`;
            const saved = localStorage.getItem(localKey);
            if(saved) parseData(JSON.parse(saved));

            const { data } = await sb.from('profiles').select('content').eq('id', state.uid).single();
            if (data && data.content) {
                parseData(data.content);
                save(false); 
            } else if (!saved) {
                state.books = { "2026 MTI æ ¸å¿ƒè¯æ±‡": { items: [] } };
                state.settings = { dailyLimit: 20, selectedBooks: ["2026 MTI æ ¸å¿ƒè¯æ±‡"], dark: false, voice: 'en-US' };
                initUI();
            }
        }

        function parseData(d) {
            state.books = d.books || {}; state.mem = d.mem || {};
            state.settings = d.settings || state.settings;
            state.categories = d.categories || ["æ”¿æ²»", "ç»è´¸", "ç§‘æŠ€", "æ–‡åŒ–", "ä¿—è¯­"];
            initUI();
        }

        async function save(pushToCloud = true) {
            const dataToSave = { books: state.books, mem: state.mem, settings: state.settings, categories: state.categories };
            localStorage.setItem(`lexi_v82_${state.uid}`, JSON.stringify(dataToSave));
            if(pushToCloud && state.uid) {
                await sb.from('profiles').upsert({ id: state.uid, content: dataToSave });
            }
            updateDash();
        }

        // --- 6. åŸæœ‰é€»è¾‘ï¼šUI äº¤äº’ (v8.2 æ ¸å¿ƒå‡½æ•°å…¨é›†) ---
        function initUI() {
            applyDarkMode();
            document.getElementById('dark-toggle').checked = state.settings.dark;
            document.getElementById('voice-lang').value = state.settings.voice || 'en-US';
            document.getElementById('daily-limit').value = state.settings.dailyLimit;
            document.getElementById('limit-val').innerText = state.settings.dailyLimit;
            initQuote(); updateDash(); renderBooks(); updateImportSelectors();
        }

        function initQuote() {
            const q = QUOTES[Math.floor(Math.random() * QUOTES.length)];
            document.getElementById('quote-en').innerText = q.en;
            document.getElementById('quote-zh').innerText = q.zh;
        }

        function updateDash() {
            let n = 0, r = 0, m = 0;
            const today = new Date().toDateString();
            Object.values(state.books).forEach(b => {
                b.items.forEach(i => {
                    const stat = state.mem[i.id];
                    if(!stat) n++;
                    else if(stat.mastered) m++;
                    else if(new Date(stat.next).toDateString() === today || stat.score < 3) r++;
                });
            });
            document.getElementById('num-new').innerText = n;
            document.getElementById('num-rev').innerText = r;
            document.getElementById('mastered-count').innerText = m;
            document.getElementById('active-book-count').innerText = state.settings.selectedBooks.length;
            document.getElementById('plan-text').innerText = state.settings.selectedBooks[0] || "æœªé€‰æ‹©è¯ä¹¦";
        }

        function switchTab(t) {
            state.activeTab = t;
            document.querySelectorAll('main > div, .nav-link').forEach(el => {
                el.classList.add('hide'); el.classList.remove('active');
            });
            const view = document.getElementById('view-' + t);
            if(view) view.classList.remove('hide');
            const nav = document.getElementById('nav-' + t);
            if(nav) nav.classList.add('active');

            if(t === 'explore') { renderExplore(); }
            if(t === 'books') { renderBooks(); }
            if(t === 'import') { updateImportSelectors(); }
            if(t === 'archive-mgr') { renderArchive(); }
        }

        // æ¸²æŸ“æœç´¢/æµè§ˆ
        function renderExplore() {
            const container = document.getElementById('cat-tags-container');
            let html = `<button onclick="setCat('ALL')" class="px-4 py-2 rounded-xl text-[10px] weight-black whitespace-nowrap ${state.curCat==='ALL'?'bg-indigo-600 text-white':'bg-white dark:bg-slate-800 dark:text-white'}">ALL</button>`;
            state.categories.forEach(c => {
                html += `<button onclick="setCat('${c}')" class="px-4 py-2 rounded-xl text-[10px] weight-black whitespace-nowrap ${state.curCat===c?'bg-indigo-600 text-white':'bg-white dark:bg-slate-800 dark:text-white'}">${c}</button>`;
            });
            container.innerHTML = html;
            runSearch();
        }

        function setCat(c) { state.curCat = c; renderExplore(); }

        function runSearch() {
            const key = document.getElementById('search-box').value.toLowerCase();
            let all = [];
            Object.values(state.books).forEach(b => all = all.concat(b.items));
            const filtered = all.filter(i => {
                const matchK = i.en.toLowerCase().includes(key) || i.zh.includes(key);
                const matchC = state.curCat === 'ALL' || i.cat === state.curCat;
                return matchK && matchC;
            });
            renderItemList('search-list', filtered);
        }

        // å¤ç”¨ 8.2 çš„åˆ—è¡¨æ„å»ºé€»è¾‘ (åŒ…å«å¯Œæ–‡æœ¬ã€è§£æåˆ†æ‹†ã€ç¬”è®°åŒæ­¥)
        function renderItemList(id, items) {
            const container = document.getElementById(id);
            if(!items || items.length === 0) { container.innerHTML = `<div class="py-20 text-center opacity-10 dark:text-white italic">åˆ—è¡¨ä¸ºç©º</div>`; return; }
            container.innerHTML = items.map(i => {
                const m = state.mem[i.id] || {note:""};
                return `
                <div class="card-base border border-slate-50 dark:border-slate-800 transition-all overflow-hidden mb-4" onclick="this.classList.toggle('expanded')">
                    <div class="p-6 flex justify-between items-center cursor-pointer">
                        <div class="flex-1">
                            <h5 class="text-lg weight-black tracking-tighter dark:text-white leading-tight mb-1">${i.en}</h5>
                            <span class="text-[8px] weight-black text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded-full uppercase tracking-widest">${i.cat}</span>
                        </div>
                        <span class="chevron transition-transform opacity-20 text-[10px] dark:text-white">â–¼</span>
                    </div>
                    <div class="expandable-content px-6 pb-6 border-t border-slate-50 dark:border-white/5">
                        ${buildRichContentUI(i, m.note, false)}
                        <div class="flex justify-end pt-4"><button onclick="deleteItem(event, '${i.id}')" class="text-[9px] text-red-400 weight-black uppercase opacity-40 hover:opacity-100">å½»åº•åˆ é™¤</button></div>
                    </div>
                </div>`;
            }).join('');
        }

        function buildRichContentUI(item, noteValue, isStudy = false) {
            const parts = item.ai.split(/ä¾‹å¥[:ï¼š]/);
            const analysis = parts[0] || "æš‚æ— è§£æ";
            const example = parts[1] || "";
            return `
                <div class="pt-4 space-y-6 text-left w-full">
                    <div>
                        <h3 class="text-2xl weight-black text-indigo-600 serif leading-tight mb-2">${item.zh}</h3>
                        <div class="text-xs serif text-slate-500 dark:text-slate-400 leading-relaxed">${analysis.replace(/\n/g, '<br>')}</div>
                    </div>
                    ${example ? `<div class="p-5 bg-slate-50 dark:bg-slate-900/50 rounded-3xl border border-slate-100 dark:border-white/5 relative overflow-hidden">
                        <p class="text-[8px] weight-black text-slate-300 dark:text-slate-600 mb-3 uppercase tracking-tighter">Context</p>
                        <p class="text-[13px] weight-black text-slate-700 dark:text-slate-300 leading-snug italic mb-2">"${example.split('\n')[0].trim()}"</p>
                        <p class="text-[11px] serif text-slate-400 dark:text-slate-500">${example.split('\n').slice(1).join('<br>')}</p>
                    </div>` : ''}
                    <div class="pt-2" onclick="event.stopPropagation()">
                        <p class="text-[8px] weight-black opacity-20 uppercase mb-2 dark:text-white tracking-widest">Personal Notes</p>
                        <textarea oninput="${isStudy?'syncNote()':'saveExternalNote(\''+item.id+'\', this.value)'}" 
                                  id="${isStudy?'card-note':'note-'+item.id}"
                                  placeholder="ç‚¹å‡»è¾“å…¥ç¬”è®°..."
                                  class="w-full bg-transparent p-0 text-[11px] outline-none serif min-h-[60px] border-l-2 border-indigo-100 dark:border-indigo-900/50 pl-4 dark:text-white">${noteValue}</textarea>
                    </div>
                </div>`;
        }

        // --- 7. å…¶ä½™æ ¸å¿ƒåŠŸèƒ½ (TTS, Auth, SRS, Sidebar) ---
        function playTTS() {
            const i = state.queue[state.idx];
            const msg = new SpeechSynthesisUtterance(i.en);
            msg.lang = state.settings.voice || 'en-US';
            window.speechSynthesis.speak(msg);
        }

        function toggleDarkMode() {
            state.settings.dark = document.getElementById('dark-toggle').checked;
            applyDarkMode(); save();
        }
        function applyDarkMode() { document.documentElement.classList.toggle('dark', state.settings.dark); }

        function toggleSidebar(s) {
            document.getElementById('sidebar').style.transform = s ? 'translateX(0)' : 'translateX(100%)';
            document.getElementById('side-overlay').classList.toggle('hide', !s);
        }

        function saveSettings() {
            state.settings.dailyLimit = parseInt(document.getElementById('daily-limit').value);
            state.settings.voice = document.getElementById('voice-lang').value;
            save(); toggleSidebar(false); alert("è®¾ç½®å·²åŒæ­¥è‡³äº‘ç«¯");
        }

        async function handleAuth(type) {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const msg = document.getElementById('auth-msg');
            if(!email || !pass) return (msg.innerText = "è¯·è¾“å…¥è´¦å·å¯†ç ", msg.classList.remove('hide'));
            msg.innerText = "å¤„ç†ä¸­..."; msg.classList.remove('hide');
            try {
                let res = (type === 'signup') ? await sb.auth.signUp({ email, password: pass }) : await sb.auth.signInWithPassword({ email, password: pass });
                if(res.error) throw res.error;
                if(type === 'signup') alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
            } catch (e) { msg.innerText = e.message; }
        }

        async function handleLogout() { await sb.auth.signOut(); location.reload(); }

        // --- å­¦ä¹ é€»è¾‘ (SRS) ---
        function prepStudy(type) {
            let list = [];
            const today = new Date().toDateString();
            state.settings.selectedBooks.forEach(bk => {
                if(state.books[bk]) list = list.concat(state.books[bk].items);
            });

            if(type === 'new') state.queue = list.filter(i => !state.mem[i.id]).slice(0, state.settings.dailyLimit);
            else state.queue = list.filter(i => state.mem[i.id] && !state.mem[i.id].mastered && (new Date(state.mem[i.id].next).toDateString() === today || state.mem[i.id].score < 3));

            if(state.queue.length === 0) return alert("å½“å‰æ²¡æœ‰å¾…å­¦è¯æ¡");
            state.idx = 0;
            document.getElementById('study-layer').classList.remove('hide');
            renderCard();
        }

        function renderCard() {
            const i = state.queue[state.idx];
            const m = state.mem[i.id] || {note:""};
            document.getElementById('study-card-inner').parentElement.classList.remove('flipped');
            document.getElementById('card-en').innerText = i.en;
            document.getElementById('card-source').innerText = i.from;
            document.getElementById('card-back-ui').innerHTML = `<div class="py-10">${buildRichContentUI(i, m.note, true)}</div>`;
            document.getElementById('study-p').innerText = `${state.idx + 1} / ${state.queue.length}`;
        }

        function handleCardFlip(e) { if(!e.target.closest('textarea')) document.getElementById('studyCard').classList.toggle('flipped'); }

        function syncNote() {
            const i = state.queue[state.idx];
            if(!state.mem[i.id]) state.mem[i.id] = { score: 0, next: Date.now(), mastered: false, note: "" };
            state.mem[i.id].note = document.getElementById('card-note').value;
        }

        function finishSRS(score) {
            const i = state.queue[state.idx];
            if(!state.mem[i.id]) state.mem[i.id] = { note: "" };
            state.mem[i.id].score = score;
            state.mem[i.id].next = Date.now() + (score * 86400000);
            if(score === 3 && !state.mem[i.id].mastered) { /* è®¤è¯†ä½†ä¸ç«‹å³å½’æ¡£ï¼Œç­‰å¾…ç”¨æˆ·åœ¨å½’æ¡£é¡µç¡®è®¤ */ }
            
            state.idx++;
            if(state.idx < state.queue.length) renderCard();
            else { save(); alert("å­¦ä¹ å®Œæˆï¼æ•°æ®å·²åŒæ­¥"); closeStudy(); }
        }

        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateDash(); }

        // --- å½’æ¡£ç®¡ç† ---
        function renderArchive() {
            let pending = [];
            Object.values(state.books).forEach(b => {
                b.items.forEach(i => {
                    if(state.mem[i.id] && state.mem[i.id].score >= 3 && !state.mem[i.id].mastered) pending.push(i);
                });
            });
            renderItemList('archive-list', pending);
        }

        function batchArchive() {
            Object.keys(state.mem).forEach(id => { if(state.mem[id].score >= 3) state.mem[id].mastered = true; });
            save(); switchTab('home'); alert("å½’æ¡£æˆåŠŸ");
        }

        // --- å·¥å…·å‡½æ•° ---
        function updateImportSelectors() {
            const bSel = document.getElementById('import-book-sel');
            const cSel = document.getElementById('import-cat-sel');
            bSel.innerHTML = Object.keys(state.books).map(k => `<option value="${k}">${k}</option>`).join('');
            cSel.innerHTML = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function doImport() {
            const b = document.getElementById('import-book-sel').value;
            const c = document.getElementById('import-cat-sel').value;
            const en = document.getElementById('in-en').value;
            const zh = document.getElementById('in-zh').value;
            const ai = document.getElementById('in-ai').value;
            if(!en || !zh) return alert("ä¿¡æ¯ä¸å…¨");
            state.books[b].items.unshift({ id: Date.now().toString(), en, zh, ai, cat: c, from: b, ts: Date.now() });
            save(); alert("å·²å­˜å…¥äº‘ç«¯");
            ["in-en", "in-zh", "in-ai"].forEach(id => document.getElementById(id).value = "");
        }

        function deleteItem(e, id) {
            e.stopPropagation();
            if(confirm("ç¡®å®šæ°¸ä¹…åˆ é™¤ï¼Ÿ")) {
                Object.values(state.books).forEach(b => b.items = b.items.filter(x => x.id !== id));
                delete state.mem[id];
                save(); runSearch();
            }
        }
        
        function renderBooks() {
            const grid = document.getElementById('book-grid');
            let html = Object.keys(state.books).map((k, idx) => {
                const isActive = state.settings.selectedBooks.includes(k);
                const colors = ["from-indigo-600 to-blue-700", "from-rose-500 to-pink-600", "from-emerald-500 to-teal-600"];
                return `<div onclick="openBook('${k}')" class="aspect-[3/4] rounded-3xl bg-gradient-to-br ${colors[idx%3]} p-6 flex flex-col justify-between text-white shadow-xl btn-active relative overflow-hidden">
                    <div onclick="toggleBookActive(event, '${k}')" class="book-checkbox ${isActive?'active':''}">${isActive ? 'âœ“' : ''}</div>
                    <h4 class="text-lg weight-black serif leading-tight mt-2">${k}</h4>
                    <p class="text-[10px] weight-black opacity-70">${state.books[k].items.length} æ¡ç›®</p>
                </div>`;
            }).join('');
            grid.innerHTML = html + `<div onclick="createNewBook()" class="aspect-[3/4] rounded-3xl border-2 border-dashed border-slate-200 dark:border-slate-700 flex flex-col items-center justify-center gap-2 opacity-40 btn-active"><span class="text-4xl">+</span><span class="text-[10px] weight-black uppercase">æ–°å»ºè¯ä¹¦</span></div>`;
        }

        function openBook(k) { state.activeBook = k; document.getElementById('book-title-h').innerText = k; switchTab('book-detail'); renderItemList('book-item-list', state.books[k].items); }
        function toggleBookActive(e, k) {
            e.stopPropagation();
            state.settings.selectedBooks = state.settings.selectedBooks.includes(k) ? state.settings.selectedBooks.filter(x => x !== k) : [...state.settings.selectedBooks, k];
            save(); renderBooks();
        }
        function createNewBook() { const n = prompt("åç§°:"); if(n && !state.books[n]) { state.books[n]={items:[]}; save(); renderBooks(); } }
        function createNewCategory() { const n = prompt("åˆ†ç±»å:"); if(n && !state.categories.includes(n)) { state.categories.push(n); save(); renderExplore(); } }
        function toggleNotice(s) { document.getElementById('notice-layer').classList.toggle('hide', !s); }
        function showAnnouncements() { 
            document.getElementById('notice-content').innerHTML = APP_ANNOUNCEMENTS.map(a => `<div><p class="text-[10px] weight-black text-indigo-600 mb-1">${a.date}</p><h4 class="weight-black text-xl dark:text-white mb-2">${a.title}</h4><p class="text-xs opacity-60 dark:text-slate-400">${a.body.replace(/\n/g, '<br>')}</p></div>`).join('');
            toggleNotice(true); 
        }
        function saveExternalNote(id, val) { if(!state.mem[id]) state.mem[id] = { score: 0, next: Date.now(), mastered: false, note: "" }; state.mem[id].note = val; save(); }
    </script>
</body>
</html>
