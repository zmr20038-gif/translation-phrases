<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LexiFlow Pro v7.Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #F8FAFC; --text: #1E293B; --card: #FFFFFF; --accent: #6366F1; }
        .dark { --bg: #0F172A; --text: #F1F5F9; --card: #1E293B; --accent: #818CF8; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.3s; }

        /* ä¾§è¾¹æ  */
        #settings-sidebar { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #settings-sidebar.open { transform: translateX(0); }

        /* å­¦ä¹ å¡ç‰‡ */
        .card-container { perspective: 1000px; width: 100%; height: 450px; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 2.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; background: var(--card); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); }
        .card-back { transform: rotateY(180deg); border: 2px solid var(--accent); overflow-y: auto; }

        .stat-bar { height: 8px; border-radius: 4px; background: #E2E8F0; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--accent); transition: width 0.5s; }
        .hide { display: none !important; }
        .active-tab { color: var(--accent); font-weight: 800; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-24">

    <header class="max-w-md mx-auto px-6 pt-10 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-[900] tracking-tighter italic">LexiFlow<span class="text-indigo-500">.</span></h1>
            <p id="rank-tag" class="text-[9px] font-black opacity-40 uppercase tracking-widest text-indigo-600">è¯æ±‡å­¦å¾’ Lv.1</p>
        </div>
        <button onclick="toggleSidebar(true)" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow-sm">âš™ï¸</button>
    </header>

    <main id="view-home" class="max-w-md mx-auto px-6 mt-8">
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div onclick="openStudy('new')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] shadow-sm active:scale-95 transition-all">
                <span class="text-[9px] font-black opacity-30 uppercase tracking-widest">éœ€å­¦ä¹ </span>
                <p id="num-new" class="text-4xl font-black mt-1 text-indigo-500">0</p>
            </div>
            <div onclick="openStudy('review')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] shadow-sm active:scale-95 transition-all">
                <span class="text-[9px] font-black opacity-30 uppercase tracking-widest">å¾…å¤ä¹ </span>
                <p id="num-review" class="text-4xl font-black mt-1 text-emerald-500">0</p>
            </div>
        </div>
        <div class="bg-indigo-600 p-8 rounded-[3rem] text-white shadow-xl shadow-indigo-100">
            <h3 class="font-black text-[10px] opacity-60 uppercase mb-4">ä»Šæ—¥è¿›åº¦</h3>
            <div class="stat-bar bg-white/20 mb-4"><div id="home-progress" class="stat-fill bg-white" style="width: 0%"></div></div>
            <p class="text-sm italic opacity-90">"The limit of your language is the limit of your world."</p>
        </div>
    </main>

    <main id="view-explore" class="max-w-md mx-auto px-6 mt-8 hide">
        <div class="flex gap-2 mb-6 overflow-x-auto no-scrollbar">
            <button onclick="setFilter('all')" class="px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">å…¨éƒ¨</button>
            <button onclick="setFilter('legal')" class="px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">âš–ï¸ æ³•å¾‹</button>
            <button onclick="setFilter('gaming')" class="px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">ğŸ® æ¸¸æˆ</button>
            <button onclick="setFilter('food')" class="px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">ğŸ³ é£Ÿç‰©</button>
        </div>
        <div id="explore-list" class="space-y-4 pb-12"></div>
    </main>

    <main id="view-stats" class="max-w-md mx-auto px-6 mt-8 hide">
        <h2 class="text-2xl font-black mb-6">æ•°æ®åˆ†æ</h2>
        <div class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] mb-6 shadow-sm">
            <p class="text-[10px] font-black opacity-30 uppercase tracking-widest mb-4">è®°å¿†åŠ›åˆ†å¸ƒ (Level 0-8)</p>
            <div id="ebbinghaus-stats" class="space-y-4"></div>
        </div>
    </main>

    <section id="study-layer" class="fixed inset-0 bg-white dark:bg-slate-900 z-[200] hide flex flex-col p-8">
        <div class="flex justify-between items-center mb-6">
            <button onclick="closeStudy()" class="text-2xl opacity-20">âœ•</button>
            <div id="study-progress" class="text-[10px] font-black opacity-30 tracking-widest">1 / 10</div>
            <button onclick="speakWord()" class="text-xl">ğŸ”Š</button>
        </div>
        <div class="flex-1 flex items-center justify-center">
            <div class="card-container" id="studyCard">
                <div class="flip-card-inner" onclick="this.parentElement.classList.toggle('flipped')">
                    <div class="card-face card-front">
                        <span id="card-cat" class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-4">CAT</span>
                        <h2 id="card-en" class="text-4xl font-black text-center tracking-tighter">Word</h2>
                        <p class="mt-12 text-[9px] opacity-20 font-black uppercase tracking-widest">ç‚¹å‡»æŸ¥çœ‹é‡Šä¹‰</p>
                    </div>
                    <div class="card-face card-back">
                        <h3 id="card-zh" class="text-2xl font-bold text-indigo-500 mb-2">ç¿»è¯‘</h3>
                        <p id="card-d" class="text-xs opacity-50 text-center mb-6 px-4">è¯¦ç»†è§£é‡Š</p>
                        <div class="w-full p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl text-left">
                            <span class="text-[8px] font-black opacity-30 uppercase block mb-1 italic">ğŸ¬ AI åœºæ™¯è”æƒ³</span>
                            <p id="card-example" class="text-[11px] leading-relaxed font-medium"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="study-controls" class="grid grid-cols-3 gap-3 mt-8">
            <button onclick="handleLearn(1)" class="py-5 bg-slate-100 dark:bg-slate-800 rounded-[2rem] font-black text-[10px] uppercase">å¿˜äº†</button>
            <button onclick="handleLearn(2)" class="py-5 bg-indigo-50 dark:bg-slate-800 rounded-[2rem] font-black text-[10px] text-indigo-400 uppercase">æ¨¡ç³Š</button>
            <button onclick="handleLearn(3)" class="py-5 bg-indigo-600 rounded-[2rem] font-black text-[10px] text-white shadow-lg uppercase">è®¤è¯†</button>
        </div>
    </section>

    <div id="settings-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-black/10 backdrop-blur-sm z-[300] hide"></div>
    <aside id="settings-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-900 z-[301] shadow-2xl p-8">
        <h2 class="text-2xl font-black mb-10 tracking-tighter">Settings</h2>
        <div class="space-y-8">
            <div>
                <label class="text-[10px] font-black opacity-30 uppercase block mb-3">Interface</label>
                <button onclick="toggleDarkMode()" class="w-full p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl flex justify-between font-bold text-sm">
                    <span>å¤–è§‚æ¨¡å¼</span><span id="mode-icon">ğŸŒ</span>
                </button>
            </div>
            <div>
                <label class="text-[10px] font-black opacity-30 uppercase block mb-3">Daily Goal</label>
                <div class="flex justify-between font-black text-indigo-500 mb-2"><span id="goal-val">10</span><span>è¯/å¤©</span></div>
                <input type="range" min="5" max="50" step="5" value="10" oninput="updateGoal(this.value)" class="w-full h-1.5 bg-slate-100 rounded-full appearance-none accent-indigo-600">
            </div>
            <div class="pt-10">
                <button onclick="clearData()" class="w-full py-4 text-red-500 text-[10px] font-black uppercase rounded-2xl border border-red-50">é‡ç½®æ‰€æœ‰æ•°æ®</button>
            </div>
        </div>
    </aside>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-72 h-20 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl rounded-[2.5rem] shadow-2xl flex items-center justify-around z-[100]">
        <button onclick="switchTab('home')" id="btn-home" class="p-3 active-tab text-2xl">ğŸ </button>
        <button onclick="switchTab('explore')" id="btn-explore" class="p-3 opacity-30 text-2xl">ğŸ”</button>
        <button onclick="switchTab('stats')" id="btn-stats" class="p-3 opacity-30 text-2xl">ğŸ“ˆ</button>
    </nav>

    <script>
        // è¯åº“ A-Z
        const RAW_LIB = [
            { id:'g1', cat:'gaming', en:'Aggro', zh:'ä»‡æ¨å€¼', d:'è¡¡é‡æ€ªç‰©å¯¹ä¸åŒç©å®¶æ”»å‡»æ¬²æœ›çš„æ•°å€¼ã€‚', scenes: ["ã€Šå¤´å·ç©å®¶ã€‹ï¼šåœ¨è¿™ç§ç­‰çº§çš„å‰¯æœ¬é‡Œï¼Œåƒä¸‡åˆ«ä¹±æ‹‰ Aggroã€‚"] },
            { id:'f1', cat:'food', en:'Al Dente', zh:'å¼¹ç‰™', d:'å½¢å®¹æ„é¢æˆ–ç±³é¥­ä¸­å¿ƒä¿ç•™ä¸€ä¸åš¼åŠ²ã€‚', scenes: ["ã€Šç¾é£Ÿæ€»åŠ¨å‘˜ã€‹ï¼šå®Œç¾çš„æ„å¤§åˆ©é¢å¿…é¡»ä¿æŒ Al Dente çš„å£æ„Ÿã€‚"] },
            { id:'l1', cat:'legal', en:'Bona Fide', zh:'å–„æ„', d:'æ³•å¾‹æœ¯è¯­ï¼ŒæŒ‡ä¸»è§‚å‡ºäºçœŸè¯šã€æ— æ¬ºè¯ˆæ„å›¾ã€‚', scenes: ["ã€Šé‡‘è£…å¾‹å¸ˆã€‹ï¼šHarvey è´¨ç–‘å¯¹æ–¹æ˜¯å¦ Bona Fide å±¥è¡ŒåˆåŒã€‚"] },
            { id:'l3', cat:'legal', en:'Due Diligence', zh:'å°½èŒè°ƒæŸ¥', d:'å¯¹èµ„äº§åŠé£é™©çš„å…¨é¢è°ƒæŸ¥ã€‚', scenes: ["ã€Šåˆå…¥èŒåœºçš„æˆ‘ä»¬ã€‹ï¼šä¸€ä»½åˆæ ¼çš„å°½èŒè°ƒæŸ¥æ˜¯æŠ•è¡Œçš„åŸºæœ¬åŠŸã€‚"] },
            { id:'g2', cat:'gaming', en:'Fog of War', zh:'æˆ˜äº‰è¿·é›¾', d:'é®è”½æœªæ¢ç´¢åŒºåŸŸçš„è§†è§‰æ•ˆæœã€‚', scenes: ["ã€Šé­”å…½äº‰éœ¸ã€‹ï¼šè¿·é›¾ä¸­å¯èƒ½éšè—ç€æ•Œäººçš„ä¼å…µã€‚"] },
            { id:'l2', cat:'legal', en:'Force Majeure', zh:'ä¸å¯æŠ—åŠ›', d:'ä¸èƒ½é¢„è§ã€é¿å…ä¸”å…‹æœçš„å®¢è§‚æƒ…å†µã€‚', scenes: ["ã€Šç”Ÿæ´»å¤§çˆ†ç‚¸ã€‹ï¼šSheldon çš„ç§Ÿæˆ¿åè®®é‡Œå†™æ»¡äº†ä¸å¯æŠ—åŠ›ã€‚"] },
            { id:'f2', cat:'food', en:'Maillard Reaction', zh:'ç¾æ‹‰å¾·ååº”', d:'åŠ çƒ­æ—¶å‘ç”Ÿçš„è¤å˜ååº”ï¼Œé¦™æ°”ä¹‹æºã€‚', scenes: ["ã€Šé¡¶çº§å¨å¸ˆã€‹ï¼šç‰›æ’çš„é¦™æ°”æ¥è‡ªäºå®Œç¾çš„ç¾æ‹‰å¾·ååº”ã€‚"] },
            { id:'g3', cat:'gaming', en:'Metagame', zh:'å…ƒæ¸¸æˆ', d:'å½“å‰æœ€é«˜æ•ˆçš„æˆ˜æœ¯ç»„åˆè¶‹åŠ¿ã€‚', scenes: ["ã€Šè‹±é›„è”ç›Ÿã€‹ï¼šä½ éœ€è¦é€‚åº”è¿™ä¸ªç‰ˆæœ¬çš„ Metagameã€‚"] },
            { id:'l4', cat:'legal', en:'Statute of Limitations', zh:'è¯‰è®¼æ—¶æ•ˆ', d:'æ³•å¾‹è§„å®šæƒåˆ©è¡Œä½¿çš„æ—¶é—´é™åˆ¶ã€‚', scenes: ["ã€Šç ´äº§å§å¦¹ã€‹ï¼šå³ä¾¿è¿‡äº†è¯‰è®¼æ—¶æ•ˆï¼Œè‰¯å¿ƒä¹Ÿä¸ä¼šå®‰å®ã€‚"] },
            { id:'f3', cat:'food', en:'Umami', zh:'é²œå‘³', d:'é™¤äº†é…¸ç”œè‹¦å’¸ä¹‹å¤–çš„ç¬¬äº”ç§åŸºæœ¬å‘³é“ã€‚', scenes: ["ã€Šæ·±å¤œé£Ÿå ‚ã€‹ï¼šè¿™ç¢—æ±¤çš„ Umami å±‚æ¬¡éå¸¸ä¸°å¯Œã€‚"] }
        ].sort((a,b) => a.en.localeCompare(b.en));

        let state = {
            mem: JSON.parse(localStorage.getItem('lexi_v8_mem') || '{}'),
            notes: JSON.parse(localStorage.getItem('lexi_v8_notes') || '{}'),
            goal: parseInt(localStorage.getItem('lexi_v8_goal') || '10'),
            dark: localStorage.getItem('lexi_v8_dark') === 'true',
            filter: 'all', queue: [], idx: 0
        };

        // --- å­¦ä¹ ç³»ç»Ÿ ---
        function openStudy(type) {
            const now = Date.now();
            state.queue = RAW_LIB.filter(i => {
                const m = state.mem[i.id];
                return type === 'new' ? (m && m.lv === 0) : (m && m.lv > 0 && now >= m.next);
            }).slice(0, state.goal);
            
            if(!state.queue.length) return alert("å½“å‰æ²¡æœ‰å¯å­¦ä¹ çš„è¯æ¡ï¼");
            state.idx = 0;
            document.getElementById('study-layer').classList.remove('hide');
            showCard();
        }

        function showCard() {
            const item = state.queue[state.idx];
            document.getElementById('studyCard').classList.remove('flipped');
            document.getElementById('card-en').innerText = item.en;
            document.getElementById('card-zh').innerText = item.zh;
            document.getElementById('card-d').innerText = item.d;
            document.getElementById('card-cat').innerText = item.cat;
            document.getElementById('card-example').innerText = item.scenes[0];
            document.getElementById('study-progress').innerText = `${state.idx+1} / ${state.queue.length}`;
            document.getElementById('study-controls').style.pointerEvents = 'auto';
        }

        function handleLearn(score) {
            document.getElementById('studyCard').classList.add('flipped');
            document.getElementById('study-controls').style.pointerEvents = 'none';
            const item = state.queue[state.idx];
            const m = state.mem[item.id];
            if(score === 3) m.lv += 1; else if(score === 1) m.lv = Math.max(1, m.lv - 1);
            const intervals = [0, 0.1, 1, 2, 4, 7, 15, 30, 60];
            m.next = Date.now() + (intervals[Math.min(m.lv, 8)] * 86400000);
            save();
            setTimeout(() => {
                state.idx++;
                if(state.idx < state.queue.length) showCard(); else closeStudy();
            }, 1200);
        }

        // --- æ¢ç´¢é¡µ (ä¿®å¤åˆ†ç±»ä¸ç¬”è®°) ---
        function setFilter(cat) { state.filter = cat; renderExplore(); }

        function renderExplore() {
            const container = document.getElementById('explore-list');
            const filtered = RAW_LIB.filter(i => state.filter === 'all' || i.cat === state.filter);
            container.innerHTML = filtered.map(i => `
                <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-6 shadow-sm">
                    <div class="flex justify-between items-start" onclick="toggleDetail('${i.id}')">
                        <div>
                            <span class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">${i.cat}</span>
                            <h4 class="text-lg font-black mt-1">${i.en}</h4>
                        </div>
                        <button onclick="addToPlan(event, '${i.id}')" class="text-[10px] font-black px-4 py-2 rounded-full ${state.mem[i.id] ? 'bg-emerald-500 text-white':'bg-indigo-50 text-indigo-500'}">
                            ${state.mem[i.id] ? 'âœ“' : '+ ADD'}
                        </button>
                    </div>
                    <div id="detail-${i.id}" class="hide mt-4 pt-4 border-t border-slate-50 dark:border-slate-700">
                        <p class="text-sm font-bold text-indigo-500 mb-2">${i.zh}</p>
                        <p class="text-[11px] opacity-60 leading-relaxed mb-4">${i.d}</p>
                        <div class="bg-slate-50 dark:bg-slate-900 p-3 rounded-xl">
                            <textarea onchange="saveNote('${i.id}', this.value)" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ çš„ç¬”è®°..." class="w-full bg-transparent text-xs outline-none min-h-[60px]">${state.notes[i.id] || ''}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleDetail(id) { document.getElementById(`detail-${id}`).classList.toggle('hide'); }

        // --- åŸºç¡€è¾…åŠ© ---
        function switchTab(tab) {
            ['home', 'explore', 'stats'].forEach(t => {
                document.getElementById('view-'+t).classList.toggle('hide', t !== tab);
                document.getElementById('btn-'+t).classList.toggle('active-tab', t === tab);
                document.getElementById('btn-'+t).classList.toggle('opacity-30', t !== tab);
            });
            if(tab === 'explore') renderExplore();
            if(tab === 'stats') renderStats();
        }

        function updateGoal(val) {
            state.goal = parseInt(val);
            document.getElementById('goal-val').innerText = val;
            localStorage.setItem('lexi_v8_goal', val);
            autoAllocate();
            updateDashboard();
        }

        function autoAllocate() {
            let learning = Object.keys(state.mem).filter(id => state.mem[id].lv === 0);
            if(learning.length < state.goal) {
                let pool = RAW_LIB.filter(i => !state.mem[i.id]).sort(() => Math.random() - 0.5);
                for(let i=0; i < Math.min(state.goal - learning.length, pool.length); i++) {
                    state.mem[pool[i].id] = { lv: 0, next: 0 };
                }
                save();
            }
        }

        function updateDashboard() {
            const news = RAW_LIB.filter(i => state.mem[i.id]?.lv === 0).length;
            const reviews = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && Date.now() >= state.mem[i.id].next).length;
            document.getElementById('num-new').innerText = news;
            document.getElementById('num-review').innerText = reviews;
            document.getElementById('home-progress').style.width = Math.min(100, ( (state.goal-news)/state.goal ) * 100) + '%';
        }

        function renderStats() {
            const levels = new Array(9).fill(0);
            Object.values(state.mem).forEach(m => levels[Math.min(m.lv, 8)]++);
            document.getElementById('ebbinghaus-stats').innerHTML = levels.map((count, i) => `
                <div>
                    <div class="flex justify-between text-[10px] font-bold mb-1 opacity-50"><span>LEVEL ${i}</span><span>${count} è¯æ¡</span></div>
                    <div class="stat-bar"><div class="stat-fill" style="width: ${(count/RAW_LIB.length)*100}%"></div></div>
                </div>
            `).join('');
            const rank = Math.min(Math.floor(Object.keys(state.mem).length / 3), 4);
            const titles = ["è¯æ±‡å­¦å¾’", "è¯­è¨€è¡Œè€…", "å¾‹æ”¿å…ˆé”‹", "åšå­¦è€…", "è¯­è¨€å¤§å¸ˆ"];
            document.getElementById('rank-tag').innerText = titles[rank] + ` Lv.${rank+1}`;
        }

        function toggleSidebar(show) {
            document.getElementById('settings-sidebar').classList.toggle('open', show);
            document.getElementById('settings-overlay').classList.toggle('hide', !show);
        }

        function toggleDarkMode() {
            state.dark = !state.dark;
            document.body.classList.toggle('dark', state.dark);
            document.getElementById('mode-icon').innerText = state.dark ? 'ğŸŒ™' : 'ğŸŒ';
            localStorage.setItem('lexi_v8_dark', state.dark);
        }

        function addToPlan(e, id) { e.stopPropagation(); state.mem[id] = { lv: 0, next: 0 }; save(); renderExplore(); updateDashboard(); }
        function saveNote(id, val) { state.notes[id] = val; localStorage.setItem('lexi_v8_notes', JSON.stringify(state.notes)); }
        function save() { localStorage.setItem('lexi_v8_mem', JSON.stringify(state.mem)); }
        function speakWord() { window.speechSynthesis.speak(new SpeechSynthesisUtterance(state.queue[state.idx].en)); }
        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateDashboard(); }
        function clearData() { if(confirm("é‡ç½®æ‰€æœ‰è¿›åº¦ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

        // åˆå§‹åŒ–
        if(state.dark) { document.body.classList.add('dark'); document.getElementById('mode-icon').innerText = 'ğŸŒ™'; }
        document.getElementById('goal-val').innerText = state.goal;
        autoAllocate();
        updateDashboard();
    </script>
</body>
</html>
