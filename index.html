<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LexiFlow Pro v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #F8FAFC; --text: #1E293B; --card-bg: #FFFFFF; --accent: #6366F1;
        }
        .dark {
            --bg: #0F172A; --text: #F1F5F9; --card-bg: #1E293B; --accent: #818CF8;
        }
        body { background-color: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.3s ease; }
        
        /* å¡ç‰‡ç¿»è½¬é€»è¾‘ */
        .flip-card { perspective: 1000px; width: 100%; height: 420px; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            border-radius: 2.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem;
            background: var(--card-bg); box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);
        }
        .flip-card-back { transform: rotateY(180deg); border: 2px solid var(--accent); }

        .nav-link.active { color: var(--accent); }
        .hide { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-24">

    <header class="max-w-md mx-auto px-6 pt-12 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-[800] tracking-tighter">LexiFlow</h1>
            <p id="subTitle" class="text-[10px] font-black opacity-30 uppercase tracking-[0.2em]">Personal Lexicon</p>
        </div>
        <button onclick="toggleSettings(true)" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow-sm">âš™ï¸</button>
    </header>

    <main id="view-home" class="max-w-md mx-auto px-6 mt-10">
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div onclick="openStudy('new')" class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] shadow-sm cursor-pointer active:scale-95 transition-all">
                <span class="text-[9px] font-black opacity-30 uppercase tracking-widest">éœ€å­¦ä¹  New</span>
                <p id="num-new" class="text-4xl font-black mt-2 text-indigo-500">0</p>
            </div>
            <div onclick="openStudy('review')" class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] shadow-sm cursor-pointer active:scale-95 transition-all">
                <span class="text-[9px] font-black opacity-30 uppercase tracking-widest">å¤ä¹  Review</span>
                <p id="num-review" class="text-4xl font-black mt-2 text-emerald-500">0</p>
            </div>
        </div>
        <div class="bg-indigo-600 p-8 rounded-[2.5rem] text-white shadow-xl shadow-indigo-200">
            <h3 class="font-black text-[10px] opacity-60 uppercase tracking-widest mb-2">Daily Goal</h3>
            <p class="text-lg font-bold">å®Œæˆä»Šæ—¥ä»»åŠ¡ï¼Œä¿æŒèŠ‚å¥ï¼</p>
            <div class="mt-4 bg-white/20 h-1.5 rounded-full overflow-hidden">
                <div id="goal-progress" class="bg-white h-full" style="width: 0%"></div>
            </div>
        </div>
    </main>

    <main id="view-explore" class="max-w-md mx-auto px-6 mt-8 hide">
        <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar">
            <button onclick="setFilter('all')" class="px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">å…¨éƒ¨</button>
            <button onclick="setFilter('legal')" class="px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">âš–ï¸ æ³•å¾‹</button>
            <button onclick="setFilter('gaming')" class="px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">ğŸ® æ¸¸æˆ</button>
            <button onclick="setFilter('food')" class="px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">ğŸ³ é£Ÿç‰©</button>
        </div>
        <div id="explore-list" class="space-y-4 pb-12"></div>
    </main>

    <section id="study-layer" class="fixed inset-0 bg-white dark:bg-slate-900 z-[200] hide flex flex-col p-8">
        <div class="flex justify-between items-center mb-6">
            <button onclick="closeStudy()" class="text-2xl opacity-30">âœ•</button>
            <div id="study-progress" class="text-[10px] font-black opacity-30 tracking-widest">1 / 10</div>
            <div class="w-6"></div>
        </div>
        <div class="flex-1 flex items-center justify-center">
            <div class="flip-card" id="mainCard">
                <div class="flip-card-inner">
                    <div class="flip-card-front" onclick="this.parentElement.parentElement.classList.toggle('flipped')">
                        <span id="card-cat" class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-4">CATEGORY</span>
                        <h2 id="card-en" class="text-4xl font-black text-center">Term</h2>
                        <p class="mt-12 text-[10px] opacity-20 uppercase font-black tracking-widest">ç‚¹å‡»æŸ¥çœ‹é‡Šä¹‰</p>
                    </div>
                    <div class="flip-card-back">
                        <h3 id="card-zh" class="text-2xl font-bold text-indigo-500 mb-4">ç¿»è¯‘</h3>
                        <p id="card-d" class="text-sm opacity-60 text-center leading-relaxed">è§£é‡Šå†…å®¹</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-3 mt-8" id="study-controls">
            <button onclick="handleLearn(1)" class="py-5 bg-slate-100 dark:bg-slate-800 rounded-3xl font-black text-[10px] uppercase">å¿˜äº†</button>
            <button onclick="handleLearn(2)" class="py-5 bg-indigo-50 dark:bg-slate-800 rounded-3xl font-black text-[10px] text-indigo-400 uppercase">æ¨¡ç³Š</button>
            <button onclick="handleLearn(3)" class="py-5 bg-indigo-600 rounded-3xl font-black text-[10px] text-white shadow-lg uppercase">è®¤è¯†</button>
        </div>
    </section>

    <section id="settings-panel" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-[300] hide">
        <div class="absolute bottom-0 w-full bg-white dark:bg-slate-900 rounded-t-[3rem] p-10">
            <div class="flex justify-between mb-8">
                <h2 class="text-xl font-black">è®¾ç½® Settings</h2>
                <button onclick="toggleSettings(false)">âœ•</button>
            </div>
            <div class="space-y-8">
                <div class="flex justify-between items-center">
                    <span class="font-bold">å¤–è§‚æ¨¡å¼</span>
                    <button onclick="toggleDarkMode()" id="mode-btn" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-xl text-xs font-bold">ğŸŒ ç™½å¤©æ¨¡å¼</button>
                </div>
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-bold">æ¯æ—¥å­¦ä¹ é‡</span>
                        <span id="goal-val" class="text-indigo-500 font-black">10</span>
                    </div>
                    <input type="range" min="5" max="50" step="5" value="10" oninput="updateGoal(this.value)" class="w-full h-1.5 bg-slate-100 rounded-full appearance-none accent-indigo-600">
                </div>
                <div class="pt-4 space-y-3">
                    <button onclick="clearData('progress')" class="w-full py-4 text-xs font-bold text-orange-500 border border-orange-100 rounded-2xl">ä»…æ¸…é™¤å­¦ä¹ è¿›åº¦</button>
                    <button onclick="clearData('all')" class="w-full py-4 text-xs font-bold text-red-500 bg-red-50 rounded-2xl">æ¸…é™¤å…¨éƒ¨æ•°æ®ï¼ˆå«ç¬”è®°ï¼‰</button>
                </div>
            </div>
        </div>
    </section>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-64 h-20 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md rounded-[2.5rem] shadow-xl flex items-center justify-around border border-white/20 z-[100]">
        <button onclick="switchTab('home')" id="btn-home" class="nav-link active">ğŸ“–</button>
        <button onclick="switchTab('explore')" id="btn-explore" class="nav-link text-slate-300">ğŸ”</button>
    </nav>

    <script>
        // è¯åº“ A-Z
        const RAW_LIB = [
            { id:'g1', cat:'gaming', en:'Aggro', zh:'ä»‡æ¨å€¼', d:'è¡¡é‡æ€ªç‰©å¯¹ä¸åŒç©å®¶æ”»å‡»æ¬²æœ›çš„æ•°å€¼ã€‚' },
            { id:'f1', cat:'food', en:'Al Dente', zh:'å¼¹ç‰™', d:'å½¢å®¹æ„é¢æˆ–ç±³é¥­ä¸­å¿ƒä¿ç•™ä¸€ä¸åš¼åŠ²ã€‚' },
            { id:'l1', cat:'legal', en:'Bona Fide', zh:'å–„æ„', d:'æ³•å¾‹æœ¯è¯­ï¼ŒæŒ‡ä¸»è§‚å‡ºäºçœŸè¯šã€æ— æ¬ºè¯ˆæ„å›¾ã€‚' },
            { id:'l3', cat:'legal', en:'Due Diligence', zh:'å°½èŒè°ƒæŸ¥', d:'å¯¹èµ„äº§åŠé£é™©çš„å…¨é¢è°ƒæŸ¥ã€‚' },
            { id:'g2', cat:'gaming', en:'Fog of War', zh:'æˆ˜äº‰è¿·é›¾', d:'é®è”½æœªæ¢ç´¢åŒºåŸŸçš„è§†è§‰æ•ˆæœã€‚' },
            { id:'l2', cat:'legal', en:'Force Majeure', zh:'ä¸å¯æŠ—åŠ›', d:'ä¸èƒ½é¢„è§ã€é¿å…ä¸”å…‹æœçš„å®¢è§‚æƒ…å†µã€‚' },
            { id:'f2', cat:'food', en:'Maillard Reaction', zh:'ç¾æ‹‰å¾·ååº”', d:'åŠ çƒ­æ—¶å‘ç”Ÿçš„è¤å˜ååº”ï¼Œé¦™æ°”ä¹‹æºã€‚' },
            { id:'g3', cat:'gaming', en:'Metagame', zh:'å…ƒæ¸¸æˆ', d:'å½“å‰æœ€é«˜æ•ˆçš„æˆ˜æœ¯ç»„åˆè¶‹åŠ¿ã€‚' },
            { id:'l4', cat:'legal', en:'Statute of Limitations', zh:'è¯‰è®¼æ—¶æ•ˆ', d:'æ³•å¾‹è§„å®šæƒåˆ©è¡Œä½¿çš„æ—¶é—´é™åˆ¶ã€‚' },
            { id:'f3', cat:'food', en:'Umami', zh:'é²œå‘³', d:'ç¬¬äº”ç§åŸºæœ¬å‘³é“ã€‚' }
        ].sort((a,b) => a.en.localeCompare(b.en));

        let state = {
            mem: JSON.parse(localStorage.getItem('lexi_v5_mem') || '{}'),
            notes: JSON.parse(localStorage.getItem('lexi_v5_notes') || '{}'),
            goal: localStorage.getItem('lexi_v5_goal') || 10,
            dark: localStorage.getItem('lexi_v5_dark') === 'true',
            filter: 'all', queue: [], idx: 0
        };

        // --- è®¾ç½®åŠŸèƒ½ ---
        function toggleSettings(show) { document.getElementById('settings-panel').classList.toggle('hide', !show); }
        
        function toggleDarkMode() {
            state.dark = !state.dark;
            document.body.classList.toggle('dark', state.dark);
            document.getElementById('mode-btn').innerText = state.dark ? 'ğŸŒ™ æ·±å¤œæ¨¡å¼' : 'ğŸŒ ç™½å¤©æ¨¡å¼';
            localStorage.setItem('lexi_v5_dark', state.dark);
        }

        function updateGoal(val) {
            state.goal = val;
            document.getElementById('goal-val').innerText = val;
            localStorage.setItem('lexi_v5_goal', val);
            updateHomeCounts();
        }

        function clearData(type) {
            if(!confirm("ç¡®å®šæ‰§è¡Œæ­¤æ“ä½œï¼Ÿæ•°æ®ä¸å¯æ¢å¤")) return;
            if(type === 'all') { localStorage.clear(); location.reload(); }
            else { state.mem = {}; save(); updateHomeCounts(); toggleSettings(false); }
        }

        // --- å­¦ä¹ åŠŸèƒ½ (Ebbinghaus) ---
        function openStudy(type) {
            const now = Date.now();
            if(type === 'new') {
                state.queue = RAW_LIB.filter(i => state.mem[i.id] && state.mem[i.id].lv === 0).slice(0, state.goal);
            } else {
                state.queue = RAW_LIB.filter(i => {
                    const m = state.mem[i.id];
                    return m && m.lv > 0 && now >= m.next;
                });
            }
            if(state.queue.length === 0) return alert("ä»»åŠ¡å·²å®Œæˆï¼");
            state.idx = 0;
            document.getElementById('study-layer').classList.remove('hide');
            showStudyCard();
        }

        function showStudyCard() {
            const item = state.queue[state.idx];
            document.getElementById('mainCard').classList.remove('flipped');
            document.getElementById('card-en').innerText = item.en;
            document.getElementById('card-zh').innerText = item.zh;
            document.getElementById('card-d').innerText = item.d;
            document.getElementById('card-cat').innerText = item.cat;
            document.getElementById('study-progress').innerText = `${state.idx + 1} / ${state.queue.length}`;
            document.getElementById('study-controls').style.pointerEvents = 'auto';
        }

        function handleLearn(score) {
            // è‡ªåŠ¨ç¿»è½¬æ˜¾ç¤ºåé¦ˆ
            document.getElementById('mainCard').classList.add('flipped');
            document.getElementById('study-controls').style.pointerEvents = 'none';

            const item = state.queue[state.idx];
            if(!state.mem[item.id]) state.mem[item.id] = { lv: 0, next: 0 };
            const m = state.mem[item.id];
            
            if(score === 3) m.lv += 1;
            else if(score === 1) m.lv = Math.max(1, m.lv - 1);

            const intervals = [0, 0.1, 1, 2, 4, 7, 15, 30, 60];
            m.next = Date.now() + (intervals[Math.min(m.lv, 8)] * 86400000);
            save();

            setTimeout(() => {
                state.idx++;
                if(state.idx < state.queue.length) showStudyCard();
                else closeStudy();
            }, 1200); // åœç•™1.2ç§’æŸ¥çœ‹é‡Šä¹‰
        }

        // --- æ¢ç´¢ & ç¬”è®° ---
        function renderExplore() {
            const container = document.getElementById('explore-list');
            const filtered = RAW_LIB.filter(i => state.filter === 'all' || i.cat === state.filter);
            
            container.innerHTML = filtered.map(i => `
                <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-6 shadow-sm border border-slate-50 dark:border-slate-700 transition-all">
                    <div class="flex justify-between items-start" onclick="toggleDetail('${i.id}')">
                        <div>
                            <span class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">${i.cat}</span>
                            <h4 class="text-lg font-black mt-1">${i.en}</h4>
                        </div>
                        ${state.mem[i.id]?.lv > 0 ? 'âœ…' : `<button onclick="addToPlan(event, '${i.id}')" class="text-[9px] font-black bg-indigo-50 dark:bg-slate-700 text-indigo-500 px-3 py-1.5 rounded-full">ADD</button>`}
                    </div>
                    <div id="detail-${i.id}" class="hide mt-4 pt-4 border-t border-slate-50 dark:border-slate-700">
                        <p class="text-sm font-bold text-indigo-500 mb-2">${i.zh}</p>
                        <p class="text-xs opacity-60 leading-relaxed mb-4">${i.d}</p>
                        <div class="bg-slate-50 dark:bg-slate-900 p-3 rounded-xl">
                            <textarea onchange="saveNote('${i.id}', this.value)" placeholder="æ·»åŠ ä¸ªäººç¬”è®°..." class="w-full bg-transparent text-xs focus:outline-none min-h-[60px]">${state.notes[i.id] || ''}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleDetail(id) { document.getElementById(`detail-${id}`).classList.toggle('hide'); }
        function saveNote(id, val) { state.notes[id] = val; localStorage.setItem('lexi_v5_notes', JSON.stringify(state.notes)); }

        // --- åŸºç¡€é€»è¾‘ ---
        function switchTab(tab) {
            document.getElementById('view-home').classList.toggle('hide', tab !== 'home');
            document.getElementById('view-explore').classList.toggle('hide', tab !== 'explore');
            document.getElementById('btn-home').classList.toggle('active', tab === 'home');
            document.getElementById('btn-explore').classList.toggle('active', tab === 'explore');
            if(tab === 'explore') renderExplore();
        }

        function addToPlan(e, id) {
            e.stopPropagation();
            state.mem[id] = { lv: 0, next: 0 };
            save(); renderExplore(); updateHomeCounts();
        }

        function updateHomeCounts() {
            const news = RAW_LIB.filter(i => state.mem[i.id] && state.mem[i.id].lv === 0).length;
            const reviews = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && Date.now() >= state.mem[i.id].next).length;
            document.getElementById('num-new').innerText = news;
            document.getElementById('num-review').innerText = reviews;
            document.getElementById('goal-progress').style.width = Math.min(100, ( (state.goal-news)/state.goal ) * 100) + '%';
        }

        function save() { localStorage.setItem('lexi_v5_mem', JSON.stringify(state.mem)); }
        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateHomeCounts(); }
        function setFilter(cat) { state.filter = cat; renderExplore(); }

        // åˆå§‹åŒ–
        if(state.dark) document.body.classList.add('dark');
        document.getElementById('goal-val').innerText = state.goal;
        updateHomeCounts();
    </script>
</body>
</html>
