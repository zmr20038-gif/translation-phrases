<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LexiFlow Ultimate v8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #F8FAFC; --text: #1E293B; --card: #FFFFFF; --accent: #6366F1; }
        .dark { --bg: #0F172A; --text: #F1F5F9; --card: #1E293B; --accent: #818CF8; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.3s; overflow-x: hidden; }

        /* ä¾§è¾¹æ ä¸å±‚çº§ */
        #settings-sidebar { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #settings-sidebar.open { transform: translateX(0); }

        /* å­¦ä¹ å¡ç‰‡ç¿»è½¬ */
        .card-container { perspective: 1000px; width: 100%; height: 480px; position: relative; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 2.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; background: var(--card); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); }
        .card-back { transform: rotateY(180deg); border: 2px solid var(--accent); overflow-y: auto; }

        /* éšè—æ»šåŠ¨æ¡ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hide { display: none !important; }
        .active-tab { color: var(--accent); transform: translateY(-2px); }

        /* ä¹¦æ¶æ ·å¼ */
        .book-cover { box-shadow: 2px 4px 12px rgba(0,0,0,0.15); transition: transform 0.2s; }
        .book-cover:active { transform: scale(0.95); }

        /* æ‰¹é‡é€‰æ‹©æ ·å¼ */
        .checkbox-wrapper input:checked + div { background-color: var(--accent); border-color: var(--accent); }
        .checkbox-wrapper input:checked + div svg { display: block; }
    </style>
</head>
<body class="pb-24">

    <header class="max-w-md mx-auto px-6 pt-10 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-[900] tracking-tighter italic">LexiFlow<span class="text-indigo-500">.</span></h1>
            <p id="current-book-label" class="text-[9px] font-black opacity-40 uppercase tracking-widest text-indigo-600">å½“å‰è¯ä¹¦ï¼šé»˜è®¤è¯åº“</p>
        </div>
        <button onclick="toggleSidebar(true)" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow-sm">âš™ï¸</button>
    </header>

    <main id="view-home" class="max-w-md mx-auto px-6 mt-8">
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div onclick="openStudy('new')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] shadow-sm active:scale-95 transition-all border-b-4 border-indigo-50 dark:border-slate-700">
                <span class="text-[9px] font-black opacity-30 uppercase tracking-widest">éœ€å­¦ä¹  New</span>
                <p id="num-new" class="text-4xl font-black mt-2 text-indigo-500">0</p>
            </div>
            <div onclick="openStudy('review')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] shadow-sm active:scale-95 transition-all border-b-4 border-emerald-50 dark:border-slate-700">
                <span class="text-[9px] font-black opacity-30 uppercase tracking-widest">å¾…å¤ä¹  Review</span>
                <p id="num-review" class="text-4xl font-black mt-2 text-emerald-500">0</p>
            </div>
        </div>

        <div onclick="switchTab('learned')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] shadow-sm active:scale-95 transition-all flex justify-between items-center border border-slate-50 dark:border-slate-700">
            <div>
                <span class="text-[9px] font-black opacity-30 uppercase tracking-widest">å·²å­¦ä¹  Learned</span>
                <p id="num-learned" class="text-2xl font-black mt-1 text-slate-700 dark:text-slate-300">0</p>
            </div>
            <div class="w-12 h-12 rounded-full bg-slate-50 dark:bg-slate-700 flex items-center justify-center text-xl">ğŸ“</div>
        </div>

        <div class="mt-8 px-4 opacity-50 text-center">
            <p class="text-xs font-serif italic">"Language is the road map of a culture."</p>
        </div>
    </main>

    <main id="view-books" class="max-w-md mx-auto px-6 mt-8 hide">
        <div class="flex items-center mb-8">
            <button onclick="switchTab('home')" class="mr-4 text-xl">â†</button>
            <h2 class="text-2xl font-black">æˆ‘çš„ä¹¦æ¶ Library</h2>
        </div>
        <div class="grid grid-cols-2 gap-6">
            <div onclick="selectBook('default')" class="flex flex-col items-center">
                <div class="book-cover w-full aspect-[3/4] bg-gradient-to-br from-indigo-500 to-purple-600 rounded-r-2xl rounded-l-md mb-3 flex items-center justify-center text-white font-black text-xl shadow-lg relative overflow-hidden">
                    <div class="absolute inset-0 bg-white/10 skew-x-12 -translate-x-10"></div>
                    <span class="relative z-10 text-center px-2">Lexi<br>Core</span>
                </div>
                <span class="text-xs font-bold opacity-70">é»˜è®¤æ ¸å¿ƒè¯åº“</span>
            </div>
            <div onclick="selectBook('gift2025')" class="flex flex-col items-center">
                <div class="book-cover w-full aspect-[3/4] bg-gradient-to-br from-emerald-400 to-teal-600 rounded-r-2xl rounded-l-md mb-3 flex items-center justify-center text-white font-black text-lg shadow-lg">
                    <span class="text-center px-2">æœ€åçš„<br>ç¤¼ç‰©<br>2025</span>
                </div>
                <span class="text-xs font-bold opacity-70">æœ€åçš„ç¤¼ç‰©2025ç‰ˆ</span>
            </div>
            <div class="flex flex-col items-center opacity-40">
                <div class="book-cover w-full aspect-[3/4] bg-slate-200 dark:bg-slate-700 rounded-r-2xl rounded-l-md mb-3 flex items-center justify-center text-3xl text-slate-400 border-2 border-dashed border-slate-300">
                    +
                </div>
                <span class="text-xs font-bold">å¯¼å…¥æ›´å¤šä¹¦ç±...</span>
            </div>
        </div>
    </main>

    <main id="view-learned" class="max-w-md mx-auto px-6 mt-8 hide h-screen flex flex-col">
        <div class="flex justify-between items-center mb-6 shrink-0">
            <h2 class="text-2xl font-black">å·²æŒæ¡å•è¯</h2>
            <button onclick="toggleEditMode()" id="btn-edit" class="text-xs font-bold bg-slate-100 dark:bg-slate-800 px-4 py-2 rounded-full">æ‰¹é‡ç®¡ç†</button>
        </div>
        
        <div id="learned-list" class="flex-1 overflow-y-auto space-y-3 pb-32">
            </div>

        <div id="batch-bar" class="fixed bottom-24 left-6 right-6 bg-white dark:bg-slate-800 shadow-2xl rounded-2xl p-4 flex justify-between items-center border border-slate-100 dark:border-slate-700 hide z-50">
            <span class="text-xs font-bold ml-2">å·²é€‰ <span id="selected-count" class="text-indigo-500">0</span> ä¸ª</span>
            <button onclick="moveToTrash()" class="bg-red-50 text-red-500 px-6 py-2 rounded-xl text-xs font-black flex items-center gap-2">
                <span>ğŸ—‘ï¸</span> ç§»å…¥ç†Ÿè¯æœ¬(ä¸å†å¤ä¹ )
            </button>
        </div>
    </main>

    <main id="view-explore" class="max-w-md mx-auto px-6 mt-8 hide">
        <div class="flex gap-2 mb-6 overflow-x-auto no-scrollbar pb-2">
            <button onclick="setFilter('all')" class="cat-btn px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm whitespace-nowrap active-tab">å…¨éƒ¨</button>
            <button onclick="setFilter('medical')" class="cat-btn px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">ğŸ’Š åŒ»å­¦</button>
            <button onclick="setFilter('chemistry')" class="cat-btn px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">ğŸ§ª åŒ–å­¦</button>
            <button onclick="setFilter('geo')" class="cat-btn px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">ğŸŒ åœ°ç†</button>
            <button onclick="setFilter('daily')" class="cat-btn px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">ğŸ  æ—¥ç”¨</button>
            <button onclick="setFilter('idiom')" class="cat-btn px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">ğŸ’¬ ä¿—è¯­</button>
            <button onclick="setFilter('politics')" class="cat-btn px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">ğŸ›ï¸ æ”¿æ²»</button>
            <button onclick="setFilter('religion')" class="cat-btn px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">ğŸ› å®—æ•™</button>
            <button onclick="setFilter('lit')" class="cat-btn px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">ğŸ“œ æ–‡å­¦</button>
        </div>
        <div id="explore-list" class="space-y-4 pb-24"></div>
    </main>

    <section id="study-layer" class="fixed inset-0 bg-white dark:bg-slate-900 z-[200] hide flex flex-col p-8">
        <div class="flex justify-between items-center mb-6">
            <button onclick="closeStudy()" class="text-2xl opacity-20">âœ•</button>
            <div id="study-progress" class="text-[10px] font-black opacity-30 tracking-widest">1 / 10</div>
            <button onclick="speakWord()" class="text-xl">ğŸ”Š</button>
        </div>
        <div class="flex-1 flex items-center justify-center">
            <div class="card-container" id="studyCard">
                <div class="flip-card-inner" onclick="this.parentElement.classList.toggle('flipped')">
                    <div class="card-face card-front">
                        <span id="card-cat" class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-4">CAT</span>
                        <h2 id="card-en" class="text-4xl font-black text-center tracking-tighter">Word</h2>
                        <p class="mt-12 text-[9px] opacity-20 font-black uppercase tracking-widest">ç‚¹å‡»æŸ¥çœ‹é‡Šä¹‰</p>
                    </div>
                    <div class="card-face card-back">
                        <h3 id="card-zh" class="text-2xl font-bold text-indigo-500 mb-2">ç¿»è¯‘</h3>
                        <p id="card-d" class="text-xs opacity-60 text-center mb-6 px-4">è¯¦ç»†è§£é‡Š</p>
                        <div class="w-full p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl text-left border border-slate-100 dark:border-slate-700">
                            <span class="text-[8px] font-black opacity-30 uppercase block mb-2 italic">ğŸ¬ AI Scenario</span>
                            <p id="scene-en" class="text-xs font-bold text-slate-700 dark:text-slate-200 mb-1 leading-relaxed">English sentence...</p>
                            <p id="scene-zh" class="text-[10px] text-slate-400 leading-relaxed">ä¸­æ–‡ç¿»è¯‘...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="study-controls" class="grid grid-cols-3 gap-3 mt-8">
            <button onclick="handleLearn(1)" class="py-5 bg-slate-100 dark:bg-slate-800 rounded-[2rem] font-black text-[10px] uppercase">å¿˜äº†</button>
            <button onclick="handleLearn(2)" class="py-5 bg-indigo-50 dark:bg-slate-800 rounded-[2rem] font-black text-[10px] text-indigo-400 uppercase">æ¨¡ç³Š</button>
            <button onclick="handleLearn(3)" class="py-5 bg-indigo-600 rounded-[2rem] font-black text-[10px] text-white shadow-lg uppercase">è®¤è¯†</button>
        </div>
    </section>

    <div id="settings-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-black/10 backdrop-blur-sm z-[300] hide"></div>
    <aside id="settings-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-900 z-[301] shadow-2xl p-8 flex flex-col">
        <h2 class="text-2xl font-black mb-10 tracking-tighter">Settings</h2>
        <div class="space-y-8 flex-1">
            <div onclick="switchTab('books'); toggleSidebar(false);" class="bg-indigo-50 dark:bg-slate-800 p-4 rounded-2xl flex items-center justify-between cursor-pointer border border-indigo-100 dark:border-slate-700">
                <div class="flex items-center gap-3">
                    <span class="text-xl">ğŸ“š</span>
                    <div>
                        <p class="text-xs font-black uppercase text-indigo-500">Current Book</p>
                        <p id="setting-book-name" class="text-sm font-bold">é»˜è®¤æ ¸å¿ƒè¯åº“</p>
                    </div>
                </div>
                <span class="text-indigo-400">â†’</span>
            </div>

            <div>
                <label class="text-[10px] font-black opacity-30 uppercase block mb-3">Interface</label>
                <button onclick="toggleDarkMode()" class="w-full p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl flex justify-between font-bold text-sm">
                    <span>å¤–è§‚æ¨¡å¼</span><span id="mode-icon">ğŸŒ</span>
                </button>
            </div>
            
            <div>
                <label class="text-[10px] font-black opacity-30 uppercase block mb-3">Daily Goal</label>
                <div class="flex justify-between font-black text-indigo-500 mb-2"><span id="goal-val">10</span><span>è¯/å¤©</span></div>
                <input type="range" min="5" max="50" step="5" value="10" oninput="updateGoal(this.value)" class="w-full h-1.5 bg-slate-100 rounded-full appearance-none accent-indigo-600">
            </div>
        </div>
        <div class="pt-6">
            <button onclick="clearData()" class="w-full py-4 text-red-500 text-[10px] font-black uppercase rounded-2xl border border-red-50">é‡ç½®æ‰€æœ‰æ•°æ®</button>
        </div>
    </aside>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-72 h-20 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl rounded-[2.5rem] shadow-2xl flex items-center justify-around z-[100] border border-white/20">
        <button onclick="switchTab('home')" id="btn-home" class="p-3 active-tab text-2xl">ğŸ </button>
        <button onclick="switchTab('explore')" id="btn-explore" class="p-3 opacity-30 text-2xl">ğŸ”</button>
    </nav>

    <script>
        // æ ¸å¿ƒè¯åº“ï¼šåŒ…å«æ–°åˆ†ç±»å’ŒåŒè¯­ä¾‹å¥
        // æ•°æ®ç»“æ„ï¼šid, cat, en, zh, d, scene: {en, zh}
        const RAW_LIB = [
            // --- é»˜è®¤åˆ†ç±» ---
            { id:'g1', cat:'gaming', en:'Aggro', zh:'ä»‡æ¨å€¼', d:'è¡¡é‡æ€ªç‰©æ”»å‡»æ¬²æœ›çš„æ•°å€¼ã€‚', scene: {en: "Don't pull aggro from the boss yet!", zh: "å…ˆåˆ«ä¹±æ‹‰ Boss çš„ä»‡æ¨å€¼ï¼"} },
            { id:'f1', cat:'food', en:'Al Dente', zh:'å¼¹ç‰™', d:'æ„é¢ä¸­å¿ƒä¿ç•™ä¸€ä¸åš¼åŠ²ã€‚', scene: {en: "The pasta should be cooked al dente.", zh: "æ„é¢åº”è¯¥ç…®åˆ°å¼¹ç‰™çš„ç¨‹åº¦ã€‚"} },
            
            // --- Medical åŒ»å­¦ ---
            { id:'m1', cat:'medical', en:'Placebo', zh:'å®‰æ…°å‰‚', d:'æ— æ•ˆä½†èƒ½äº§ç”Ÿå¿ƒç†å®‰æ…°çš„è¯å‰‚ã€‚', scene: {en: "The patient improved due to the placebo effect.", zh: "ç—…äººå› å®‰æ…°å‰‚æ•ˆåº”è€Œå¥½è½¬ã€‚"} },
            { id:'m2', cat:'medical', en:'Diagnosis', zh:'è¯Šæ–­', d:'å¯¹ç–¾ç—…æ€§è´¨çš„åˆ¤æ–­ã€‚', scene: {en: "The doctor gave a diagnosis of mild flu.", zh: "åŒ»ç”Ÿè¯Šæ–­ä¸ºè½»å¾®æµæ„Ÿã€‚"} },
            { id:'m3', cat:'medical', en:'Symptom', zh:'ç—‡çŠ¶', d:'ç–¾ç—…è¡¨ç°å‡ºçš„å¼‚å¸¸çŠ¶æ€ã€‚', scene: {en: "Fever is a common symptom of infection.", zh: "å‘çƒ§æ˜¯æ„ŸæŸ“çš„å¸¸è§ç—‡çŠ¶ã€‚"} },
            { id:'m4', cat:'medical', en:'Prescription', zh:'å¤„æ–¹', d:'åŒ»ç”Ÿå¼€å…·çš„è¯æ–¹ã€‚', scene: {en: "You need a prescription to buy this medicine.", zh: "ä½ éœ€è¦å¤„æ–¹æ‰èƒ½ä¹°è¿™ç§è¯ã€‚"} },
            { id:'m5', cat:'medical', en:'Anesthesia', zh:'éº»é†‰', d:'ä½¿èº«ä½“å¤±å»çŸ¥è§‰çš„æ‰‹æ®µã€‚', scene: {en: "The surgery was performed under local anesthesia.", zh: "æ‰‹æœ¯æ˜¯åœ¨å±€éƒ¨éº»é†‰ä¸‹è¿›è¡Œçš„ã€‚"} },

            // --- Chemistry åŒ–å­¦ ---
            { id:'c1', cat:'chemistry', en:'Catalyst', zh:'å‚¬åŒ–å‰‚', d:'åŠ é€ŸåŒ–å­¦ååº”çš„ç‰©è´¨ã€‚', scene: {en: "Enzymes act as catalysts in digestion.", zh: "é…¶åœ¨æ¶ˆåŒ–è¿‡ç¨‹ä¸­èµ·å‚¬åŒ–å‰‚ä½œç”¨ã€‚"} },
            { id:'c2', cat:'chemistry', en:'Molecule', zh:'åˆ†å­', d:'ä¿æŒç‰©è´¨åŒ–å­¦æ€§è´¨çš„æœ€å°ç²’å­ã€‚', scene: {en: "Water is composed of hydrogen and oxygen molecules.", zh: "æ°´ç”±æ°¢åˆ†å­å’Œæ°§åˆ†å­ç»„æˆã€‚"} },
            { id:'c3', cat:'chemistry', en:'Solvent', zh:'æº¶å‰‚', d:'èƒ½æº¶è§£å…¶ä»–ç‰©è´¨çš„æ¶²ä½“ã€‚', scene: {en: "Water is known as the universal solvent.", zh: "æ°´è¢«ç§°ä¸ºä¸‡èƒ½æº¶å‰‚ã€‚"} },
            { id:'c4', cat:'chemistry', en:'Isotope', zh:'åŒä½ç´ ', d:'è´¨å­æ•°ç›¸åŒä½†ä¸­å­æ•°ä¸åŒçš„åŸå­ã€‚', scene: {en: "Carbon-14 is a radioactive isotope.", zh: "ç¢³-14 æ˜¯ä¸€ç§æ”¾å°„æ€§åŒä½ç´ ã€‚"} },
            { id:'c5', cat:'chemistry', en:'Polymer', zh:'èšåˆç‰©', d:'ç”±é‡å¤å•å…ƒç»„æˆçš„å¤§åˆ†å­ã€‚', scene: {en: "Plastic is a type of synthetic polymer.", zh: "å¡‘æ–™æ˜¯ä¸€ç§åˆæˆèšåˆç‰©ã€‚"} },

            // --- Geography åœ°ç† ---
            { id:'geo1', cat:'geo', en:'Peninsula', zh:'åŠå²›', d:'ä¸‰é¢ç¯æ°´çš„é™†åœ°ã€‚', scene: {en: "Korea is a peninsula in East Asia.", zh: "æœé²œæ˜¯ä¸œäºšçš„ä¸€ä¸ªåŠå²›ã€‚"} },
            { id:'geo2', cat:'geo', en:'Latitude', zh:'çº¬åº¦', d:'åœ°çƒè¡¨é¢å—åŒ—å‘çš„åæ ‡ã€‚', scene: {en: "The city is located at a high latitude.", zh: "è¿™åº§åŸå¸‚ä½äºé«˜çº¬åº¦åœ°åŒºã€‚"} },
            { id:'geo3', cat:'geo', en:'Tributary', zh:'æ”¯æµ', d:'æµå…¥å¹²æµçš„æ²³æµã€‚', scene: {en: "The Ohio River is a tributary of the Mississippi.", zh: "ä¿„äº¥ä¿„æ²³æ˜¯å¯†è¥¿è¥¿æ¯”æ²³çš„æ”¯æµã€‚"} },
            { id:'geo4', cat:'geo', en:'Hemisphere', zh:'åŠçƒ', d:'åœ°çƒçš„ä¸€åŠã€‚', scene: {en: "Australia is in the Southern Hemisphere.", zh: "æ¾³å¤§åˆ©äºšä½äºå—åŠçƒã€‚"} },
            { id:'geo5', cat:'geo', en:'Archipelago', zh:'ç¾¤å²›', d:'æˆç¾¤çš„å²›å±¿ã€‚', scene: {en: "Indonesia is the world's largest archipelago.", zh: "å°åº¦å°¼è¥¿äºšæ˜¯ä¸–ç•Œä¸Šæœ€å¤§çš„ç¾¤å²›ã€‚"} },

            // --- Daily æ—¥ç”¨ ---
            { id:'d1', cat:'daily', en:'Groceries', zh:'æ‚è´§/é£Ÿå“', d:'è¶…å¸‚è´­ä¹°çš„æ—¥å¸¸é£Ÿå“ã€‚', scene: {en: "I need to pick up some groceries on my way home.", zh: "æˆ‘å›å®¶è·¯ä¸Šå¾—ä¹°ç‚¹æ‚è´§ã€‚"} },
            { id:'d2', cat:'daily', en:'Commute', zh:'é€šå‹¤', d:'ä¸Šä¸‹ç­å¾€è¿”çš„è¿‡ç¨‹ã€‚', scene: {en: "My daily commute takes about an hour.", zh: "æˆ‘æ¯å¤©é€šå‹¤å¤§çº¦éœ€è¦ä¸€å°æ—¶ã€‚"} },
            { id:'d3', cat:'daily', en:'Detergent', zh:'æ´—æ¶¤å‰‚', d:'ç”¨äºæ¸…æ´—è¡£ç‰©æˆ–é¤å…·çš„æ¶²ä½“ã€‚', scene: {en: "We ran out of laundry detergent.", zh: "æˆ‘ä»¬çš„æ´—è¡£æ¶²ç”¨å®Œäº†ã€‚"} },
            { id:'d4', cat:'daily', en:'Appliance', zh:'å®¶ç”¨ç”µå™¨', d:'å®¶åº­ä½¿ç”¨çš„ç”µåŠ›å™¨å…·ã€‚', scene: {en: "The kitchen is equipped with modern appliances.", zh: "å¨æˆ¿é…å¤‡äº†ç°ä»£åŒ–å®¶ç”µã€‚"} },
            { id:'d5', cat:'daily', en:'Utensil', zh:'å™¨çš¿/é¤å…·', d:'å¨æˆ¿ç”¨çš„å·¥å…·ã€‚', scene: {en: "Please wash the cooking utensils after use.", zh: "ç”¨å®Œçƒ¹é¥ªå™¨å…·åè¯·æ¸…æ´—ã€‚"} },

            // --- Idiom ä¿—è¯­ ---
            { id:'i1', cat:'idiom', en:'Break a leg', zh:'ç¥ä½ å¥½è¿', d:'ç”¨äºæ¼”å‡ºå‰ç¥æ„¿æˆåŠŸã€‚', scene: {en: "Break a leg on your performance tonight!", zh: "ç¥ä½ ä»Šæ™šæ¼”å‡ºæˆåŠŸï¼"} },
            { id:'i2', cat:'idiom', en:'Piece of cake', zh:'å°èœä¸€ç¢Ÿ', d:'å½¢å®¹äº‹æƒ…éå¸¸å®¹æ˜“ã€‚', scene: {en: "The exam was a piece of cake.", zh: "è¿™æ¬¡è€ƒè¯•ç®€ç›´æ˜¯å°èœä¸€ç¢Ÿã€‚"} },
            { id:'i3', cat:'idiom', en:'Cold turkey', zh:'çªç„¶æˆ’æ–­', d:'çªç„¶å®Œå…¨åœæ­¢æŸç§ä¹ æƒ¯ã€‚', scene: {en: "He quit smoking cold turkey.", zh: "ä»–çªç„¶å½»åº•æˆ’çƒŸäº†ã€‚"} },
            { id:'i4', cat:'idiom', en:'Bite the bullet', zh:'å’¬ç´§ç‰™å…³', d:'å¼ºå¿ç—›è‹¦å»åšå›°éš¾çš„äº‹ã€‚', scene: {en: "I have to bite the bullet and apologize.", zh: "æˆ‘å¿…é¡»ç¡¬ç€å¤´çš®å»é“æ­‰ã€‚"} },
            { id:'i5', cat:'idiom', en:'Cost an arm and a leg', zh:'æå…¶æ˜‚è´µ', d:'èŠ±è´¹å·¨å¤§çš„ä»£ä»·ã€‚', scene: {en: "This car costs an arm and a leg.", zh: "è¿™è¾†è½¦è´µå¾—ç¦»è°±ã€‚"} },

            // --- Politics æ”¿æ²» ---
            { id:'p1', cat:'politics', en:'Ballot', zh:'é€‰ç¥¨', d:'æŠ•ç¥¨ç”¨çš„çº¸å¼ æˆ–ç¥¨æ®ã€‚', scene: {en: "They are counting the ballots now.", zh: "ä»–ä»¬æ­£åœ¨è®¡ç¥¨ã€‚"} },
            { id:'p2', cat:'politics', en:'Legislation', zh:'ç«‹æ³•', d:'åˆ¶å®šæ³•å¾‹çš„è¿‡ç¨‹æˆ–æ³•å¾‹æœ¬èº«ã€‚', scene: {en: "New legislation was passed to protect the environment.", zh: "é€šè¿‡äº†ä¿æŠ¤ç¯å¢ƒçš„æ–°ç«‹æ³•ã€‚"} },
            { id:'p3', cat:'politics', en:'Diplomacy', zh:'å¤–äº¤', d:'å›½å®¶é—´å¤„ç†å…³ç³»çš„è‰ºæœ¯ã€‚', scene: {en: "Diplomacy is key to avoiding war.", zh: "å¤–äº¤æ˜¯é¿å…æˆ˜äº‰çš„å…³é”®ã€‚"} },
            { id:'p4', cat:'politics', en:'Constituency', zh:'é€‰åŒº', d:'é€‰æ°‘æ‰€åœ¨çš„åŒºåŸŸã€‚', scene: {en: "He represents a large rural constituency.", zh: "ä»–ä»£è¡¨ä¸€ä¸ªåºå¤§çš„å†œæ‘é€‰åŒºã€‚"} },
            { id:'p5', cat:'politics', en:'Referendum', zh:'å…¨æ°‘å…¬æŠ•', d:'å…¨ä½“å…¬æ°‘å¯¹è®®é¢˜è¿›è¡Œç›´æ¥æŠ•ç¥¨ã€‚', scene: {en: "The country held a referendum on independence.", zh: "è¯¥å›½ä¸¾è¡Œäº†ç‹¬ç«‹å…¬æŠ•ã€‚"} },

            // --- Religion å®—æ•™ ---
            { id:'r1', cat:'religion', en:'Pilgrimage', zh:'æœåœ£', d:'å‰å¾€åœ£åœ°çš„å®—æ•™æ—…ç¨‹ã€‚', scene: {en: "Thousands go on a pilgrimage to Mecca every year.", zh: "æ¯å¹´æœ‰æˆåƒä¸Šä¸‡çš„äººå»éº¦åŠ æœåœ£ã€‚"} },
            { id:'r2', cat:'religion', en:'Scripture', zh:'ç»æ–‡', d:'å®—æ•™çš„ç¥åœ£å…¸ç±ã€‚', scene: {en: "He quoted a passage from the scripture.", zh: "ä»–å¼•ç”¨äº†ä¸€æ®µç»æ–‡ã€‚"} },
            { id:'r3', cat:'religion', en:'Deity', zh:'ç¥', d:'ç¥æ˜æˆ–å¥³ç¥ã€‚', scene: {en: "Zeus was a major deity in Greek mythology.", zh: "å®™æ–¯æ˜¯å¸Œè…Šç¥è¯ä¸­çš„ä¸»ç¥ã€‚"} },
            { id:'r4', cat:'religion', en:'Congregation', zh:'ä¼šä¼—', d:'èšé›†åœ¨ä¸€èµ·ç¤¼æ‹œçš„äººç¾¤ã€‚', scene: {en: "The priest addressed the congregation.", zh: "ç‰§å¸ˆå‘ä¼šä¼—è‡´è¾ã€‚"} },
            { id:'r5', cat:'religion', en:'Sacrament', zh:'åœ£ç¤¼', d:'å…·æœ‰ç¥åœ£æ„ä¹‰çš„å®—æ•™ä»ªå¼ã€‚', scene: {en: "Baptism is a Christian sacrament.", zh: "æ´—ç¤¼æ˜¯åŸºç£æ•™çš„ä¸€ç§åœ£ç¤¼ã€‚"} },

            // --- Literature æ–‡å­¦ ---
            { id:'lit1', cat:'lit', en:'Metaphor', zh:'éšå–»', d:'ä¸€ç§ä¿®è¾æ‰‹æ³•ï¼Œç”¨ä¸€äº‹ç‰©æš—å–»å¦ä¸€äº‹ç‰©ã€‚', scene: {en: "Time is a thief' is a metaphor.", zh: "â€œæ—¶é—´æ˜¯å°å·â€æ˜¯ä¸€ä¸ªéšå–»ã€‚"} },
            { id:'lit2', cat:'lit', en:'Protagonist', zh:'ä¸»è§’', d:'æ•…äº‹ä¸­çš„ä¸»è¦äººç‰©ã€‚', scene: {en: "Harry Potter is the protagonist of the series.", zh: "å“ˆåˆ©Â·æ³¢ç‰¹æ˜¯è¯¥ç³»åˆ—çš„ä¸»è§’ã€‚"} },
            { id:'lit3', cat:'lit', en:'Prologue', zh:'åºå¹•', d:'æ–‡å­¦ä½œå“çš„å¼€åœºéƒ¨åˆ†ã€‚', scene: {en: "The prologue sets the scene for the story.", zh: "åºå¹•ä¸ºæ•…äº‹è®¾å®šäº†èƒŒæ™¯ã€‚"} },
            { id:'lit4', cat:'lit', en:'Anthology', zh:'é€‰é›†', d:'è¯—æ­Œæˆ–çŸ­ç¯‡å°è¯´çš„é›†åˆã€‚', scene: {en: "I bought an anthology of American poetry.", zh: "æˆ‘ä¹°äº†ä¸€æœ¬ç¾å›½è¯—æ­Œé€‰é›†ã€‚"} },
            { id:'lit5', cat:'lit', en:'Soliloquy', zh:'ç‹¬ç™½', d:'å‰§ä¸­äººç‰©è‡ªè¨€è‡ªè¯­çš„æ®µè½ã€‚', scene: {en: "Hamlet's famous soliloquy begins with 'To be or not to be'.", zh: "å“ˆå§†é›·ç‰¹çš„è‘—åç‹¬ç™½ä»¥â€œç”Ÿå­˜è¿˜æ˜¯æ¯ç­â€å¼€å§‹ã€‚"} }
        ].sort((a,b) => a.en.localeCompare(b.en));

        let state = {
            mem: JSON.parse(localStorage.getItem('lexi_v9_mem') || '{}'), // memç»“æ„: {id: {lv: 0-99, next: timestamp}}
            notes: JSON.parse(localStorage.getItem('lexi_v9_notes') || '{}'),
            goal: parseInt(localStorage.getItem('lexi_v9_goal') || '10'),
            dark: localStorage.getItem('lexi_v9_dark') === 'true',
            book: localStorage.getItem('lexi_v9_book') || 'default',
            filter: 'all', queue: [], idx: 0, 
            editMode: false, selectedItems: new Set()
        };

        // --- åˆå§‹åŒ– ---
        function init() {
            if(state.dark) document.body.classList.add('dark');
            document.getElementById('goal-val').innerText = state.goal;
            updateBookLabel();
            autoAllocate();
            updateDashboard();
        }

        // --- è¯ä¹¦é€‰æ‹© ---
        function selectBook(bookId) {
            state.book = bookId;
            localStorage.setItem('lexi_v9_book', bookId);
            updateBookLabel();
            switchTab('home');
            // è¿™é‡Œä»…ä»…æ˜¯é€»è¾‘åˆ‡æ¢ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥æ ¹æ® bookId åŠ è½½ä¸åŒæ•°æ®æº
            alert(`å·²åˆ‡æ¢è‡³ï¼š${bookId === 'default' ? 'é»˜è®¤æ ¸å¿ƒè¯åº“' : 'æœ€åçš„ç¤¼ç‰©2025ç‰ˆ'}`);
        }

        function updateBookLabel() {
            const name = state.book === 'default' ? 'é»˜è®¤æ ¸å¿ƒè¯åº“' : 'æœ€åçš„ç¤¼ç‰©2025ç‰ˆ';
            document.getElementById('current-book-label').innerText = `å½“å‰è¯ä¹¦ï¼š${name}`;
            document.getElementById('setting-book-name').innerText = name;
        }

        // --- å­¦ä¹ ä¸å¤ä¹ é€»è¾‘ ---
        function autoAllocate() {
            // è·å–å½“å‰æ´»è·ƒå­¦ä¹ ï¼ˆlv=0ï¼‰çš„æ•°é‡
            let active = Object.keys(state.mem).filter(id => state.mem[id].lv === 0).length;
            if(active < state.goal) {
                // æ’é™¤å·²å­¦(lv>0)å’Œå·²ç†Ÿè¯(lv=99)
                let pool = RAW_LIB.filter(i => !state.mem[i.id]);
                pool.sort(() => Math.random() - 0.5);
                for(let i=0; i < Math.min(state.goal - active, pool.length); i++) {
                    state.mem[pool[i].id] = { lv: 0, next: 0 };
                }
                save();
            }
        }

        function openStudy(type) {
            const now = Date.now();
            if(type === 'new') {
                state.queue = RAW_LIB.filter(i => state.mem[i.id] && state.mem[i.id].lv === 0);
            } else {
                state.queue = RAW_LIB.filter(i => {
                    const m = state.mem[i.id];
                    // æ’é™¤ lv=99 (ç†Ÿè¯)
                    return m && m.lv > 0 && m.lv < 99 && now >= m.next;
                });
            }
            if(!state.queue.length) return alert("å½“å‰é˜Ÿåˆ—ä¸ºç©ºï¼");
            state.idx = 0;
            document.getElementById('study-layer').classList.remove('hide');
            showCard();
        }

        function showCard() {
            const item = state.queue[state.idx];
            document.getElementById('studyCard').classList.remove('flipped');
            document.getElementById('card-en').innerText = item.en;
            document.getElementById('card-zh').innerText = item.zh;
            document.getElementById('card-d').innerText = item.d;
            document.getElementById('card-cat').innerText = item.cat;
            
            // åŒè¯­ä¾‹å¥
            document.getElementById('scene-en').innerText = item.scene.en;
            document.getElementById('scene-zh').innerText = item.scene.zh;

            document.getElementById('study-progress').innerText = `${state.idx+1} / ${state.queue.length}`;
            document.getElementById('study-controls').style.pointerEvents = 'auto';
        }

        function handleLearn(score) {
            document.getElementById('studyCard').classList.add('flipped');
            document.getElementById('study-controls').style.pointerEvents = 'none';
            const item = state.queue[state.idx];
            const m = state.mem[item.id];
            
            if(score === 3) m.lv += 1; // è®¤è¯† -> å‡çº§
            else if(score === 1) m.lv = Math.max(1, m.lv - 1); // å¿˜äº† -> é™çº§

            // ç®€å•é—´éš”ç®—æ³•
            const intervals = [0, 0.1, 1, 2, 4, 7, 15, 30, 60]; 
            m.next = Date.now() + (intervals[Math.min(m.lv, 8)] * 86400000);
            save();

            setTimeout(() => {
                state.idx++;
                if(state.idx < state.queue.length) showCard(); else closeStudy();
            }, 1200);
        }

        // --- ç†Ÿè¯/å·²å­¦ä¹ ç®¡ç† ---
        function renderLearned() {
            const container = document.getElementById('learned-list');
            // æ˜¾ç¤ºæ‰€æœ‰ lv > 0 ä¸” lv < 99 çš„è¯æ¡
            const learnedItems = RAW_LIB.filter(i => state.mem[i.id] && state.mem[i.id].lv > 0 && state.mem[i.id].lv < 99);
            
            if(learnedItems.length === 0) {
                container.innerHTML = '<div class="text-center opacity-30 mt-20">æš‚æ— å­¦ä¹ è®°å½•</div>';
                return;
            }

            container.innerHTML = learnedItems.map(i => `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl flex items-center justify-between border border-slate-50 dark:border-slate-700">
                    <div class="flex items-center gap-4">
                        <label class="checkbox-wrapper cursor-pointer ${state.editMode ? '' : 'hide'}">
                            <input type="checkbox" class="hidden" onchange="toggleSelect('${i.id}')" ${state.selectedItems.has(i.id) ? 'checked' : ''}>
                            <div class="w-5 h-5 rounded-full border-2 border-slate-300 flex items-center justify-center transition-colors">
                                <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                        </label>
                        <div>
                            <h4 class="text-lg font-black">${i.en}</h4>
                            <p class="text-xs opacity-50">${i.zh}</p>
                        </div>
                    </div>
                    <span class="text-[9px] font-black opacity-20 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">Lv.${state.mem[i.id].lv}</span>
                </div>
            `).join('');
            document.getElementById('num-learned').innerText = learnedItems.length;
        }

        function toggleEditMode() {
            state.editMode = !state.editMode;
            document.getElementById('btn-edit').innerText = state.editMode ? 'å–æ¶ˆ' : 'æ‰¹é‡ç®¡ç†';
            document.getElementById('batch-bar').classList.toggle('hide', !state.editMode);
            state.selectedItems.clear();
            renderLearned();
            updateBatchBar();
        }

        function toggleSelect(id) {
            if(state.selectedItems.has(id)) state.selectedItems.delete(id);
            else state.selectedItems.add(id);
            updateBatchBar();
        }

        function updateBatchBar() {
            document.getElementById('selected-count').innerText = state.selectedItems.size;
        }

        function moveToTrash() {
            if(!confirm(`ç¡®å®šå°†è¿™ ${state.selectedItems.size} ä¸ªå•è¯ç§»å…¥ç†Ÿè¯æœ¬ï¼Ÿå®ƒä»¬å°†ä¸å†å‡ºç°ã€‚`)) return;
            state.selectedItems.forEach(id => {
                if(state.mem[id]) state.mem[id].lv = 99; // 99ä»£è¡¨ç†Ÿè¯/åƒåœ¾ç®±
            });
            save();
            toggleEditMode();
            renderLearned();
            updateDashboard();
        }

        // --- æ¢ç´¢é¡µ Filter ---
        function setFilter(cat) { 
            state.filter = cat; 
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active-tab'));
            event.target.classList.add('active-tab');
            renderExplore(); 
        }

        function renderExplore() {
            const container = document.getElementById('explore-list');
            const filtered = RAW_LIB.filter(i => state.filter === 'all' || i.cat === state.filter);
            container.innerHTML = filtered.map(i => `
                <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-6 shadow-sm mb-4">
                    <div class="flex justify-between items-start" onclick="toggleDetail('${i.id}')">
                        <div>
                            <span class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">${i.cat}</span>
                            <h4 class="text-lg font-black mt-1">${i.en}</h4>
                        </div>
                        <button onclick="addToPlan(event, '${i.id}')" class="text-[10px] font-black px-4 py-2 rounded-full ${state.mem[i.id] ? 'bg-emerald-500 text-white':'bg-indigo-50 text-indigo-500'}">
                            ${state.mem[i.id] ? 'âœ“' : '+ ADD'}
                        </button>
                    </div>
                    <div id="detail-${i.id}" class="hide mt-4 pt-4 border-t border-slate-50 dark:border-slate-700">
                        <p class="text-sm font-bold text-indigo-500 mb-2">${i.zh}</p>
                        <p class="text-[11px] opacity-60 leading-relaxed mb-4">${i.d}</p>
                        <div class="bg-slate-50 dark:bg-slate-900 p-3 rounded-xl border border-slate-100 dark:border-slate-800">
                            <p class="text-[10px] text-slate-400 mb-1">ä¾‹å¥ï¼š</p>
                            <p class="text-xs font-bold text-slate-600 dark:text-slate-300 mb-1">${i.scene.en}</p>
                            <p class="text-[10px] text-slate-400">${i.scene.zh}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleDetail(id) { document.getElementById(`detail-${id}`).classList.toggle('hide'); }

        // --- åŸºç¡€è¾…åŠ© ---
        function switchTab(tab) {
            ['home', 'explore', 'books', 'learned'].forEach(t => {
                const el = document.getElementById('view-'+t);
                if(el) el.classList.toggle('hide', t !== tab);
                const btn = document.getElementById('btn-'+t);
                if(btn) {
                    btn.classList.toggle('active-tab', t === tab);
                    btn.classList.toggle('opacity-30', t !== tab);
                }
            });
            if(tab === 'explore') renderExplore();
            if(tab === 'learned') renderLearned();
        }

        function updateGoal(val) {
            state.goal = parseInt(val);
            document.getElementById('goal-val').innerText = val;
            localStorage.setItem('lexi_v9_goal', val);
            autoAllocate();
            updateDashboard();
        }

        function updateDashboard() {
            const now = Date.now();
            const news = RAW_LIB.filter(i => state.mem[i.id]?.lv === 0).length;
            // æ’é™¤ lv=99
            const reviews = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && state.mem[i.id]?.lv < 99 && now >= state.mem[i.id].next).length;
            const learned = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && state.mem[i.id]?.lv < 99).length;
            
            document.getElementById('num-new').innerText = news;
            document.getElementById('num-review').innerText = reviews;
            document.getElementById('num-learned').innerText = learned;
        }

        function addToPlan(e, id) { e.stopPropagation(); state.mem[id] = { lv: 0, next: 0 }; save(); renderExplore(); updateDashboard(); }
        function save() { localStorage.setItem('lexi_v9_mem', JSON.stringify(state.mem)); }
        function speakWord() { window.speechSynthesis.speak(new SpeechSynthesisUtterance(state.queue[state.idx].en)); }
        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateDashboard(); }
        function toggleSidebar(show) { document.getElementById('settings-sidebar').classList.toggle('open', show); document.getElementById('settings-overlay').classList.toggle('hide', !show); }
        function toggleDarkMode() { state.dark = !state.dark; document.body.classList.toggle('dark', state.dark); localStorage.setItem('lexi_v9_dark', state.dark); }
        function clearData() { if(confirm("é‡ç½®ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

        init();
    </script>
</body>
</html>
