<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LexiFlow MTI v6.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #4F46E5; --danger: #EF4444; --bg: #F8FAFC; }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; padding-top: env(safe-area-inset-top, 20px); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
        .serif { font-family: 'Noto Serif SC', serif; }
        .hide { display: none !important; }
        
        /* æè‡´å¹³æ»‘çš„æ»‘åŠ¨åˆ é™¤ */
        .swipe-container { position: relative; overflow: hidden; border-radius: 1.25rem; margin-bottom: 0.75rem; touch-action: pan-y; }
        .swipe-content { position: relative; z-index: 2; background: white; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .swipe-action { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; background: var(--danger); color: white; display: flex; align-items: center; justify-content: center; z-index: 1; font-weight: 800; font-size: 11px; }
        .swiped .swipe-content { transform: translateX(-80px); }

        /* MTI ä¸“ç”¨å¤§å¡ç‰‡ */
        .card-container { perspective: 1500px; width: 90%; max-width: 420px; height: 480px; margin: auto; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 2.5rem; background: white; padding: 2.5rem; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.03); word-break: break-word; }
        .card-back { transform: rotateY(180deg); border: 2px solid var(--accent); }

        .nav-glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.05); }
        .active-tag { background: var(--accent) !important; color: white !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="select-none">

    <section id="auth-screen" class="fixed inset-0 bg-white z-[1000] flex flex-col items-center justify-center p-8">
        <h1 class="text-5xl font-black italic tracking-tighter mb-10">Lexi<span class="text-indigo-600">MTI</span></h1>
        <div class="w-full max-w-sm space-y-3">
            <input id="auth-phone" type="tel" placeholder="è¾“å…¥æ‰‹æœºå·å¼€å§‹" class="w-full bg-slate-50 p-5 rounded-2xl outline-none border border-slate-100 font-bold text-center">
            <button onclick="handleLogin()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black shadow-xl active:scale-95 transition-all">è¿›å…¥å·¥ä½œåŒº</button>
        </div>
    </section>

    <div id="app-content" class="hide flex-1 flex flex-col max-w-2xl mx-auto w-full relative">
        <header class="p-6 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 bg-indigo-600 rounded-full animate-pulse"></div>
                <h2 class="text-xl font-black italic tracking-tight">LexiFlow Workspace</h2>
            </div>
            <button onclick="toggleSidebar(true)" class="text-xl">âš™ï¸</button>
        </header>

        <main class="flex-1 px-6 overflow-y-auto no-scrollbar pb-32">
            <div id="view-home" class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div onclick="prepStudy('new')" class="bg-white p-8 rounded-[2.5rem] shadow-sm active:scale-95 transition-all border-b-4 border-indigo-50">
                        <p class="text-[9px] font-black opacity-30 uppercase">å¾…å­¦</p>
                        <p id="num-new" class="text-4xl font-black text-indigo-600">0</p>
                    </div>
                    <div onclick="prepStudy('review')" class="bg-white p-8 rounded-[2.5rem] shadow-sm active:scale-95 transition-all border-b-4 border-emerald-50">
                        <p class="text-[9px] font-black opacity-30 uppercase">å¤ä¹ </p>
                        <p id="num-rev" class="text-4xl font-black text-emerald-500">0</p>
                    </div>
                </div>
                <div class="bg-indigo-600 rounded-[2.5rem] p-8 text-white relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-[9px] font-black opacity-60 uppercase mb-2">å½“å‰è®¡åˆ’</p>
                        <h3 id="plan-text" class="text-lg font-bold">---</h3>
                    </div>
                    <div class="absolute -right-5 -bottom-5 text-8xl opacity-10 font-black italic">MTI</div>
                </div>
            </div>

            <div id="view-explore" class="hide space-y-4">
                <input type="text" id="search-box" oninput="runSearch()" placeholder="å…¨åº“ç´¢å¼•: æ”¿æ²»ã€ç»æµã€æ³•å¾‹..." class="w-full p-5 rounded-2xl bg-white shadow-sm outline-none font-bold text-sm">
                <div id="cat-tags-container" class="flex gap-2 overflow-x-auto no-scrollbar py-2"></div>
                <div id="search-list" class="space-y-1"></div>
            </div>

            <div id="view-books" class="hide">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-black italic">Collections</h3>
                    <button onclick="createNewBook()" class="text-[10px] bg-slate-900 text-white px-5 py-2 rounded-xl font-black">+ æ–°è¯ä¹¦</button>
                </div>
                <div id="book-grid" class="grid grid-cols-2 gap-4"></div>
            </div>

            <div id="view-book-detail" class="hide">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="switchTab('books')" class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm">â†</button>
                    <h3 id="book-title-h" class="text-xl font-black serif">---</h3>
                </div>
                <div id="book-item-list" class="space-y-1"></div>
            </div>

            <div id="view-import" class="hide">
                <div class="bg-white rounded-[2.5rem] p-8 space-y-5 shadow-sm">
                    <h3 class="text-lg font-black italic border-b pb-4">æ–°è¯å½•å…¥</h3>
                    <select id="import-book-sel" class="w-full bg-slate-50 p-4 rounded-xl text-xs font-black outline-none border-none"></select>
                    <div class="flex gap-2">
                        <select id="cat-history" onchange="document.getElementById('in-cat').value=this.value" class="bg-slate-100 p-4 rounded-xl text-[10px] outline-none border-none max-w-[100px]"><option value="">åˆ†ç±»</option></select>
                        <input id="in-cat" type="text" placeholder="è¾“å…¥æ–°åˆ†ç±»" class="flex-1 bg-slate-50 p-4 rounded-xl text-xs outline-none">
                    </div>
                    <input id="in-en" type="text" placeholder="è‹±æ–‡æœ¯è¯­" class="w-full p-4 rounded-xl bg-slate-50 outline-none font-bold text-sm">
                    <input id="in-zh" type="text" placeholder="æ ¸å¿ƒç¿»è¯‘" class="w-full p-4 rounded-xl bg-slate-50 outline-none font-bold text-sm serif">
                    <textarea id="in-ai" placeholder="AI ä¾‹å¥æˆ–èƒŒæ™¯çŸ¥è¯†..." class="w-full p-4 rounded-xl bg-slate-50 outline-none text-xs h-24 resize-none serif"></textarea>
                    <button onclick="doImport()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black active:scale-95 transition-all shadow-lg">ç¡®è®¤ä¿å­˜</button>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 nav-glass p-6 pb-10 flex justify-around items-center z-[100]">
            <button onclick="switchTab('home')" id="nav-home" class="text-2xl">ğŸ </button>
            <button onclick="switchTab('explore')" id="nav-explore" class="text-2xl opacity-20">ğŸ”</button>
            <button onclick="switchTab('books')" id="nav-books" class="text-2xl opacity-20">ğŸ“š</button>
            <button onclick="switchTab('import')" id="nav-import" class="text-2xl opacity-20">ğŸ“¥</button>
        </nav>
    </div>

    <section id="study-layer" class="fixed inset-0 bg-slate-50 z-[200] hide flex flex-col">
        <header class="p-8 flex justify-between items-center">
            <button onclick="closeStudy()" class="text-[10px] font-black opacity-30">EXIT</button>
            <span id="study-p" class="text-[10px] font-black opacity-20">0/0</span>
            <button onclick="playTTS()" class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm">ğŸ”Š</button>
        </header>
        <div class="flex-1 flex items-center justify-center p-6">
            <div class="card-container" id="studyCard">
                <div class="flip-card-inner" onclick="this.parentElement.classList.toggle('flipped')">
                    <div class="card-face flex items-center justify-center">
                        <h2 id="card-en" class="text-3xl font-black text-center italic tracking-tighter">Term</h2>
                    </div>
                    <div class="card-face card-back no-scrollbar overflow-y-auto">
                        <div class="space-y-6 text-center">
                            <h3 id="card-zh" class="text-2xl font-black text-indigo-600 serif">è§£é‡Š</h3>
                            <p id="card-ai" class="text-xs opacity-60 serif px-4 italic leading-relaxed"></p>
                            <textarea id="card-note" onchange="syncNote()" class="w-full bg-slate-50 p-4 rounded-2xl text-[10px] outline-none serif min-h-[120px]" placeholder="åœ¨è¿™é‡Œè®°å½•ç¿»è¯‘å¿ƒå¾—..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="p-8 pb-12 bg-white rounded-t-[3rem] shadow-2xl flex gap-3 max-w-2xl mx-auto w-full">
            <button onclick="finishSRS(1)" class="flex-1 py-5 bg-slate-100 rounded-2xl font-black text-[10px] opacity-40 uppercase">ä¸è®¤è¯†</button>
            <button onclick="finishSRS(2)" class="flex-1 py-5 bg-indigo-50 rounded-2xl font-black text-[10px] text-indigo-600 uppercase">æ¨¡ç³Š</button>
            <button onclick="finishSRS(3)" class="flex-1 py-5 bg-indigo-600 text-white rounded-2xl font-black text-[10px] uppercase">è®¤è¯†</button>
        </footer>
    </section>

    <div id="side-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-[300] hide"></div>
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white z-[301] p-10 translate-x-full transition-transform duration-500 flex flex-col">
        <h3 class="text-xl font-black italic border-b pb-6 mb-8">Settings</h3>
        <div class="flex-1 space-y-10 overflow-y-auto no-scrollbar">
            <div>
                <p class="text-[10px] font-black opacity-30 mb-4 uppercase">æ–°è¯é™é¢: <span id="limit-val">20</span></p>
                <input type="range" id="daily-limit" min="5" max="50" step="5" class="w-full accent-indigo-600">
            </div>
            <div>
                <p class="text-[10px] font-black opacity-30 mb-4 uppercase">è¯ä¹¦é€‰æ‹© (æœ€å¤š2æœ¬)</p>
                <div id="book-picker" class="space-y-3"></div>
            </div>
            <div class="pt-6 border-t space-y-4">
                <button onclick="exportData()" class="w-full py-4 bg-slate-50 text-[10px] font-black rounded-xl">ğŸ’¾ å¯¼å‡ºå¤‡ä»½ (JSON)</button>
                <button onclick="importDataClick()" class="w-full py-4 bg-slate-50 text-[10px] font-black rounded-xl">ğŸ“¥ å¯¼å…¥å¤‡ä»½ (JSON)</button>
                <input type="file" id="file-input" class="hide" accept=".json">
            </div>
        </div>
        <button onclick="saveSettings()" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-xs mt-4">ä¿å­˜å¹¶åº”ç”¨</button>
    </aside>

    <script>
        const MTI_STUB = [
            {id:'t1', en:'Ecological Civilization', zh:'ç”Ÿæ€æ–‡æ˜', cat:'æ”¿æ²»', ai:'Balanced development between humans and nature.'},
            {id:'t2', en:'Global Development Initiative', zh:'å…¨çƒå‘å±•å€¡è®®', cat:'æ”¿æ²»', ai:'Proposed to speed up UN 2030 Agenda.'},
            {id:'t3', en:'Special Drawing Rights (SDR)', zh:'ç‰¹åˆ«ææ¬¾æƒ', cat:'ç»æµ', ai:'International reserve asset created by IMF.'},
            {id:'t4', en:'Tertiary Industry', zh:'ç¬¬ä¸‰äº§ä¸š', cat:'ç»æµ', ai:'The service sector of the economy.'},
            {id:'t5', en:'Shared cultural values', zh:'å…±åŒæ–‡åŒ–ä»·å€¼', cat:'æ–‡åŒ–', ai:'Foundations of a community.'}
        ];

        let state = {
            user: null, books: {}, mem: {},
            settings: { dailyLimit: 20, selectedBooks: [] },
            activeTab: 'home', curCat: 'ALL', queue: [], idx: 0,
            swipeStart: 0, activeBook: null
        };

        // --- ç³»ç»Ÿæ ¸å¿ƒ ---
        function handleLogin() {
            const p = document.getElementById('auth-phone').value;
            if(!p) return;
            state.user = p;
            localStorage.setItem('lexi_v65_user', p);
            document.getElementById('auth-screen').classList.add('hide');
            document.getElementById('app-content').classList.remove('hide');
            loadData();
        }

        function loadData() {
            const saved = localStorage.getItem(`lexi_v65_data_${state.user}`);
            if(saved) {
                const d = JSON.parse(saved);
                state.books = d.books; state.mem = d.mem; state.settings = d.settings;
            } else {
                state.books = { "MTIå…¥é—¨åº“": { color:"from-indigo-600 to-indigo-900", items: MTI_STUB } };
                state.mem = {}; state.settings = { dailyLimit: 20, selectedBooks: ["MTIå…¥é—¨åº“"] };
            }
            save(); updateDash(); switchTab('home');
        }

        function save() { localStorage.setItem(`lexi_v65_data_${state.user}`, JSON.stringify({books: state.books, mem: state.mem, settings: state.settings})); }

        // --- äº¤äº’åŠŸèƒ½ ---
        function switchTab(t) {
            state.activeTab = t;
            ['home','explore','books','import','book-detail'].forEach(v => document.getElementById('view-'+v).classList.add('hide'));
            document.getElementById('view-'+t).classList.remove('hide');
            document.querySelectorAll('nav button').forEach(b => b.classList.add('opacity-20'));
            const map = {home:'nav-home', explore:'nav-explore', books:'nav-books', import:'nav-import', 'book-detail':'nav-books'};
            document.getElementById(map[t]).classList.remove('opacity-20');
            if(t==='explore' || t==='import') updateCatTags();
            if(t==='explore') runSearch();
            if(t==='books') renderBooks();
        }

        function renderItems(containerId, items) {
            const container = document.getElementById(containerId);
            if(!items.length) return container.innerHTML = '<div class="py-20 text-center opacity-10 font-black">EMPTY</div>';
            // æ’åºé€»è¾‘ï¼šæŒ‰å­—æ¯é¡ºåº
            const sorted = [...items].sort((a,b) => a.en.localeCompare(b.en));
            container.innerHTML = sorted.map(i => `
                <div class="swipe-container" ontouchstart="state.swipeStart = event.touches[0].clientX" ontouchend="handleSwipe(event, this)">
                    <div class="swipe-content p-6 border border-slate-50 flex justify-between items-center">
                        <div class="flex-1 pr-4"><h5 class="text-sm font-black mb-1">${i.en}</h5><p class="text-[10px] opacity-30 serif">${i.zh}</p></div>
                        <span class="text-[8px] font-black text-indigo-500 bg-indigo-50 px-2 py-1 rounded-md shrink-0 uppercase">${i.cat}</span>
                    </div>
                    <div onclick="deleteItem('${i.id}')" class="swipe-action">åˆ é™¤</div>
                </div>
            `).join('');
        }

        function handleSwipe(e, el) {
            const diff = state.swipeStart - e.changedTouches[0].clientX;
            document.querySelectorAll('.swiped').forEach(item => { if(item !== el) item.classList.remove('swiped') });
            if(diff > 60) el.classList.add('swiped');
            if(diff < -60) el.classList.remove('swiped');
        }

        function deleteItem(id) {
            Object.values(state.books).forEach(b => b.items = b.items.filter(i => i.id !== id));
            delete state.mem[id];
            save();
            if(state.activeTab === 'book-detail') renderBookContent();
            if(state.activeTab === 'explore') runSearch();
            updateDash();
        }

        // --- å­¦ä¹ ä¸ç®—æ³• ---
        function prepStudy(mode) {
            let pool = [];
            state.settings.selectedBooks.forEach(k => {
                state.books[k]?.items.forEach(i => {
                    const m = state.mem[i.id] || {lv:0, next:0};
                    if(mode === 'new' && m.lv === 0) pool.push(i);
                    else if(mode === 'review' && m.lv > 0 && m.lv < 5 && Date.now() >= m.next) pool.push(i);
                });
            });
            if(!pool.length) return alert("å½“å‰æ²¡æœ‰å¾…å­¦è¯æ¡");
            state.queue = mode==='new' ? pool.slice(0, state.settings.dailyLimit) : pool.sort(()=>Math.random()-0.5).slice(0, 30);
            state.idx = 0;
            document.getElementById('study-layer').classList.remove('hide');
            renderCard();
        }

        function finishSRS(score) {
            const i = state.queue[state.idx];
            if(!state.mem[i.id]) state.mem[i.id] = {lv:0, next:0, note:""};
            const m = state.mem[i.id];
            
            if(score === 3) m.lv++; 
            else if(score === 1) m.lv = Math.max(0, m.lv-1);
            else if(score === 2) { 
                // æ¨¡ç³Šï¼šä¸å‡çº§ï¼Œä¸”å°†è¯¥è¯æ¡é‡æ–°æ’å…¥é˜Ÿåˆ—æœ«å°¾ï¼Œå¢å¼ºè®°å¿†
                state.queue.push(i); 
                document.getElementById('study-p').innerText = `${state.idx+1} / ${state.queue.length}`;
            }

            const intervals = [0, 60000, 86400000, 259200000, 604800000, 1296000000];
            m.next = Date.now() + (score === 3 ? intervals[Math.min(m.lv, 5)] : 0);
            save(); state.idx++;
            if(state.idx < state.queue.length) renderCard(); else closeStudy();
        }

        // --- å¯¼å…¥å¯¼å‡º ---
        function exportData() {
            const dataStr = JSON.stringify({books: state.books, mem: state.mem, settings: state.settings}, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `LexiFlow_Backup_${state.user}.json`;
            a.click();
        }

        function importDataClick() { document.getElementById('file-input').click(); }
        document.getElementById('file-input')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const d = JSON.parse(ev.target.result);
                    state.books = d.books; state.mem = d.mem; state.settings = d.settings;
                    save(); updateDash(); alert("å¯¼å…¥æˆåŠŸ");
                } catch(err) { alert("éæ³•æ–‡ä»¶æ ¼å¼"); }
            };
            reader.readAsText(file);
        });

        // --- å…¶ä»–è¾…åŠ©é€»è¾‘ (ä¿æŒ v6.2 ç²¾å) ---
        function updateDash() {
            let n=0, r=0;
            state.settings.selectedBooks.forEach(k => {
                state.books[k]?.items.forEach(i => {
                    const m = state.mem[i.id] || {lv:0, next:0};
                    if(m.lv === 0) n++; else if(m.lv < 5 && Date.now() >= m.next) r++;
                });
            });
            document.getElementById('num-new').innerText = n;
            document.getElementById('num-rev').innerText = r;
            document.getElementById('plan-text').innerText = state.settings.selectedBooks.join(' / ') || "è¯·åœ¨è®¾ç½®ä¸­é€‰æ‹©è¯ä¹¦";
        }

        function toggleSidebar(s) {
            document.getElementById('sidebar').style.transform = s ? 'translateX(0)' : 'translateX(100%)';
            document.getElementById('side-overlay').classList.toggle('hide', !s);
            if(s) {
                document.getElementById('limit-val').innerText = state.settings.dailyLimit;
                document.getElementById('book-picker').innerHTML = Object.keys(state.books).map(k => `
                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                        <span class="text-xs font-black">${k}</span>
                        <input type="checkbox" value="${k}" ${state.settings.selectedBooks.includes(k)?'checked':''} class="book-chk w-5 h-5 accent-indigo-600">
                    </div>`).join('');
                document.getElementById('daily-limit').oninput = (e) => document.getElementById('limit-val').innerText = e.target.value;
            }
        }

        function saveSettings() {
            const chks = Array.from(document.querySelectorAll('.book-chk:checked')).map(c=>c.value);
            if(!chks.length) return alert("è¯·è‡³å°‘é€‰æ‹©ä¸€æœ¬è¯ä¹¦");
            state.settings.dailyLimit = parseInt(document.getElementById('daily-limit').value);
            state.settings.selectedBooks = chks.slice(0, 2);
            save(); toggleSidebar(false); updateDash();
        }

        function updateCatTags() {
            let cats = new Set(["æ”¿æ²»","ç»æµ","æ–‡åŒ–","æ³•å¾‹","ä½“è‚²"]);
            Object.values(state.books).forEach(b => b.items.forEach(i => { if(i.cat) cats.add(i.cat); }));
            document.getElementById('cat-tags-container').innerHTML = ['å…¨éƒ¨', ...cats].map(c => `
                <button onclick="setCatFilter('${c==='å…¨éƒ¨'?'ALL':c}')" class="px-5 py-2 rounded-full text-[10px] font-black bg-white border border-slate-100 whitespace-nowrap ${state.curCat===(c==='å…¨éƒ¨'?'ALL':c)?'active-tag':''}">
                    ${c}
                </button>`).join('');
            document.getElementById('cat-history').innerHTML = '<option value="">åˆ†ç±»</option>' + Array.from(cats).map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('import-book-sel').innerHTML = Object.keys(state.books).map(k=>`<option>${k}</option>`).join('');
        }

        function setCatFilter(c) { state.curCat = c; updateCatTags(); runSearch(); }
        function runSearch() {
            const q = document.getElementById('search-box').value.toLowerCase();
            let all = []; Object.values(state.books).forEach(b => all = all.concat(b.items));
            const filtered = all.filter(i => (i.en.toLowerCase().includes(q) || i.zh.includes(q)) && (state.curCat === 'ALL' || i.cat === state.curCat));
            renderItems('search-list', filtered);
        }

        function renderBooks() {
            document.getElementById('book-grid').innerHTML = Object.keys(state.books).map(k => `
                <div onclick="openBook('${k}')" class="aspect-[4/5] rounded-[2.5rem] bg-gradient-to-br ${state.books[k].color || 'from-slate-700 to-slate-900'} p-6 flex flex-col justify-end text-white shadow-lg active:scale-95 transition-all">
                    <p class="text-[9px] font-black opacity-50 uppercase mb-1">${state.books[k].items.length} è¯æ¡</p>
                    <h4 class="text-base font-black serif">${k}</h4>
                </div>`).join('');
        }

        function openBook(k) { state.activeBook = k; document.getElementById('book-title-h').innerText = k; renderBookContent(); switchTab('book-detail'); }
        function renderBookContent() { renderItems('book-item-list', state.books[state.activeBook].items); }
        function doImport() {
            const en = document.getElementById('in-en').value.trim();
            const zh = document.getElementById('in-zh').value.trim();
            const cat = document.getElementById('in-cat').value.trim() || "å¸¸è§„";
            const b = document.getElementById('import-book-sel').value;
            if(!en || !zh) return alert("è¯·å¡«å†™æœ¯è¯­å’Œç¿»è¯‘");
            state.books[b].items.push({ id:'u'+Date.now(), en, zh, cat, ai: document.getElementById('in-ai').value });
            save(); ['in-en','in-zh','in-cat','in-ai'].forEach(id => document.getElementById(id).value = '');
            alert("å·²ä¿å­˜"); updateDash();
        }

        function renderCard() {
            const i = state.queue[state.idx];
            document.getElementById('studyCard').classList.remove('flipped');
            document.getElementById('card-en').innerText = i.en;
            document.getElementById('card-zh').innerText = i.zh;
            document.getElementById('card-ai').innerText = i.ai || "æš‚æ— ä¾‹å¥ã€‚";
            document.getElementById('card-note').value = state.mem[i.id]?.note || "";
            document.getElementById('study-p').innerText = `${state.idx+1} / ${state.queue.length}`;
        }
        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateDash(); }
        function syncNote() { const i = state.queue[state.idx]; if(!state.mem[i.id]) state.mem[i.id]={lv:0,next:0,note:""}; state.mem[i.id].note = document.getElementById('card-note').value; save(); }
        function playTTS() { const i = state.queue[state.idx]; const m = new SpeechSynthesisUtterance(i.en); m.lang='en-US'; window.speechSynthesis.speak(m); }
        function createNewBook() { const n = prompt("è¯ä¹¦åç§°:"); if(n && !state.books[n]) { state.books[n] = {color:"from-slate-600 to-slate-800", items:[]}; save(); renderBooks(); } }

        if(localStorage.getItem('lexi_v65_user')) {
            state.user = localStorage.getItem('lexi_v65_user');
            document.getElementById('auth-screen').classList.add('hide');
            document.getElementById('app-content').classList.remove('hide');
            loadData();
        }
    </script>
</body>
</html>
