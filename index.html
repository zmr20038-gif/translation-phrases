<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LexiFlow MTI v15 Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #F8FAFC; --text: #0F172A; --card: #FFFFFF; --accent: #4F46E5; }
        /* æ·±åº¦ä¼˜åŒ–å¤œé—´æ¨¡å¼ï¼šèƒŒæ™¯æ›´æ²‰ç¨³ï¼Œé™ä½å¯¹æ¯”åº¦ */
        .dark { --bg: #0F172A; --text: #CBD5E1; --card: #1E293B; --accent: #818CF8; }
        
        body { background-color: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .serif { font-family: 'Noto Serif SC', serif; }
        .app-container { max-width: 100%; margin: 0 auto; }
        @media (min-width: 640px) { .app-container { max-width: 600px; } }

        #settings-sidebar { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1); }
        #settings-sidebar.open { transform: translateX(0); }
        .hide { display: none !important; }
        .active-tab { color: var(--accent) !important; opacity: 1 !important; font-weight: 800; position: relative; }
        .active-tab::after { content: ''; position: absolute; bottom: -6px; left: 0; width: 100%; height: 3px; background: var(--accent); border-radius: 2px; }

        .card-container { perspective: 1200px; width: 100%; height: 100%; position: relative; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 2.5rem; display: flex; flex-direction: column; padding: 2rem; background: var(--card); border: 1px solid rgba(0,0,0,0.03); }
        .card-back { transform: rotateY(180deg); border: 2px solid var(--accent); overflow-y: auto; }

        .book-cover { box-shadow: 4px 8px 20px rgba(0,0,0,0.12); border-left: 6px solid rgba(0,0,0,0.2); transition: transform 0.2s; }
        .book-cover:active { transform: scale(0.95); }
        .checkbox-custom input:checked + div { background-color: var(--accent); border-color: var(--accent); }
    </style>
</head>
<body class="select-none min-h-screen pb-28">

    <header class="app-container px-6 pt-12 pb-4 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-[900] tracking-tighter italic">Lexi<span class="text-indigo-600">MTI</span></h1>
            <p class="text-[10px] font-black opacity-30 uppercase tracking-[0.2em] mt-1">2026 Master Edition v15</p>
        </div>
        <div class="flex gap-2">
            <button onclick="switchTab('import')" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full shadow-sm flex items-center justify-center active:scale-90 transition-transform">ğŸ“¥</button>
            <button onclick="toggleSidebar(true)" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full shadow-sm flex items-center justify-center active:scale-90 transition-transform">âš™ï¸</button>
        </div>
    </header>

    <main id="view-home" class="app-container px-6 space-y-6">
        <div class="grid grid-cols-2 gap-4">
            <div onclick="startStudy('new')" class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] shadow-sm border-b-4 border-indigo-100 dark:border-slate-700 active:scale-95 transition-all">
                <span class="text-[10px] font-black opacity-40 uppercase">Daily Task</span>
                <p id="num-new" class="text-4xl font-black mt-2 text-indigo-600">0</p>
                <p class="text-[10px] opacity-40 mt-1">æ··åˆè¯ä¹¦å¾…å­¦</p>
            </div>
            <div onclick="startStudy('review')" class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] shadow-sm border-b-4 border-emerald-100 dark:border-slate-700 active:scale-95 transition-all">
                <span class="text-[10px] font-black opacity-40 uppercase">Review</span>
                <p id="num-review" class="text-4xl font-black mt-2 text-emerald-500">0</p>
                <p class="text-[10px] opacity-40 mt-1">å³åˆ»å¤ä¹ è¯æ¡</p>
            </div>
        </div>

        <div class="bg-gradient-to-br from-indigo-600 to-blue-700 rounded-[2.5rem] p-8 text-white shadow-xl relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full blur-2xl"></div>
            <p id="quote-en" class="text-lg font-bold font-serif leading-relaxed mb-4">"Language is the road map of a culture."</p>
            <p id="quote-zh" class="text-sm opacity-80 serif border-l-2 border-white/30 pl-4">â€œè¯­è¨€æ˜¯æ–‡åŒ–çš„è·¯çº¿å›¾ã€‚â€</p>
        </div>
    </main>

    <main id="view-import" class="app-container px-6 hide">
        <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] p-8 shadow-sm space-y-4">
            <h2 class="text-xl font-black mb-2">è¯æ¡å½•å…¥</h2>
            <input id="in-en" type="text" placeholder="è‹±æ–‡å•è¯/è¯ç»„" class="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-none outline-none text-sm font-bold">
            <input id="in-zh" type="text" placeholder="ä¸­æ–‡ç¿»è¯‘" class="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-none outline-none text-sm serif">
            <textarea id="in-d" placeholder="è§£é‡Š (å¯é€‰)" class="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-none outline-none text-xs h-20 resize-none"></textarea>
            <textarea id="in-scene" placeholder="ä¾‹å¥ (å¯é€‰)" class="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-none outline-none text-xs h-20 resize-none"></textarea>
            
            <div class="flex items-center justify-between p-2 border-t border-slate-50 dark:border-slate-700 pt-4">
                <div class="flex flex-col">
                    <span class="text-[9px] font-black opacity-30 uppercase">Target Book</span>
                    <span id="target-book-name" class="text-xs font-bold text-indigo-600 italic">é»˜è®¤è¯åº“</span>
                </div>
                <button onclick="switchTab('books')" class="text-[10px] bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 px-4 py-1.5 rounded-full font-black">åˆ‡æ¢/åˆ›å»ºè¯ä¹¦</button>
            </div>
            
            <button onclick="saveSingleImport()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-indigo-200 dark:shadow-none active:scale-95 transition-all">å¯¼å…¥è¯ä¹¦</button>
        </div>
        <div class="mt-4 text-center">
            <input type="file" id="file-import" class="hide" onchange="handleFileImport(event)">
            <button onclick="document.getElementById('file-import').click()" class="text-[10px] font-black opacity-30 underline">æˆ–ä»å¤–éƒ¨ JSON æ–‡ä»¶å¯¼å…¥</button>
        </div>
    </main>

    <main id="view-explore" class="app-container px-6 hide">
        <div id="explore-cats" class="flex gap-4 mb-6 overflow-x-auto no-scrollbar pb-2"></div>
        <div id="explore-list" class="space-y-4 pb-32"></div>
    </main>

    <main id="view-books" class="app-container px-6 hide pb-32">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black">è¯ä¹¦ç®¡ç†</h2>
            <button onclick="createNewBook()" class="text-[10px] bg-slate-900 dark:bg-white text-white dark:text-black px-4 py-2 rounded-xl font-black">+ åˆ›å»ºæ–°è¯ä¹¦</button>
        </div>
        <div id="bookshelf-list" class="grid grid-cols-2 gap-5"></div>
    </main>

    <main id="view-learned" class="app-container px-6 hide pb-32">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black">å½’æ¡£ç®¡ç†</h2>
            <button onclick="toggleEditMode()" id="btn-edit" class="text-xs font-bold bg-slate-100 dark:bg-slate-800 px-4 py-2 rounded-full">æ‰¹é‡ç®¡ç†</button>
        </div>
        <div id="learned-list" class="space-y-3"></div>
    </main>

    <section id="study-layer" class="fixed inset-0 bg-slate-50 dark:bg-slate-950 z-[200] hide flex flex-col">
        <div class="app-container w-full px-6 pt-12 flex justify-between items-center">
            <button onclick="closeStudy()" class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center">âœ•</button>
            <span id="study-progress" class="text-[10px] font-black opacity-30 tracking-widest uppercase italic">0 / 0</span>
            <button onclick="speakWord()" class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center">ğŸ”Š</button>
        </div>
        <div class="flex-1 p-6 flex items-center justify-center w-full max-w-lg mx-auto">
            <div class="card-container" id="studyCard">
                <div class="flip-card-inner" onclick="document.getElementById('studyCard').classList.toggle('flipped')">
                    <div class="card-face items-center justify-center text-center">
                        <span id="card-origin" class="text-[8px] font-black text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-3 py-1 rounded mb-8 tracking-widest uppercase">BOOK</span>
                        <h2 id="card-en" class="text-3xl font-bold leading-tight mb-8">Word</h2>
                        <div class="absolute bottom-10 w-full text-center"><p class="text-[9px] font-black opacity-20 uppercase tracking-widest">Tap to flip</p></div>
                    </div>
                    <div class="card-face card-back items-start text-left">
                        <h3 id="card-zh" class="text-2xl font-bold text-indigo-600 mb-3 serif">ä¸­æ–‡</h3>
                        <p id="card-d" class="text-sm opacity-60 leading-relaxed mb-6">Definition</p>
                        <div class="w-full bg-slate-50 dark:bg-slate-900 p-4 rounded-2xl mb-4">
                            <p id="card-scene-en" class="text-xs font-bold mb-1"></p>
                            <p id="card-scene-zh" class="text-[10px] opacity-40 serif"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-8 pb-14 bg-white dark:bg-slate-900 rounded-t-[3rem] app-container w-full">
            <div class="grid grid-cols-3 gap-4">
                <button onclick="handleLearn(1)" class="py-5 bg-slate-50 dark:bg-slate-800 rounded-2xl font-black text-[10px] opacity-40">å¿˜äº†</button>
                <button onclick="handleLearn(2)" class="py-5 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl font-black text-[10px] text-indigo-500">æ¨¡ç³Š</button>
                <button onclick="handleLearn(3)" class="py-5 bg-indigo-600 text-white rounded-2xl font-black text-[10px] shadow-lg shadow-indigo-200">è®¤è¯†</button>
            </div>
        </div>
    </section>

    <div id="settings-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[300] hide"></div>
    <aside id="settings-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-900 z-[301] shadow-2xl p-6 flex flex-col">
        <div id="user-panel" class="mb-8 p-6 bg-slate-50 dark:bg-slate-800 rounded-[2.5rem]">
            <div id="login-form">
                <h3 class="font-black text-xs mb-4 opacity-40 uppercase">Auth</h3>
                <input type="tel" id="login-phone" placeholder="æ‰‹æœºå·" class="w-full p-3 rounded-xl text-xs mb-3 border dark:bg-slate-900">
                <div class="flex gap-2 mb-4">
                    <input type="number" id="login-code" placeholder="1234" class="w-full p-3 rounded-xl text-xs border dark:bg-slate-900">
                    <button onclick="alert('éªŒè¯ç  1234')" class="whitespace-nowrap px-3 bg-white dark:bg-slate-700 text-[10px] font-bold rounded-xl">è·å–</button>
                </div>
                <button onclick="doLogin()" class="w-full bg-indigo-600 text-white p-3 rounded-xl text-xs font-black shadow-lg shadow-indigo-200">ç™»å½•</button>
            </div>
            <div id="profile-data" class="hide text-center">
                <div class="w-12 h-12 rounded-full bg-indigo-100 dark:bg-indigo-500/20 mx-auto mb-2 flex items-center justify-center text-2xl">ğŸ§‘â€ğŸ“</div>
                <p id="display-phone" class="font-black text-sm mb-4">138****0000</p>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-white dark:bg-slate-900 p-3 rounded-2xl">
                        <p class="text-[8px] opacity-40 uppercase font-black">è¯æ±‡é‡</p>
                        <p id="stat-words" class="text-sm font-black text-indigo-600">0</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-3 rounded-2xl">
                        <p class="text-[8px] opacity-40 uppercase font-black">ç§¯åˆ†</p>
                        <p id="stat-points" class="text-sm font-black text-amber-500">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto space-y-4 no-scrollbar">
            <div class="p-6 bg-slate-50 dark:bg-slate-800 rounded-[2rem]">
                <p class="text-[10px] font-black opacity-30 uppercase mb-4 tracking-widest">æ¯æ—¥å­¦ä¹ è¯æ•° (åˆ†ä¹¦é…ç½®)</p>
                <div id="goal-config-list" class="space-y-4"></div>
            </div>
            <button onclick="toggleDarkMode()" class="w-full p-5 bg-slate-50 dark:bg-slate-800 rounded-[2rem] flex justify-between items-center font-bold text-xs">
                <span>å¤œé—´æ¨¡å¼</span><span id="mode-icon">ğŸŒ™</span>
            </button>
        </div>
    </aside>

    <div id="batch-bar" class="fixed bottom-28 left-6 right-6 max-w-lg mx-auto bg-white dark:bg-slate-800 shadow-2xl rounded-[1.5rem] p-4 flex justify-between items-center hide z-[50]">
        <span class="text-xs font-black ml-4 text-indigo-600">å·²é€‰ <span id="selected-count">0</span> é¡¹</span>
        <button onclick="moveToTrash()" class="bg-red-50 text-red-500 px-6 py-3 rounded-xl text-[10px] font-black">å½’æ¡£å¹¶ç§»é™¤</button>
    </div>

    <nav id="main-nav" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl rounded-full shadow-2xl flex items-center px-10 py-3 gap-16 border border-white/20 z-[100]">
        <button onclick="switchTab('home')" id="btn-home" class="text-2xl active-tab p-1">ğŸ </button>
        <button onclick="switchTab('explore')" id="btn-explore" class="text-2xl opacity-20 p-1">ğŸ”</button>
        <button onclick="switchTab('learned')" id="btn-learned" class="text-2xl opacity-20 p-1">ğŸ“</button>
    </nav>

    <script>
        // --- å®Œæ•´æ ¸å¿ƒè¯åº“ (40æ¡) ---
        const RAW_LIB = [
            { id:'p1', cat:'POL', en:'New quality productive forces', zh:'æ–°è´¨ç”Ÿäº§åŠ›', d:'ä»¥åˆ›æ–°èµ·ä¸»å¯¼ä½œç”¨çš„å…ˆè¿›ç”Ÿäº§åŠ›ã€‚', scene:{en:"Innovation drives new quality productive forces.", zh:"åˆ›æ–°é©±åŠ¨æ–°è´¨ç”Ÿäº§åŠ›ã€‚"} },
            { id:'p2', cat:'POL', en:'Chinese path to modernization', zh:'ä¸­å›½å¼ç°ä»£åŒ–', d:'äººå£è§„æ¨¡å·¨å¤§ã€å…¨ä½“äººæ°‘å…±åŒå¯Œè£•çš„ç°ä»£åŒ–ã€‚', scene:{en:"The Chinese path to modernization offers new options.", zh:"ä¸­å›½å¼ç°ä»£åŒ–æä¾›äº†æ–°é€‰æ‹©ã€‚"} },
            { id:'p3', cat:'POL', en:'Whole-process people\'s democracy', zh:'å…¨è¿‡ç¨‹äººæ°‘æ°‘ä¸»', d:'æœ€å¹¿æ³›ã€æœ€çœŸå®ã€æœ€ç®¡ç”¨çš„æ°‘ä¸»ã€‚', scene:{en:"This ensures whole-process people's democracy.", zh:"è¿™ä¿éšœäº†å…¨è¿‡ç¨‹äººæ°‘æ°‘ä¸»ã€‚"} },
            { id:'p4', cat:'POL', en:'Community with a shared future', zh:'äººç±»å‘½è¿å…±åŒä½“', d:'æ—¨åœ¨å»ºç«‹ä¸€ä¸ªæŒä¹…å’Œå¹³ã€æ™®éå®‰å…¨çš„ä¸–ç•Œã€‚', scene:{en:"Building a community with a shared future.", zh:"æ„å»ºäººç±»å‘½è¿å…±åŒä½“ã€‚"} },
            { id:'p5', cat:'POL', en:'Targeted poverty alleviation', zh:'ç²¾å‡†æ‰¶è´«', d:'å¯¹ä¸åŒè´«å›°åŒºåŸŸå®æ–½ç²¾ç¡®å¸®æ‰¶ã€‚', scene:{en:"It has lifted millions out of poverty.", zh:"å®ƒä½¿æ•°ç™¾ä¸‡äººè„±è´«ã€‚"} },
            { id:'e1', cat:'ECO', en:'Supply-side structural reform', zh:'ä¾›ç»™ä¾§ç»“æ„æ€§æ”¹é©', d:'ç”¨æ”¹é©åŠæ³•æ¨è¿›ç»“æ„è°ƒæ•´ã€‚', scene:{en:"Deepening supply-side structural reform.", zh:"æ·±åŒ–ä¾›ç»™ä¾§ç»“æ„æ€§æ”¹é©ã€‚"} },
            { id:'e2', cat:'ECO', en:'Dual circulation', zh:'åŒå¾ªç¯', d:'ä»¥å†…å¾ªç¯ä¸ºä¸»ä½“ã€å†…å¤–åŒå¾ªç¯ç›¸äº’ä¿ƒè¿›ã€‚', scene:{en:"The strategy boosts economic resilience.", zh:"è¯¥æˆ˜ç•¥å¢å¼ºäº†ç»æµéŸ§æ€§ã€‚"} },
            { id:'e3', cat:'ECO', en:'High-standard opening up', zh:'é«˜æ°´å¹³å¯¹å¤–å¼€æ”¾', d:'å¸å¼•å…¨çƒèµ„æºè¦ç´ ã€‚', scene:{en:"Committed to high-standard opening up.", zh:"è‡´åŠ›äºé«˜æ°´å¹³å¯¹å¤–å¼€æ”¾ã€‚"} },
            { id:'e4', cat:'ECO', en:'Negative list', zh:'è´Ÿé¢æ¸…å•', d:'è§„å®šä¼ä¸šä¸èƒ½ä»äº‹çš„é¢†åŸŸæ¸…å•ã€‚', scene:{en:"The negative list has been shortened.", zh:"è´Ÿé¢æ¸…å•å·²ç¼©å‡ã€‚"} },
            { id:'e5', cat:'ECO', en:'Digital economy', zh:'æ•°å­—ç»æµ', d:'ä»¥æ•°æ®èµ„æºä¸ºå…³é”®è¦ç´ ã€‚', scene:{en:"Digital economy is a new engine.", zh:"æ•°å­—ç»æµæ˜¯æ–°å¼•æ“ã€‚"} },
            { id:'t1', cat:'TEC', en:'Quantum Entanglement', zh:'é‡å­çº ç¼ ', d:'ç²’å­é—´ç¬é—´ç›¸äº’å½±å“çš„ç°è±¡ã€‚', scene:{en:"Enables secure communication.", zh:"å®ç°å®‰å…¨é€šä¿¡ã€‚"} },
            { id:'t2', cat:'TEC', en:'Generative AI', zh:'ç”Ÿæˆå¼äººå·¥æ™ºèƒ½', d:'èƒ½é€šè¿‡å­¦ä¹ ç”Ÿæˆæ–°å†…å®¹çš„AIã€‚', scene:{en:"Transforming content creation.", zh:"æ”¹å˜å†…å®¹åˆ›ä½œã€‚"} },
            { id:'t3', cat:'TEC', en:'Semiconductor wafer', zh:'åŠå¯¼ä½“æ™¶åœ†', d:'åˆ¶ä½œé›†æˆç”µè·¯çš„ç¡…åŸºåº•ã€‚', scene:{en:"Global demand is rising.", zh:"å…¨çƒéœ€æ±‚æ­£åœ¨ä¸Šå‡ã€‚"} },
            { id:'t4', cat:'TEC', en:'Blockchain', zh:'åŒºå—é“¾', d:'å»ä¸­å¿ƒåŒ–çš„åˆ†å¸ƒå¼è´¦æœ¬ã€‚', scene:{en:"Ensures data transparency.", zh:"ç¡®ä¿æ•°æ®é€æ˜ã€‚"} },
            { id:'t5', cat:'TEC', en:'Cloud computing', zh:'äº‘è®¡ç®—', d:'é€šè¿‡ç½‘ç»œæä¾›è®¡ç®—èµ„æºã€‚', scene:{en:"Migrating to cloud computing.", zh:"å‘äº‘è®¡ç®—è¿ç§»ã€‚"} },
            { id:'c1', cat:'CUL', en:'Intangible cultural heritage', zh:'éç‰©è´¨æ–‡åŒ–é—äº§', d:'å„ç¾¤ä½“è§†ä¸ºå…¶é—äº§çš„å®è·µã€‚', scene:{en:"Protecting cultural heritage.", zh:"ä¿æŠ¤æ–‡åŒ–é—äº§ã€‚"} },
            { id:'c2', cat:'CUL', en:'Confucianism', zh:'å„’å®¶æ€æƒ³', d:'å­”å­å­¦è¯´ä¸ºåŸºç¡€çš„ä½“ç³»ã€‚', scene:{en:"Emphasizes benevolence.", zh:"å¼ºè°ƒä»ä¹‰ã€‚"} },
            { id:'c3', cat:'CUL', en:'Cultural self-confidence', zh:'æ–‡åŒ–è‡ªä¿¡', d:'å¯¹è‡ªèº«æ–‡åŒ–ä»·å€¼çš„è‚¯å®šã€‚', scene:{en:"Strengthening self-confidence.", zh:"å¢å¼ºæ–‡åŒ–è‡ªä¿¡ã€‚"} },
            { id:'c4', cat:'CUL', en:'TCM', zh:'ä¸­åŒ»è¯', d:'æ•´ä½“è§‚å¿µè¾¨è¯è®ºæ²»ã€‚', scene:{en:"TCM plays a role globally.", zh:"ä¸­åŒ»è¯åœ¨å…¨çƒå‘æŒ¥ä½œç”¨ã€‚"} },
            { id:'c5', cat:'CUL', en:'Soft power', zh:'è½¯å®åŠ›', d:'é€šè¿‡å¸å¼•åŠ›è¾¾åˆ°ç›®çš„çš„èƒ½åŠ›ã€‚', scene:{en:"Culture is key to soft power.", zh:"æ–‡åŒ–æ˜¯è½¯å®åŠ›çš„å…³é”®ã€‚"} },
            { id:'ch1', cat:'CHEM', en:'Catalyst', zh:'å‚¬åŒ–å‰‚', d:'æ”¹å˜ååº”é€Ÿç‡æœ¬èº«ä¸å˜ã€‚', scene:{en:"Enzymes act as catalysts.", zh:"é…¶èµ·å‚¬åŒ–ä½œç”¨ã€‚"} },
            { id:'ch2', cat:'CHEM', en:'Carbon Neutrality', zh:'ç¢³ä¸­å’Œ', d:'æŠµæ¶ˆäº§ç”Ÿçš„äºŒæ°§åŒ–ç¢³ã€‚', scene:{en:"Achieving carbon neutrality.", zh:"å®ç°ç¢³ä¸­å’Œã€‚"} },
            { id:'ch3', cat:'CHEM', en:'Polymerization', zh:'èšåˆååº”', d:'ç”±å•ä½“åˆæˆèšåˆç‰©ã€‚', scene:{en:"Plastic produced by polymerization.", zh:"å¡‘æ–™ç”±èšåˆååº”ç”Ÿäº§ã€‚"} },
            { id:'ch4', cat:'CHEM', en:'Oxidation', zh:'æ°§åŒ–ååº”', d:'ç‰©è´¨å¤±å»ç”µå­çš„è¿‡ç¨‹ã€‚', scene:{en:"Rust is iron oxidation.", zh:"é“é”ˆæ˜¯é“çš„æ°§åŒ–ã€‚"} },
            { id:'ch5', cat:'CHEM', en:'Rare earth elements', zh:'ç¨€åœŸå…ƒç´ ', d:'å‘¨æœŸè¡¨17ç§å…ƒç´ æ€»ç§°ã€‚', scene:{en:"Vital for electronics.", zh:"å¯¹ç”µå­äº§å“è‡³å…³é‡è¦ã€‚"} },
            { id:'m1', cat:'MED', en:'Clinical trial', zh:'ä¸´åºŠè¯•éªŒ', d:'äººç±»èº«ä¸Šçš„åŒ»å­¦ç ”ç©¶ã€‚', scene:{en:"Undergoing phase III trials.", zh:"è¿›è¡Œä¸‰æœŸä¸´åºŠè¯•éªŒã€‚"} },
            { id:'m2', cat:'MED', en:'Herd immunity', zh:'ç¾¤ä½“å…ç–«', d:'é€šè¿‡é«˜æ¯”ä¾‹å…ç–«ä¿æŠ¤å¼±è€…ã€‚', scene:{en:"Vaccination helps herd immunity.", zh:"ç–«è‹—æœ‰åŠ©äºç¾¤ä½“å…ç–«ã€‚"} },
            { id:'m3', cat:'MED', en:'Placebo effect', zh:'å®‰æ…°å‰‚æ•ˆåº”', d:'æ— æ•ˆæ²»ç–—å› å¿ƒç†å¥½è½¬ã€‚', scene:{en:"Showed strong placebo effect.", zh:"è¡¨ç°å‡ºå®‰æ…°å‰‚æ•ˆåº”ã€‚"} },
            { id:'m4', cat:'MED', en:'Telemedicine', zh:'è¿œç¨‹åŒ»ç–—', d:'åˆ©ç”¨æŠ€æœ¯è¿œç¨‹è¯Šç–—ã€‚', scene:{en:"Expanding health access.", zh:"æ‰©å¤§åŒ»ç–—è¦†ç›–ã€‚"} },
            { id:'m5', cat:'MED', en:'Metabolism', zh:'æ–°é™ˆä»£è°¢', d:'ç”Ÿå‘½ç»´æŒçš„åŒ–å­¦ååº”ã€‚', scene:{en:"Exercise boosts metabolism.", zh:"è¿åŠ¨ä¿ƒè¿›ä»£è°¢ã€‚"} },
            { id:'g1', cat:'GEO', en:'Silk Road Economic Belt', zh:'ä¸ç»¸ä¹‹è·¯ç»æµå¸¦', d:'ä¸­å›½ä¸è¥¿äºšåˆä½œåŒºåŸŸã€‚', scene:{en:"Promotes regional trade.", zh:"ä¿ƒè¿›åŒºåŸŸè´¸æ˜“ã€‚"} },
            { id:'g2', cat:'GEO', en:'Tectonic plate', zh:'æ¿å—æ„é€ ', d:'å²©çŸ³åœˆåˆ†å‰²çš„å·¨å¤§æ¿å—ã€‚', scene:{en:"Occur at plate boundaries.", zh:"å‘ç”Ÿåœ¨æ¿å—è¾¹ç•Œã€‚"} },
            { id:'g3', cat:'GEO', en:'Prime Meridian', zh:'æœ¬åˆå­åˆçº¿', d:'è®¡ç®—ç»åº¦çš„èµ·å§‹çº¿ã€‚', scene:{en:"Passes through Greenwich.", zh:"ç©¿è¿‡æ ¼æ—å¨æ²»ã€‚"} },
            { id:'g4', cat:'GEO', en:'Archipelago', zh:'ç¾¤å²›', d:'å½¼æ­¤è·ç¦»è¿‘çš„ä¸€ç»„å²›å±¿ã€‚', scene:{en:"World's largest archipelago.", zh:"ä¸–ç•Œæœ€å¤§ç¾¤å²›ã€‚"} },
            { id:'g5', cat:'GEO', en:'Monsoon', zh:'å­£é£', d:'é£å‘éšå­£èŠ‚æ˜¾è‘—æ”¹å˜ã€‚', scene:{en:"Brings heavy rain.", zh:"å¸¦æ¥å¼ºé™é›¨ã€‚"} },
            { id:'s1', cat:'SPT', en:'Winter Olympics', zh:'å†¬å¥¥ä¼š', d:'æœ€å¤§è§„æ¨¡å†¬å­£ç»¼åˆèµ›äº‹ã€‚', scene:{en:"Beijing hosted a success.", zh:"åŒ—äº¬æˆåŠŸä¸¾åŠã€‚"} },
            { id:'s2', cat:'SPT', en:'Marathon', zh:'é©¬æ‹‰æ¾', d:'42.195å…¬é‡Œé•¿è·‘ã€‚', scene:{en:"Requires endurance.", zh:"éœ€è¦è€åŠ›ã€‚"} },
            { id:'s3', cat:'SPT', en:'Doping control', zh:'å…´å¥‹å‰‚æ£€æµ‹', d:'ç»´æŠ¤å…¬å¹³çš„è¯ç‰©æ£€æŸ¥ã€‚', scene:{en:"Strict control enforced.", zh:"å®æ–½ä¸¥æ ¼æ£€æµ‹ã€‚"} },
            { id:'s4', cat:'SPT', en:'Hat trick', zh:'å¸½å­æˆæ³•', d:'å•åœºè¿å¾—ä¸‰åˆ†ã€‚', scene:{en:"Scored a hat trick.", zh:"ä¸Šæ¼”å¸½å­æˆæ³•ã€‚"} },
            { id:'s5', cat:'SPT', en:'Grand Slam', zh:'å¤§æ»¡è´¯', d:'å›Šæ‹¬æ‰€æœ‰é¡¶çº§å† å†›ã€‚', scene:{en:"Complete a Grand Slam.", zh:"å®Œæˆå¤§æ»¡è´¯ã€‚"} }
        ].sort((a,b)=>a.en.localeCompare(b.en));

        const QUOTES = [
            { en: "To have another language is a second soul.", zh: "æŒæ¡å¦ä¸€é—¨è¯­è¨€ï¼Œå³æ‹¥æœ‰ç¬¬äºŒä¸ªçµé­‚ã€‚" },
            { en: "Translation is that which transforms everything so that nothing changes.", zh: "ç¿»è¯‘æ˜¯æ”¹å˜ä¸€åˆ‡ï¼Œå´ä½¿ä¸‡ç‰©å¦‚åˆã€‚" }
        ];

        // --- State Management ---
        let state = {
            mem: JSON.parse(localStorage.getItem('lexi_v15_mem') || '{}'),
            user: JSON.parse(localStorage.getItem('lexi_v15_user') || 'null'),
            notes: JSON.parse(localStorage.getItem('lexi_v15_notes') || '{}'),
            // è¯ä¹¦ä¹¦æ¶
            books: JSON.parse(localStorage.getItem('lexi_v15_books') || JSON.stringify({
                'é»˜è®¤è¯åº“': { id:'default', color:'from-indigo-500 to-indigo-700', goal:10, items: RAW_LIB },
                'æœ€åçš„ç¤¼ç‰©2025ç‰ˆ': { id:'gift2025', color:'from-rose-500 to-pink-700', goal:10, items: [] }
            })),
            activeBookKey: 'é»˜è®¤è¯åº“',
            filter: 'all', queue: [], idx: 0, editMode: false, selectedItems: new Set(),
            isDark: localStorage.getItem('lexi_dark') === 'true'
        };

        function init() {
            if(state.isDark) document.body.classList.add('dark');
            updateDashboard();
            updateUserUI();
            updateQuote();
            renderGoalConfig();
        }

        // --- Core Functions ---
        function updateDashboard() {
            const now = Date.now();
            let totalNew = 0, totalReview = 0;
            Object.values(state.books).forEach(book => {
                totalNew += book.items.filter(i => !state.mem[i.id] || state.mem[i.id].lv === 0).length;
                totalReview += book.items.filter(i => state.mem[i.id]?.lv > 0 && state.mem[i.id].lv < 99 && now >= state.mem[i.id].next).length;
            });
            document.getElementById('num-new').innerText = totalNew;
            document.getElementById('num-review').innerText = totalReview;
        }

        // --- Multi-Book Study Engine ---
        function startStudy(mode) {
            let combined = [];
            const now = Date.now();
            Object.keys(state.books).forEach(key => {
                const book = state.books[key];
                let sub = [];
                if(mode === 'new') sub = book.items.filter(i => !state.mem[i.id] || state.mem[i.id].lv === 0).slice(0, book.goal);
                else sub = book.items.filter(i => state.mem[i.id]?.lv > 0 && state.mem[i.id].lv < 99 && now >= state.mem[i.id].next);
                combined.push(...sub.map(i => ({...i, bookTag: key})));
            });
            if(!combined.length) return alert("ä»»åŠ¡å·²å®Œæˆï¼");
            state.queue = combined.sort(() => Math.random() - 0.5);
            state.idx = 0;
            document.getElementById('study-layer').classList.remove('hide');
            renderCard();
        }

        function renderCard() {
            const item = state.queue[state.idx];
            document.getElementById('studyCard').classList.remove('flipped');
            document.getElementById('card-origin').innerText = item.bookTag;
            document.getElementById('card-en').innerText = item.en;
            document.getElementById('card-zh').innerText = item.zh;
            document.getElementById('card-d').innerText = item.d;
            document.getElementById('card-scene-en').innerText = item.scene.en;
            document.getElementById('card-scene-zh').innerText = item.scene.zh;
            document.getElementById('study-progress').innerText = `${state.idx + 1} / ${state.queue.length}`;
        }

        function handleLearn(score) {
            const item = state.queue[state.idx];
            if(!state.mem[item.id]) state.mem[item.id] = { lv: 0, next: 0 };
            const m = state.mem[item.id];
            if(score === 3) m.lv += 1;
            else if(score === 1) m.lv = 1; 
            const intervals = [0, 1, 1440, 4320, 10080]; 
            m.next = Date.now() + (intervals[Math.min(m.lv, 4)] * 60000);
            if(state.user && score > 1) state.user.points += 10;
            save();
            state.idx++;
            if(state.idx < state.queue.length) renderCard();
            else closeStudy();
        }

        // --- Import Logic ---
        function saveSingleImport() {
            const en = document.getElementById('in-en').value.trim();
            const zh = document.getElementById('in-zh').value.trim();
            if(!en || !zh) return alert("è¯·å¡«å†™å¿…è¦å†…å®¹");
            const newItem = {
                id: 'custom_'+Date.now(), cat:'CUSTOM', en, zh,
                d: document.getElementById('in-d').value || 'æ— ',
                scene: {en: document.getElementById('in-scene').value || '', zh:''}
            };
            state.books[state.activeBookKey].items.push(newItem);
            save();
            alert(`æˆåŠŸåŠ å…¥ã€Š${state.activeBookKey}ã€‹`);
            ['in-en','in-zh','in-d','in-scene'].forEach(id=>document.getElementById(id).value='');
            updateDashboard();
        }

        function createNewBook() {
            const name = prompt("è¾“å…¥æ–°è¯ä¹¦åç§°:");
            if(name && !state.books[name]) {
                state.books[name] = { id:'bk_'+Date.now(), color:'from-slate-500 to-slate-800', goal:10, items:[] };
                save();
                renderBookshelf();
                renderGoalConfig();
            }
        }

        // --- UI Renders ---
        function renderBookshelf() {
            const list = document.getElementById('bookshelf-list');
            list.innerHTML = Object.keys(state.books).map(key => `
                <div onclick="selectBook('${key}')" class="book-cover relative aspect-[3/4] rounded-r-xl rounded-l-sm bg-gradient-to-br ${state.books[key].color} text-white p-4 flex flex-col justify-between cursor-pointer ${state.activeBookKey===key?'ring-4 ring-indigo-400':''}">
                    <div><p class="text-[8px] opacity-60 uppercase font-black tracking-widest">${state.books[key].items.length} è¯æ¡</p><h3 class="font-bold text-lg leading-tight serif mt-1">${key}</h3></div>
                    <span class="text-[9px] font-black">${state.activeBookKey===key?'SELECTED':'CLICK TO SELECT'}</span>
                </div>
            `).join('');
            document.getElementById('target-book-name').innerText = state.activeBookKey;
        }

        function renderGoalConfig() {
            const list = document.getElementById('goal-config-list');
            list.innerHTML = Object.keys(state.books).map(key => `
                <div class="flex justify-between items-center bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm">
                    <span class="text-xs font-black truncate max-w-[140px]">${key}</span>
                    <div class="flex items-center gap-2">
                        <input type="number" value="${state.books[key].goal}" onchange="updateGoal('${key}', this.value)" class="w-12 bg-slate-50 dark:bg-slate-800 border-none rounded-lg text-xs font-black p-1 text-center">
                        <span class="text-[10px] opacity-30">è¯/æ—¥</span>
                    </div>
                </div>
            `).join('');
        }

        function renderExplore() {
            const cats = ['all', ...new Set(RAW_LIB.map(i=>i.cat))];
            document.getElementById('explore-cats').innerHTML = cats.map(c => `<button onclick="state.filter='${c}';renderExplore()" class="text-xs font-black px-4 py-2 rounded-full ${state.filter===c?'bg-indigo-600 text-white':'bg-white dark:bg-slate-800 opacity-40'}">${c.toUpperCase()}</button>`).join('');
            const filtered = RAW_LIB.filter(i => state.filter==='all' || i.cat===state.filter);
            document.getElementById('explore-list').innerHTML = filtered.map(i => `
                <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] shadow-sm">
                    <p class="text-[9px] font-black text-indigo-500 mb-1 uppercase">${i.cat}</p>
                    <h4 class="text-lg font-bold">${i.en}</h4>
                    <p class="text-indigo-600 dark:text-indigo-400 serif mt-2">${i.zh}</p>
                </div>
            `).join('');
        }

        // --- System Functions ---
        function selectBook(k) { state.activeBookKey = k; renderBookshelf(); }
        function updateGoal(k, v) { state.books[k].goal = parseInt(v)||0; save(); }
        function save() {
            localStorage.setItem('lexi_v15_mem', JSON.stringify(state.mem));
            localStorage.setItem('lexi_v15_user', JSON.stringify(state.user));
            localStorage.setItem('lexi_v15_books', JSON.stringify(state.books));
            localStorage.setItem('lexi_v15_notes', JSON.stringify(state.notes));
        }
        function switchTab(t) {
            ['home','explore','learned','books','import'].forEach(v => document.getElementById('view-'+v)?.classList.add('hide'));
            document.getElementById('view-'+t).classList.remove('hide');
            document.querySelectorAll('nav button').forEach(b => b.classList.add('opacity-20'));
            document.getElementById('btn-'+t)?.classList.remove('opacity-20');
            document.getElementById('btn-'+t)?.classList.add('active-tab');
            if(t==='books') renderBookshelf();
            if(t==='explore') renderExplore();
        }
        function toggleDarkMode() {
            state.isDark = !state.isDark;
            document.body.classList.toggle('dark', state.isDark);
            localStorage.setItem('lexi_dark', state.isDark);
        }
        function toggleSidebar(s) { document.getElementById('settings-sidebar').classList.toggle('open', s); document.getElementById('settings-overlay').classList.toggle('hide', !s); }
        function updateQuote() { const q = QUOTES[new Date().getDate() % QUOTES.length]; document.getElementById('quote-en').innerText = `"${q.en}"`; document.getElementById('quote-zh').innerText = q.zh; }
        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateDashboard(); }
        function doLogin() { state.user = {phone:'13800000000', points:100}; save(); updateUserUI(); }
        function updateUserUI() { if(state.user) { document.getElementById('login-form').classList.add('hide'); document.getElementById('profile-data').classList.remove('hide'); } }

        init();
    </script>
</body>
</html>
