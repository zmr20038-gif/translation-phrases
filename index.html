<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LexiFlow MTI v12.1 Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #F8FAFC; --text: #1E293B; --card: #FFFFFF; --accent: #4F46E5; }
        .dark { --bg: #0F172A; --text: #F1F5F9; --card: #1E293B; --accent: #818CF8; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; transition: background 0.3s; }
        .serif { font-family: 'Noto Serif SC', serif; }
        
        /* ä¾§è¾¹æ å¹³æ»‘æŠ½å±‰ */
        #settings-sidebar { transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #settings-sidebar.open { transform: translateX(0); }

        /* å¡ç‰‡ç‰©ç†ç¿»è½¬ */
        .card-container { perspective: 1000px; width: 100%; height: 100%; position: relative; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 2.5rem; display: flex; flex-direction: column; padding: 2rem; background: var(--card); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); }
        .card-back { transform: rotateY(180deg); border: 2px solid var(--accent); overflow-y: auto; }

        .hide { display: none !important; }
        .active-tab { color: var(--accent) !important; opacity: 1 !important; font-weight: 800; border-bottom: 3px solid var(--accent); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* å¤é€‰æ¡†ç¾åŒ– */
        .checkbox-custom input:checked + div { background-color: #4F46E5; border-color: #4F46E5; }
        .checkbox-custom input:checked + div svg { display: block; }
    </style>
</head>
<body class="select-none min-h-screen pb-28">

    <header class="max-w-md mx-auto px-6 pt-10 pb-4 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-[900] tracking-tighter italic text-slate-800 dark:text-white">Lexi<span class="text-indigo-600">MTI</span></h1>
            <p class="text-[10px] font-black opacity-30 uppercase tracking-[0.2em] mt-1">Professional Revision</p>
        </div>
        <button onclick="toggleSidebar(true)" class="w-12 h-12 bg-white dark:bg-slate-800 rounded-full shadow-sm flex items-center justify-center text-xl active:scale-90 transition-transform">âš™ï¸</button>
    </header>

    <main id="view-home" class="max-w-md mx-auto px-6 space-y-6">
        <div class="grid grid-cols-2 gap-4">
            <div onclick="openStudy('new')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] shadow-sm border-b-4 border-indigo-100 dark:border-slate-700 active:scale-95 transition-all">
                <span class="text-[10px] font-black opacity-40 uppercase">New Words</span>
                <p id="num-new" class="text-4xl font-black mt-2 text-indigo-600">0</p>
                <p class="text-[10px] opacity-40 mt-1">éœ€å­¦ä¹ </p>
            </div>
            <div onclick="openStudy('review')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] shadow-sm border-b-4 border-emerald-100 dark:border-slate-700 active:scale-95 transition-all">
                <span class="text-[10px] font-black opacity-40 uppercase">Review</span>
                <p id="num-review" class="text-4xl font-black mt-2 text-emerald-500">0</p>
                <p class="text-[10px] opacity-40 mt-1">å¾…å¤ä¹ </p>
            </div>
        </div>

        <div onclick="switchTab('learned')" class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] shadow-sm flex justify-between items-center border border-slate-50 dark:border-slate-700 active:scale-95 transition-all">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 flex items-center justify-center text-xl">ğŸ“</div>
                <div>
                    <p class="text-sm font-bold">å·²æŒæ¡è¯æ¡åº“</p>
                    <p class="text-[10px] opacity-40 uppercase font-black">Archive</p>
                </div>
            </div>
            <p id="num-learned-dash" class="text-xl font-black text-slate-300 mr-2">0</p>
        </div>

        <div class="bg-gradient-to-br from-indigo-600 to-indigo-700 rounded-[2.5rem] p-8 text-white shadow-xl shadow-indigo-100 dark:shadow-none relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-16 -mt-16"></div>
            <p class="text-[10px] font-bold opacity-60 uppercase mb-4 tracking-widest">Daily Bilingual</p>
            <p class="text-lg font-bold font-serif leading-relaxed mb-4">"The limits of my language mean the limits of my world."</p>
            <p class="text-sm opacity-80 serif border-l-2 border-white/20 pl-4">â€œè¯­è¨€çš„è¾¹ç•Œï¼Œå³æ˜¯ä¸–ç•Œçš„è¾¹ç•Œã€‚â€</p>
        </div>
    </main>

    <main id="view-explore" class="max-w-md mx-auto px-6 hide">
        <div class="flex gap-4 mb-6 overflow-x-auto no-scrollbar pb-2">
            <button onclick="setFilter('all')" class="cat-btn text-xs font-bold pb-2 active-tab whitespace-nowrap">å…¨éƒ¨</button>
            <button onclick="setFilter('POL')" class="cat-btn text-xs font-bold pb-2 opacity-30 whitespace-nowrap">ğŸ›ï¸ æ”¿æ²»</button>
            <button onclick="setFilter('ECO')" class="cat-btn text-xs font-bold pb-2 opacity-30 whitespace-nowrap">ğŸ’° ç»è´¸</button>
            <button onclick="setFilter('TEC')" class="cat-btn text-xs font-bold pb-2 opacity-30 whitespace-nowrap">ğŸš€ ç§‘æŠ€</button>
            <button onclick="setFilter('CUL')" class="cat-btn text-xs font-bold pb-2 opacity-30 whitespace-nowrap">ğŸ® æ–‡åŒ–</button>
        </div>
        <div id="explore-list" class="space-y-4 pb-32"></div>
    </main>

    <main id="view-learned" class="max-w-md mx-auto px-6 hide">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black">è¯æ¡ç®¡ç†</h2>
            <button onclick="toggleEditMode()" id="btn-edit" class="text-xs font-bold bg-indigo-50 dark:bg-slate-800 text-indigo-600 px-5 py-2 rounded-full">æ‰¹é‡æ“ä½œ</button>
        </div>
        <div id="learned-list" class="space-y-3 pb-32"></div>
    </main>

    <section id="study-layer" class="fixed inset-0 bg-slate-50 dark:bg-slate-900 z-[200] hide flex flex-col">
        <div class="px-6 pt-12 flex justify-between items-center">
            <button onclick="closeStudy()" class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center shadow-sm">âœ•</button>
            <span id="study-progress" class="text-[10px] font-black opacity-30 tracking-widest uppercase italic">0 / 0</span>
            <button onclick="speakWord()" class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center shadow-sm">ğŸ”Š</button>
        </div>
        <div class="flex-1 p-6 flex items-center justify-center">
            <div class="card-container" id="studyCard">
                <div class="flip-card-inner" onclick="flipCard()">
                    <div class="card-face card-front items-center justify-center">
                        <span id="card-cat" class="text-[10px] font-black text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-3 py-1 rounded mb-6 tracking-widest">CATEGORY</span>
                        <h2 id="card-en" class="text-3xl font-bold text-center leading-tight">Word</h2>
                        <p class="mt-16 text-[10px] font-bold text-slate-300 animate-pulse uppercase tracking-widest">Tap to reveal</p>
                    </div>
                    <div class="card-face card-back items-start text-left">
                        <h3 id="card-zh" class="text-xl font-bold text-indigo-600 mb-3 serif">ä¸­æ–‡è¯‘æ–‡</h3>
                        <p id="card-d" class="text-xs text-slate-500 leading-relaxed mb-6 font-medium">é‡Šä¹‰åŠ è½½ä¸­...</p>
                        
                        <div class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl mb-4">
                            <p class="text-[9px] font-black opacity-30 uppercase mb-2 italic">Context / ä¾‹å¥</p>
                            <p id="card-scene-en" class="text-xs font-bold text-slate-700 dark:text-slate-200 mb-1 leading-snug">Example loading...</p>
                            <p id="card-scene-zh" class="text-[10px] text-slate-400 serif">ä¾‹å¥ç¿»è¯‘...</p>
                        </div>

                        <div class="w-full mt-auto pt-4 border-t border-slate-100 dark:border-slate-800" onclick="event.stopPropagation()">
                            <p class="text-[9px] font-black text-slate-400 uppercase mb-2">My Notes / å­¦ä¹ ç¬”è®°</p>
                            <textarea id="card-note" oninput="saveCurrentNote(this.value)" class="w-full bg-transparent text-xs h-20 outline-none resize-none placeholder:opacity-30" placeholder="è®°å½•å¯¹æ­¤è¯æ¡çš„ä¸ªäººç†è§£æˆ–è€ƒç‚¹..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-8 pb-14 bg-white dark:bg-slate-900 rounded-t-[3rem] shadow-2xl">
            <div class="grid grid-cols-3 gap-4">
                <button onclick="handleLearn(1)" class="py-5 bg-slate-50 dark:bg-slate-800 rounded-2xl font-black text-[10px] text-slate-400 active:scale-95 transition-all">ğŸ˜µ å¿˜äº†</button>
                <button onclick="handleLearn(2)" class="py-5 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl font-black text-[10px] text-indigo-400 active:scale-95 transition-all">ğŸ¤” æ¨¡ç³Š</button>
                <button onclick="handleLearn(3)" class="py-5 bg-indigo-600 rounded-2xl font-black text-[10px] text-white shadow-lg shadow-indigo-200 dark:shadow-none active:scale-95 transition-all">ğŸ˜ è®¤è¯†</button>
            </div>
        </div>
    </section>

    <div id="settings-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-[300] hide transition-opacity"></div>
    <aside id="settings-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-900 z-[301] shadow-2xl p-6 flex flex-col">
        <div id="user-panel" class="mb-10 p-6 bg-slate-50 dark:bg-slate-800 rounded-[2.5rem] border border-slate-100 dark:border-slate-700">
            <div id="login-form">
                <h3 class="font-black text-sm mb-4">ç”¨æˆ·ç™»å½•</h3>
                <input type="tel" id="login-phone" placeholder="è¾“å…¥æ‰‹æœºå·" class="w-full p-4 rounded-xl text-xs font-bold mb-3 border border-slate-200 dark:border-slate-600 dark:bg-slate-900 outline-none">
                <button onclick="doLogin()" class="w-full bg-indigo-600 text-white p-4 rounded-xl text-xs font-bold shadow-md">ç«‹å³è¿›å…¥</button>
            </div>
            <div id="profile-data" class="hide text-center">
                <div class="w-16 h-16 rounded-full bg-indigo-100 dark:bg-indigo-900 mx-auto mb-4 flex items-center justify-center text-3xl shadow-inner">ğŸ§‘â€ğŸ“</div>
                <p id="display-phone" class="font-black text-slate-700 dark:text-slate-200 text-lg tracking-tight mb-4">138****0000</p>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white dark:bg-slate-900 p-3 rounded-2xl shadow-sm">
                        <p class="text-[8px] opacity-40 uppercase font-black">å·²å­¦è¯æ•°</p>
                        <p id="stat-words" class="text-sm font-black text-indigo-600">0</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-3 rounded-2xl shadow-sm">
                        <p class="text-[8px] opacity-40 uppercase font-black">å½“å‰ç§¯åˆ†</p>
                        <p id="stat-points" class="text-sm font-black text-amber-500">0</p>
                    </div>
                </div>
                <button onclick="doLogout()" class="mt-6 text-[10px] text-red-400 font-bold opacity-60">é€€å‡ºå½“å‰è´¦å·</button>
            </div>
        </div>

        <div class="space-y-8 px-2 flex-1">
            <div>
                <div class="flex justify-between items-center text-xs font-black mb-4">
                    <span class="opacity-40 uppercase tracking-widest">Daily Goal</span>
                    <span id="goal-val" class="text-indigo-600 font-mono">10</span>
                </div>
                <input type="range" min="5" max="50" step="5" value="10" oninput="updateGoal(this.value)" class="w-full h-1.5 bg-slate-100 dark:bg-slate-700 appearance-none accent-indigo-600 rounded-full">
            </div>
            <button onclick="toggleDarkMode()" class="w-full p-5 bg-slate-50 dark:bg-slate-800 rounded-2xl flex justify-between items-center font-bold text-xs active:scale-95 transition-all">
                <span>å¤œé—´æ¨¡å¼</span><span id="mode-icon">ğŸŒ™</span>
            </button>
        </div>
    </aside>

    <div id="batch-bar" class="fixed bottom-28 left-6 right-6 bg-white dark:bg-slate-800 shadow-2xl rounded-[1.5rem] p-4 flex justify-between items-center border border-slate-100 dark:border-slate-700 hide z-[50] animate-bounce-in">
        <span class="text-xs font-black ml-4">å·²é€‰ <span id="selected-count" class="text-indigo-600 font-mono">0</span></span>
        <button onclick="moveToTrash()" class="bg-red-50 dark:bg-red-900/20 text-red-500 px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">Mastered (Archive)</button>
    </div>

    <nav class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl rounded-full shadow-2xl flex items-center px-10 py-3 gap-16 border border-white/20 z-[100]">
        <button onclick="switchTab('home')" id="btn-home" class="text-2xl active-tab transition-all">ğŸ </button>
        <button onclick="switchTab('explore')" id="btn-explore" class="text-2xl opacity-20 transition-all">ğŸ”</button>
    </nav>

    <script>
        const RAW_LIB = [
            { id:'1', cat:'POL', en:'New quality productive forces', zh:'æ–°è´¨ç”Ÿäº§åŠ›', d:'ä»¥åˆ›æ–°èµ·ä¸»å¯¼ä½œç”¨ï¼Œå…·æœ‰é«˜ç§‘æŠ€ã€é«˜æ•ˆèƒ½ã€é«˜è´¨é‡ç‰¹å¾ã€‚', scene: {en: "Innovation drives the development of new quality productive forces.", zh: "åˆ›æ–°é©±åŠ¨æ–°è´¨ç”Ÿäº§åŠ›çš„å‘å±•ã€‚"} },
            { id:'2', cat:'POL', en:'Chinese path to modernization', zh:'ä¸­å›½å¼ç°ä»£åŒ–', d:'å…·æœ‰äº”å¤§ç‰¹å¾ï¼Œæœ¬è´¨è¦æ±‚æ˜¯åšæŒä¸­å›½å…±äº§å…šé¢†å¯¼ã€‚', scene: {en: "We must stay committed to the Chinese path to modernization.", zh: "æˆ‘ä»¬å¿…é¡»åšæŒèµ°ä¸­å›½å¼ç°ä»£åŒ–é“è·¯ã€‚"} },
            { id:'3', cat:'ECO', en:'Supply-side structural reform', zh:'ä¾›ç»™ä¾§ç»“æ„æ€§æ”¹é©', d:'é€šè¿‡ä¼˜åŒ–è¦ç´ é…ç½®ï¼Œæé«˜å…¨è¦ç´ ç”Ÿäº§ç‡ã€‚', scene: {en: "Supply-side structural reform remains a priority.", zh: "ä¾›ç»™ä¾§ç»“æ„æ€§æ”¹é©ä»æ˜¯å·¥ä½œçš„é‡ç‚¹ã€‚"} },
            { id:'4', cat:'TEC', en:'Quantum Entanglement', zh:'é‡å­çº ç¼ ', d:'é‡å­åŠ›å­¦ä¸­ä¸€ç§å¥‡ç‰¹çš„ç›¸äº’å…³è”ç°è±¡ã€‚', scene: {en: "Quantum entanglement is the key to quantum communication.", zh: "é‡å­çº ç¼ æ˜¯é‡å­é€šä¿¡çš„å…³é”®ã€‚"} },
            { id:'5', cat:'CUL', en:'Intangible cultural heritage', zh:'éç‰©è´¨æ–‡åŒ–é—äº§', d:'æŒ‡å„æ°‘æ—ä¸–ä»£ç›¸ä¼ çš„å„ç§ä¼ ç»Ÿæ–‡åŒ–è¡¨ç°å½¢å¼ã€‚', scene: {en: "Protection of intangible cultural heritage is vital.", zh: "ä¿æŠ¤éç‰©è´¨æ–‡åŒ–é—äº§è‡³å…³é‡è¦ã€‚"} }
        ].sort((a,b) => a.en.localeCompare(b.en));

        let state = {
            mem: JSON.parse(localStorage.getItem('lexi_v12_mem') || '{}'),
            user: JSON.parse(localStorage.getItem('lexi_v12_user') || 'null'),
            notes: JSON.parse(localStorage.getItem('lexi_v12_notes') || '{}'),
            goal: 10, filter: 'all', queue: [], idx: 0, editMode: false, selectedItems: new Set()
        };

        function init() {
            if(localStorage.getItem('lexi_dark') === 'true') document.body.classList.add('dark');
            updateDashboard();
            updateUserUI();
        }

        // --- Core Stats ---
        function updateDashboard() {
            const now = Date.now();
            const news = RAW_LIB.filter(i => (!state.mem[i.id] || state.mem[i.id].lv === 0)).length;
            const reviews = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && state.mem[i.id].lv < 99 && now >= state.mem[i.id].next).length;
            const learned = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && state.mem[i.id].lv < 99).length;
            
            document.getElementById('num-new').innerText = news;
            document.getElementById('num-review').innerText = reviews;
            document.getElementById('num-learned-dash').innerText = learned;
        }

        // --- Study Engine ---
        function openStudy(mode) {
            const now = Date.now();
            if(mode === 'new') {
                state.queue = RAW_LIB.filter(i => !state.mem[i.id] || state.mem[i.id].lv === 0).slice(0, state.goal);
            } else {
                state.queue = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && state.mem[i.id].lv < 99 && now >= state.mem[i.id].next);
            }
            if(!state.queue.length) return alert(mode==='new'?"ä»Šæ—¥æ–°è¯å·²å…¨éƒ¨å­¦å®Œï¼":"æš‚æ— éœ€è¦å¤ä¹ çš„è¯æ¡ã€‚");
            state.idx = 0;
            document.getElementById('study-layer').classList.remove('hide');
            renderCard();
        }

        function renderCard() {
            const item = state.queue[state.idx];
            document.getElementById('studyCard').classList.remove('flipped');
            document.getElementById('card-cat').innerText = item.cat;
            document.getElementById('card-en').innerText = item.en;
            document.getElementById('card-zh').innerText = item.zh;
            document.getElementById('card-d').innerText = item.d;
            document.getElementById('card-scene-en').innerText = item.scene.en;
            document.getElementById('card-scene-zh').innerText = item.scene.zh;
            document.getElementById('card-note').value = state.notes[item.id] || '';
            document.getElementById('study-progress').innerText = `${state.idx + 1} / ${state.queue.length}`;
        }

        function handleLearn(score) {
            const item = state.queue[state.idx];
            if(!state.mem[item.id]) state.mem[item.id] = { lv: 0, next: 0 };
            const m = state.mem[item.id];
            
            if(score === 3) m.lv += 1;
            else if(score === 1) m.lv = 1;
            
            // è‰¾å®¾æµ©æ–¯å•ä½ï¼šåˆ†é’Ÿ [ç«‹å³, 1å¤©å, 3å¤©å, 7å¤©å]
            const intervals = [0, 1, 1440, 4320, 10080]; 
            m.next = Date.now() + (intervals[Math.min(m.lv, 4)] * 60000);
            
            if(state.user && score > 1) state.user.points += 10;
            saveAll();
            
            state.idx++;
            if(state.idx < state.queue.length) renderCard();
            else closeStudy();
        }

        // --- Explore System ---
        function setFilter(cat) { 
            state.filter = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active-tab'));
            event.target.classList.add('active-tab');
            renderExplore();
        }

        function renderExplore() {
            const container = document.getElementById('explore-list');
            const filtered = RAW_LIB.filter(i => state.filter === 'all' || i.cat === state.filter);
            container.innerHTML = filtered.map(i => `
                <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-6 shadow-sm">
                    <div class="flex justify-between items-start" onclick="toggleDetail('${i.id}')">
                        <div>
                            <span class="text-[9px] font-black text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded uppercase">${i.cat}</span>
                            <h4 class="font-bold text-lg mt-2">${i.en}</h4>
                        </div>
                        <span class="text-indigo-500 text-xl">${state.mem[i.id]?.lv > 0 ? 'âœ“' : '+'}</span>
                    </div>
                    <div id="detail-${i.id}" class="hide mt-6 pt-6 border-t border-slate-50 dark:border-slate-700">
                        <p class="text-indigo-600 dark:text-indigo-400 font-bold serif mb-3 text-sm">${i.zh}</p>
                        <p class="text-xs text-slate-500 mb-6 leading-relaxed">${i.d}</p>
                        <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl mb-6">
                            <p class="text-[9px] font-black opacity-30 uppercase mb-2">Context</p>
                            <p class="text-xs font-bold mb-1">${i.scene.en}</p>
                            <p class="text-[10px] text-slate-400 serif">${i.scene.zh}</p>
                        </div>
                        <textarea oninput="saveNote('${i.id}', this.value)" class="w-full bg-slate-50 dark:bg-slate-900 p-4 rounded-xl text-xs outline-none h-24 border border-transparent focus:border-indigo-100 transition-all" placeholder="ç‚¹å‡»è®°ç¬”è®°...">${state.notes[i.id] || ''}</textarea>
                    </div>
                </div>
            `).join('');
        }

        // --- Archive Logic ---
        function renderLearned() {
            const list = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && state.mem[i.id].lv < 99);
            const container = document.getElementById('learned-list');
            if(!list.length) { container.innerHTML = '<div class="text-center py-20 opacity-20 font-bold">ç©ºç©ºå¦‚ä¹Ÿ</div>'; return; }
            container.innerHTML = list.map(i => `
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl flex items-center gap-4">
                    <label class="checkbox-custom ${state.editMode?'':'hide'} relative">
                        <input type="checkbox" class="hidden" onchange="toggleSelect('${i.id}')" ${state.selectedItems.has(i.id)?'checked':''}>
                        <div class="w-6 h-6 rounded-full border-2 border-slate-200 dark:border-slate-600 flex items-center justify-center transition-colors">
                            <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                    </label>
                    <div class="truncate flex-1">
                        <p class="font-bold text-sm mb-0.5">${i.en}</p>
                        <p class="text-[10px] opacity-40 serif">${i.zh}</p>
                    </div>
                </div>
            `).join('');
        }

        // --- Auth & Profile ---
        function doLogin() {
            const phone = document.getElementById('login-phone').value;
            if(!/^1[3-9]\d{9}$/.test(phone)) return alert("è¯·è¾“å…¥åˆæ³•çš„æ‰‹æœºå·");
            state.user = { phone, points: 0 };
            saveAll(); updateUserUI();
        }
        function doLogout() { if(confirm("ç¡®å®šé€€å‡ºç™»å½•ï¼Ÿ")) { state.user = null; saveAll(); updateUserUI(); } }
        function updateUserUI() {
            const isL = !!state.user;
            document.getElementById('login-form').classList.toggle('hide', isL);
            document.getElementById('profile-data').classList.toggle('hide', !isL);
            if(isL) {
                document.getElementById('display-phone').innerText = state.user.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
                document.getElementById('stat-points').innerText = state.user.points;
                document.getElementById('stat-words').innerText = Object.values(state.mem).filter(x=>x.lv>0&&x.lv<99).length;
            }
        }

        // --- Utils ---
        function flipCard() { document.getElementById('studyCard').classList.toggle('flipped'); }
        function switchTab(tab) {
            ['home', 'explore', 'learned'].forEach(t => document.getElementById('view-'+t)?.classList.add('hide'));
            document.getElementById('view-'+tab).classList.remove('hide');
            document.getElementById('btn-home').className = tab==='home'?'text-2xl active-tab':'text-2xl opacity-20';
            document.getElementById('btn-explore').className = tab==='explore'?'text-2xl active-tab':'text-2xl opacity-20';
            if(tab === 'explore') renderExplore();
            if(tab === 'learned') renderLearned();
        }
        function saveNote(id, v) { state.notes[id] = v; localStorage.setItem('lexi_v12_notes', JSON.stringify(state.notes)); }
        function saveCurrentNote(v) { saveNote(state.queue[state.idx].id, v); }
        function saveAll() {
            localStorage.setItem('lexi_v12_mem', JSON.stringify(state.mem));
            localStorage.setItem('lexi_v12_user', JSON.stringify(state.user));
            updateDashboard();
        }
        function toggleSidebar(s) { document.getElementById('settings-sidebar').classList.toggle('open', s); document.getElementById('settings-overlay').classList.toggle('hide', !s); }
        function toggleDarkMode() { document.body.classList.toggle('dark'); localStorage.setItem('lexi_dark', document.body.classList.contains('dark')); }
        function toggleDetail(id) { document.getElementById('detail-'+id).classList.toggle('hide'); }
        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateDashboard(); }
        function toggleEditMode() { 
            state.editMode = !state.editMode; 
            document.getElementById('batch-bar').classList.toggle('hide', !state.editMode);
            renderLearned(); 
        }
        function toggleSelect(id) {
            state.selectedItems.has(id) ? state.selectedItems.delete(id) : state.selectedItems.add(id);
            document.getElementById('selected-count').innerText = state.selectedItems.size;
        }
        function moveToTrash() {
            if(state.selectedItems.size === 0) return;
            state.selectedItems.forEach(id => { if(state.mem[id]) state.mem[id].lv = 99; });
            saveAll(); state.selectedItems.clear(); toggleEditMode();
            alert("é€‰å®šè¯æ¡å·²ç§»å…¥å½’æ¡£ï¼ˆå°†ä¸å†å¤ä¹ ï¼‰");
        }
        function speakWord() { window.speechSynthesis.speak(new SpeechSynthesisUtterance(state.queue[state.idx].en)); }
        function updateGoal(v) { state.goal = v; document.getElementById('goal-val').innerText = v; }

        init();
    </script>
</body>
</html>
