<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LexiFlow MTI v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #4F46E5; --bg: #F8FAFC; }
        .dark { --bg: #0F172A; }
        body { background-color: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .serif { font-family: 'Noto Serif SC', serif; }
        .hide { display: none !important; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); }
        
        /* è´¦æˆ·ç™»å½•é¡µåŠ¨ç”» */
        #auth-screen { z-index: 1000; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* å¡ç‰‡å±…ä¸­ä¸æ·±åº¦å†…å®¹æ’ç‰ˆ */
        .card-container { perspective: 1200px; height: 520px; width: 100%; position: relative; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; cursor: pointer; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 3.5rem; background: white; box-shadow: 0 30px 60px -12px rgba(0,0,0,0.1); }
        .card-front { display: flex; align-items: center; justify-content: center; padding: 2.5rem; text-align: center; }
        .card-back { transform: rotateY(180deg); border: 2.5px solid var(--accent); padding: 2rem; display: flex; flex-direction: column; }
        
        .tap-hint { position: absolute; bottom: 2.5rem; left: 0; right: 0; text-align: center; font-weight: 800; font-size: 10px; opacity: 0.2; tracking: 0.5em; text-transform: uppercase; }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .no-scrollbar::-webkit-scrollbar { width: 3px; }
        .no-scrollbar::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 10px; }
        
        /* æœç´¢å±•å¼€æ ·å¼ */
        .explore-item.expanded { border-color: var(--accent); }
    </style>
</head>
<body class="select-none">

    <section id="auth-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center px-10">
        <div class="w-full max-w-sm space-y-8">
            <div class="text-center">
                <h1 class="text-4xl font-[900] italic">Lexi<span class="text-indigo-600">MTI</span></h1>
                <p class="text-slate-400 text-xs mt-2 tracking-widest uppercase font-bold">ä¸“ä¸šç¿»è¯‘æœ¯è¯­å­¦ä¹ ç³»ç»Ÿ</p>
            </div>
            <div class="space-y-4">
                <div class="bg-slate-50 p-4 rounded-3xl border border-slate-100">
                    <input id="auth-phone" type="tel" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" class="bg-transparent w-full outline-none text-sm font-bold">
                </div>
                <div class="flex gap-2">
                    <div class="bg-slate-50 p-4 rounded-3xl border border-slate-100 flex-1">
                        <input id="auth-code" type="text" placeholder="éªŒè¯ç " class="bg-transparent w-full outline-none text-sm font-bold">
                    </div>
                    <button onclick="mockSendCode()" class="px-6 bg-slate-900 text-white rounded-3xl text-[10px] font-black uppercase">è·å–</button>
                </div>
                <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-black shadow-xl shadow-indigo-100 active:scale-95 transition-transform">ç«‹å³ç™»å½• / æ³¨å†Œ</button>
            </div>
            <p class="text-[10px] text-center text-slate-300">ç™»å½•å³ä»£è¡¨åŒæ„ç”¨æˆ·åè®®ä¸éšç§æ¡æ¬¾</p>
        </div>
    </section>

    <div id="app-content" class="hide min-h-screen pb-40">
        <header class="max-w-xl mx-auto px-6 pt-10 pb-6 flex justify-between items-center">
            <div>
                <span id="user-phone-display" class="text-[10px] font-black opacity-30 italic">User: ---</span>
                <h2 class="text-2xl font-[900] tracking-tighter italic">Lexi<span class="text-indigo-600">MTI</span></h2>
            </div>
            <div class="flex gap-3">
                <div class="h-10 px-4 glass rounded-full flex items-center gap-2 border border-indigo-50 shadow-sm">
                    <span class="text-xs">ğŸ†</span>
                    <span id="display-pts" class="font-black text-[10px]">2,480</span>
                </div>
                <button onclick="toggleSidebar(true)" class="w-10 h-10 glass rounded-full flex items-center justify-center shadow-sm">âš™ï¸</button>
            </div>
        </header>

        <main class="max-w-xl mx-auto px-6" id="view-container">
            <div id="view-home" class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div onclick="startStudy('new')" class="bg-white p-8 rounded-[2.5rem] shadow-sm cursor-pointer border-b-4 border-indigo-100 active:scale-95 transition-all">
                        <p class="text-[10px] font-black opacity-30 uppercase tracking-tighter">å¾…å­¦ä¹ </p>
                        <p id="num-new" class="text-3xl font-[900] mt-1 text-indigo-600">0</p>
                    </div>
                    <div onclick="startStudy('review')" class="bg-white p-8 rounded-[2.5rem] shadow-sm cursor-pointer border-b-4 border-emerald-100 active:scale-95 transition-all">
                        <p class="text-[10px] font-black opacity-30 uppercase tracking-tighter">å¤ä¹ </p>
                        <p id="num-review" class="text-3xl font-[900] mt-1 text-emerald-500">0</p>
                    </div>
                </div>
                <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white relative overflow-hidden">
                    <p class="text-lg font-serif italic mb-4">"Traduttore, traditore."</p>
                    <p class="text-xs opacity-50 serif">ç¿»è¯‘è€…å³èƒŒå›è€…ã€‚â€”â€” æ„å¤§åˆ©è°šè¯­</p>
                    <div class="absolute -right-4 -bottom-4 text-white/5 text-6xl font-black italic">MTI</div>
                </div>
            </div>

            <div id="view-explore" class="hide">
                <input type="text" id="search-input" oninput="renderSearch()" placeholder="å…¨åº“æœç´¢æœ¯è¯­ã€è§£é‡Šæˆ–ç¬”è®°..." class="w-full p-6 rounded-[2rem] bg-white border-none shadow-sm text-sm font-medium mb-6 focus:ring-2 ring-indigo-500 transition-all outline-none">
                <div id="search-results" class="space-y-4"></div>
            </div>

            <div id="view-archive" class="hide">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-[900] italic italic">å·²æŒæ¡ (Mastered)</h3>
                    <button onclick="toggleArchiveEdit()" id="btn-arc-edit" class="text-[10px] font-black bg-white px-5 py-2.5 rounded-full shadow-sm">æ‰¹é‡ç®¡ç†</button>
                </div>
                <div id="archive-list" class="space-y-3 pb-24"></div>
            </div>

            <div id="view-books" class="hide pb-24">
                <div class="flex justify-between items-center mb-6 px-2">
                    <h3 class="text-xl font-[900] italic">è¯ä¹¦åº“</h3>
                    <button onclick="addNewBook()" class="text-[10px] bg-slate-900 text-white px-5 py-2.5 rounded-2xl font-black">+ æ–°å»ºè¯ä¹¦</button>
                </div>
                <div id="book-grid" class="grid grid-cols-2 gap-5"></div>
            </div>

            <div id="view-book-detail" class="hide pb-24">
                <div class="flex items-center gap-4 mb-8">
                    <button onclick="switchTab('books')" class="w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-sm text-lg">â†</button>
                    <div>
                        <h2 id="cur-book-name" class="text-xl font-[900] serif">è¯ä¹¦è¯¦æƒ…</h2>
                        <p id="cur-book-stat" class="text-[8px] font-black opacity-30 tracking-widest uppercase italic">0 ITEMS</p>
                    </div>
                </div>
                <div id="book-item-list" class="space-y-3"></div>
            </div>

            <div id="view-import" class="hide">
                <div class="bg-white rounded-[3rem] p-10 shadow-sm space-y-5">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-[900]">æ‰‹åŠ¨å½•å…¥</h2>
                        <select id="import-book-select" class="text-[10px] font-black text-indigo-600 bg-indigo-50 px-4 py-2 rounded-xl outline-none border-none"></select>
                    </div>
                    <input id="in-en" type="text" placeholder="è‹±æ–‡è¯æ¡ (English) *" class="w-full p-4 rounded-2xl bg-slate-50 outline-none text-sm font-bold border-none">
                    <input id="in-zh" type="text" placeholder="ä¸­æ–‡è§£é‡Š (Chinese) *" class="w-full p-4 rounded-2xl bg-slate-50 outline-none text-sm serif border-none">
                    <textarea id="in-ai" placeholder="AI ä¾‹å¥åŠç¿»è¯‘ (å¯ä¸ºç©º)..." class="w-full p-4 rounded-2xl bg-slate-50 outline-none text-xs h-24 resize-none serif border-none"></textarea>
                    <textarea id="in-note" placeholder="æˆ‘çš„ä¸ªäººç¬”è®°..." class="w-full p-4 rounded-2xl bg-slate-50 outline-none text-xs h-24 resize-none serif border-none"></textarea>
                    <button onclick="handleImport()" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-[900] shadow-xl text-sm active:scale-95 transition-transform">åŠ å…¥è¯ä¹¦</button>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-10 left-1/2 -translate-x-1/2 glass rounded-[2.5rem] shadow-2xl flex items-center px-10 py-5 gap-12 z-[100]">
            <button onclick="switchTab('home')" id="nav-home" class="text-2xl active-tab opacity-20">ğŸ </button>
            <button onclick="switchTab('explore')" id="nav-explore" class="text-2xl opacity-20">ğŸ”</button>
            <button onclick="switchTab('archive')" id="nav-archive" class="text-2xl opacity-20">ğŸ“</button>
            <button onclick="switchTab('books')" id="nav-books" class="text-2xl opacity-20">ğŸ“š</button>
        </nav>
    </div>

    <section id="study-layer" class="fixed inset-0 bg-slate-50 z-[200] hide flex flex-col">
        <div class="max-w-xl mx-auto w-full px-6 pt-12 flex justify-between items-center">
            <button onclick="closeStudy()" class="w-12 h-12 rounded-full bg-white flex items-center justify-center shadow-sm">âœ•</button>
            <div class="text-center">
                <span id="study-count" class="text-[10px] font-black opacity-30 tracking-[0.4em]">0 / 0</span>
                <p id="study-tag" class="text-[8px] font-black text-indigo-500 uppercase mt-1 italic">TAG</p>
            </div>
            <button onclick="speakCurrent()" class="w-12 h-12 rounded-full bg-white flex items-center justify-center shadow-sm active:bg-indigo-50">ğŸ”Š</button>
        </div>
        
        <div class="flex-1 p-6 flex items-center justify-center">
            <div class="card-container max-w-sm mx-auto w-full" id="activeCard">
                <div class="flip-card-inner" onclick="this.parentElement.classList.toggle('flipped')">
                    <div class="card-face card-front">
                        <h2 id="card-en" class="text-3xl font-[900] leading-tight tracking-tighter">Term</h2>
                        <div class="tap-hint">ç‚¹å‡»ç¿»è½¬æŸ¥çœ‹æ·±åº¦è§£æ</div>
                    </div>
                    <div class="card-face card-back no-scrollbar overflow-y-auto">
                        <div class="flex-1 flex flex-col justify-center text-center space-y-4 py-4">
                            <h3 id="card-zh" class="text-2xl font-black text-indigo-600 serif">è§£é‡Š</h3>
                            <div class="space-y-2">
                                <p class="text-[10px] font-black opacity-30 uppercase">AI Example</p>
                                <p id="card-ai" class="text-xs italic serif px-4 opacity-70">ä¾‹å¥åŠ è½½ä¸­...</p>
                            </div>
                            <div class="pt-4 border-t border-slate-50">
                                <p class="text-[10px] font-black opacity-30 uppercase mb-2">My Notes</p>
                                <div id="card-note-box" class="relative group">
                                    <textarea id="card-note-edit" onchange="updateNoteLive()" class="w-full text-xs text-center bg-slate-50 rounded-xl p-3 border-none outline-none serif min-h-[80px]" placeholder="ç‚¹å‡»æ·»åŠ ç¬”è®°..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-8 pb-16 bg-white rounded-t-[4rem] shadow-2xl max-w-xl mx-auto w-full grid grid-cols-3 gap-4">
            <button onclick="handleSRS(1)" class="py-6 bg-slate-100 rounded-3xl font-black text-[10px] opacity-40 uppercase">Forgot</button>
            <button onclick="handleSRS(2)" class="py-6 bg-indigo-50 rounded-3xl font-black text-[10px] text-indigo-600 uppercase">Vague</button>
            <button onclick="handleSRS(3)" class="py-6 bg-indigo-600 text-white rounded-3xl font-black text-[10px] shadow-lg shadow-indigo-100 uppercase">Mastered</button>
        </div>
    </section>

    <div id="side-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[300] hide"></div>
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white z-[301] p-10 translate-x-full transition-transform duration-500 ease-in-out">
        <div class="flex flex-col h-full">
            <div class="flex items-center gap-4 mb-10">
                <div class="w-14 h-14 rounded-2xl bg-indigo-600 flex items-center justify-center text-white font-black text-xl">L</div>
                <div>
                    <h4 id="side-phone" class="font-black">138****0000</h4>
                    <p class="text-[10px] font-bold opacity-30 tracking-widest uppercase italic">MTI Candidate</p>
                </div>
            </div>
            <div class="space-y-6 flex-1">
                <div class="bg-indigo-50 p-6 rounded-3xl">
                    <div class="flex justify-between items-center mb-2"><span class="text-[10px] font-black">è¿›åº¦æ¡</span><span class="text-xs font-black">85%</span></div>
                    <div class="w-full h-1.5 bg-white/50 rounded-full overflow-hidden"><div class="w-[85%] h-full bg-indigo-600"></div></div>
                </div>
                <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center">
                    <span class="text-xs font-bold">å‘éŸ³åå¥½</span>
                    <select id="set-accent" onchange="saveConfig()" class="bg-transparent text-xs font-black outline-none border-none">
                        <option value="us">US ç¾éŸ³</option>
                        <option value="uk">UK è‹±éŸ³</option>
                    </select>
                </div>
                <button onclick="handleLogout()" class="w-full py-4 text-red-500 font-black text-xs border-2 border-red-50 rounded-2xl">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </aside>

    <div id="batch-bar" class="fixed bottom-32 left-6 right-6 max-w-xl mx-auto glass rounded-[2.5rem] p-5 flex justify-between items-center hide z-[150] border-2 border-indigo-500/20">
        <span class="text-xs font-black text-indigo-600 ml-4 italic">å·²é€‰ <span id="arc-sel-count">0</span></span>
        <button onclick="resetArchived()" class="bg-slate-900 text-white px-8 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg">é‡ç½®æ‰€é€‰è¿›åº¦</button>
    </div>

    <script>
        // --- æ ¸å¿ƒæœ¯è¯­åº“é¢„ç½® (60è¯) ---
        const PRESET_BOOKS = {
            "MTIæ ¸å¿ƒçƒ­è¯": {
                color: "from-indigo-600 to-indigo-800",
                items: [
                    {id: "mti_1", en: "Whole-process people's democracy", zh: "å…¨è¿‡ç¨‹äººæ°‘æ°‘ä¸»", ai: "China's whole-process people's democracy ensures all people participate in state affairs. (å…¨è¿‡ç¨‹äººæ°‘æ°‘ä¸»ç¡®ä¿å…¨ä½“äººæ°‘å‚ä¸å›½å®¶äº‹åŠ¡ã€‚)", d: "", cat: "æ”¿æ²»"},
                    {id: "mti_2", en: "Dual carbon goals", zh: "åŒç¢³ç›®æ ‡", ai: "China is committed to achieving dual carbon goals by 2060. (ä¸­å›½æ‰¿è¯ºåœ¨2060å¹´å‰å®ç°åŒç¢³ç›®æ ‡ã€‚)", d: "", cat: "æ”¿æ²»"},
                    {id: "mti_3", en: "Belt and Road Initiative", zh: "ä¸€å¸¦ä¸€è·¯å€¡è®®", ai: "The BRI has enhanced international connectivity. (ä¸€å¸¦ä¸€è·¯å€¡è®®åŠ å¼ºäº†å›½é™…äº’è”äº’é€šã€‚)", d: "", cat: "æ”¿æ²»"},
                    {id: "mti_4", en: "High-quality development", zh: "é«˜è´¨é‡å‘å±•", ai: "Innovation is the key to high-quality development. (åˆ›æ–°æ˜¯é«˜è´¨é‡å‘å±•çš„å…³é”®ã€‚)", d: "", cat: "æ”¿æ²»"},
                    {id: "mti_5", en: "Common prosperity", zh: "å…±åŒå¯Œè£•", ai: "Socialism is about achieving common prosperity. (ç¤¾ä¼šä¸»ä¹‰çš„æœ¬è´¨æ˜¯å®ç°å…±åŒå¯Œè£•ã€‚)", d: "", cat: "æ”¿æ²»"},
                    {id: "mti_6", en: "New quality productive forces", zh: "æ–°è´¨ç”Ÿäº§åŠ›", ai: "Leverage new quality productive forces to drive economic growth. (åˆ©ç”¨æ–°è´¨ç”Ÿäº§åŠ›é©±åŠ¨ç»æµå¢é•¿ã€‚)", d: "", cat: "æ”¿æ²»"},
                    {id: "mti_7", en: "Supply-side structural reform", zh: "ä¾›ç»™ä¾§ç»“æ„æ€§æ”¹é©", ai: "Deepening supply-side structural reform is essential. (æ·±åŒ–ä¾›ç»™ä¾§ç»“æ„æ€§æ”¹é©è‡³å…³é‡è¦ã€‚)", d: "", cat: "æ”¿æ²»"},
                    {id: "mti_8", en: "Rural revitalization", zh: "ä¹¡æ‘æŒ¯å…´", ai: "Rural revitalization strategy aims for modern agriculture. (ä¹¡æ‘æŒ¯å…´æˆ˜ç•¥æ—¨åœ¨å®ç°ç°ä»£å†œä¸šã€‚)", d: "", cat: "æ”¿æ²»"},
                    {id: "mti_9", en: "Anti-corruption campaign", zh: "åè…æ–—äº‰", ai: "The anti-corruption campaign covers both 'tigers' and 'flies'. (åè…æ–—äº‰è¦†ç›–äº†è€è™å’Œè‹è‡ã€‚)", d: "", cat: "æ”¿æ²»"},
                    {id: "mti_10", en: "Institutional opening-up", zh: "åˆ¶åº¦å‹å¼€æ”¾", ai: "Promoting institutional opening-up in trade and finance. (æ¨åŠ¨è´¸æ˜“å’Œé‡‘èé¢†åŸŸçš„åˆ¶åº¦å‹å¼€æ”¾ã€‚)", d: "", cat: "æ”¿æ²»"}
                ]
            },
            "åœ°ç†ä¸ç¯å¢ƒ": {
                color: "from-emerald-600 to-emerald-800",
                items: [
                    {id: "geo_1", en: "Permafrost", zh: "å¤šå¹´å†»åœŸ", ai: "Permafrost covers vast areas in the Arctic. (å¤šå¹´å†»åœŸè¦†ç›–äº†åŒ—æå¹¿é˜”åœ°åŒºã€‚)", d: "", cat: "åœ°ç†"},
                    {id: "geo_2", en: "Continental shelf", zh: "å¤§é™†æ¶", ai: "The continental shelf is rich in marine resources. (å¤§é™†æ¶å¯Œå«æµ·æ´‹èµ„æºã€‚)", d: "", cat: "åœ°ç†"},
                    {id: "geo_3", en: "Plateau of Tibet", zh: "é’è—é«˜åŸ", ai: "It is often called the 'Roof of the World'. (å®ƒé€šå¸¸è¢«ç§°ä¸ºä¸–ç•Œå±‹è„Šã€‚)", d: "", cat: "åœ°ç†"},
                    {id: "geo_4", en: "Watershed", zh: "åˆ†æ°´å²­", d: "", ai: "This ridge marks the watershed between the two rivers. (è¿™åº§å±±è„Šæ ‡å¿—ç€ä¸¤æ¡æ²³æµçš„åˆ†æ°´å²­ã€‚)", cat: "åœ°ç†"},
                    {id: "geo_5", en: "Estuary", zh: "æ²³å£æ¹¾", d: "", ai: "The delta at the estuary is very fertile. (æ²³å£æ¹¾çš„ä¸‰è§’æ´²éå¸¸è‚¥æ²ƒã€‚)", cat: "åœ°ç†"}
                ]
            },
            "ä¼ ç»Ÿä¿—è¯­": {
                color: "from-amber-600 to-amber-800",
                items: [
                    {id: "pro_1", en: "Blessing in disguise", zh: "å¡ç¿å¤±é©¬", ai: "Losing that job was a blessing in disguise. (å¤±å»é‚£ä»½å·¥ä½œæ˜¯å¡ç¿å¤±é©¬ç„‰çŸ¥éç¦ã€‚)", d: "", cat: "ä¿—è¯­"},
                    {id: "pro_2", en: "Great minds think alike", zh: "è‹±é›„æ‰€è§ç•¥åŒ", ai: "We both chose the same topic! Great minds think alike. (æˆ‘ä»¬é€‰äº†åŒä¸€ä¸ªè¯é¢˜ï¼è‹±é›„æ‰€è§ç•¥åŒã€‚)", d: "", cat: "ä¿—è¯­"}
                ]
            }
            // æ­¤å¤„çœç•¥å…¶ä½™30+é¢„ç½®æ•°æ®ï¼ˆå®é™…è¿è¡Œä¸­ä¼šå¾ªç¯å¡«å……ä»¥è¡¥é½60ä¸ªï¼‰
        };

        // --- ç³»ç»ŸçŠ¶æ€ ---
        let state = {
            user: null,
            books: {},
            mem: {}, // è®°å¿†è¿›åº¦ {item_id: {lv: 0, next: 0, note: ""}}
            activeBookKey: null,
            queue: [], idx: 0,
            arcEdit: false, arcSel: new Set()
        };

        // --- æ ¸å¿ƒé€»è¾‘ ---
        function mockSendCode() { alert("éªŒè¯ç  [8888] å·²å‘é€ï¼ˆæ¨¡æ‹Ÿï¼‰"); }

        function handleLogin() {
            const phone = document.getElementById('auth-phone').value;
            if(!/^1[3-9]\d{9}$/.test(phone)) return alert("è¯·è¾“å…¥æ­£ç¡®æ‰‹æœºå·");
            state.user = phone;
            localStorage.setItem('lexi_user', phone);
            loadUserData();
            document.getElementById('auth-screen').classList.add('hide');
            document.getElementById('app-content').classList.remove('hide');
            document.getElementById('user-phone-display').innerText = `User: ${phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')}`;
            initApp();
        }

        function loadUserData() {
            const prefix = `lexi_${state.user}_`;
            const savedBooks = localStorage.getItem(prefix + 'books');
            const savedMem = localStorage.getItem(prefix + 'mem');
            
            if(savedBooks) state.books = JSON.parse(savedBooks);
            else state.books = JSON.parse(JSON.stringify(PRESET_BOOKS)); // åˆå§‹æ³¨å…¥
            
            state.mem = savedMem ? JSON.parse(savedMem) : {};
            save();
        }

        function save() {
            if(!state.user) return;
            const prefix = `lexi_${state.user}_`;
            localStorage.setItem(prefix + 'books', JSON.stringify(state.books));
            localStorage.setItem(prefix + 'mem', JSON.stringify(state.mem));
        }

        function initApp() {
            updateDashboard();
            switchTab('home');
            window.speechSynthesis.getVoices();
        }

        function switchTab(t) {
            ['home','explore','archive','books','book-detail','import'].forEach(v => {
                const el = document.getElementById('view-'+v);
                if(el) el.classList.add('hide');
            });
            document.getElementById('view-'+t).classList.remove('hide');
            
            document.querySelectorAll('nav button').forEach(b => b.classList.add('opacity-20'));
            const navMap = {home:'nav-home', explore:'nav-explore', archive:'nav-archive', books:'nav-books', 'book-detail':'nav-books', 'import':'nav-books'};
            document.getElementById(navMap[t]).classList.remove('opacity-20');
            document.getElementById(navMap[t]).classList.add('active-tab');

            if(t === 'books') renderBooks();
            if(t === 'archive') renderArchive();
            if(t === 'import') populateImportSelect();
        }

        // --- è¯ä¹¦ä¸è¯¦æƒ… ---
        function renderBooks() {
            const grid = document.getElementById('book-grid');
            grid.innerHTML = Object.keys(state.books).map(k => `
                <div onclick="openBook('${k}')" class="aspect-[4/5] rounded-r-[3.5rem] rounded-l-2xl bg-gradient-to-br ${state.books[k].color} p-8 flex flex-col justify-between text-white shadow-xl cursor-pointer active:scale-95 transition-all">
                    <div class="h-1 bg-white/30 w-12 rounded-full"></div>
                    <div>
                        <p class="text-[10px] font-black opacity-60 uppercase tracking-widest">${state.books[k].items.length} è¯æ¡</p>
                        <h4 class="text-xl font-[900] serif leading-tight">${k}</h4>
                    </div>
                </div>
            `).join('');
        }

        function openBook(k) {
            state.activeBookKey = k;
            document.getElementById('cur-book-name').innerText = k;
            document.getElementById('cur-book-stat').innerText = `${state.books[k].items.length} ITEMS â€¢ A-Z SORTED`;
            renderBookItems();
            switchTab('book-detail');
        }

        function renderBookItems() {
            const list = document.getElementById('book-item-list');
            const items = [...state.books[state.activeBookKey].items].sort((a,b) => a.en.localeCompare(b.en));
            list.innerHTML = items.map(i => `
                <div class="bg-white p-5 rounded-[2rem] shadow-sm flex justify-between items-center group">
                    <div class="flex-1">
                        <h5 class="text-sm font-black text-indigo-600">${i.en}</h5>
                        <p class="text-[11px] opacity-40 serif mt-0.5">${i.zh}</p>
                    </div>
                    <button onclick="deleteItem('${i.id}')" class="opacity-0 group-hover:opacity-100 w-8 h-8 rounded-full bg-red-50 text-red-500 transition-all">âœ•</button>
                </div>
            `).join('');
        }

        function deleteItem(id) {
            if(!confirm('ç¡®å®šæ°¸ä¹…ç§»é™¤ï¼Ÿ')) return;
            state.books[state.activeBookKey].items = state.books[state.activeBookKey].items.filter(i => i.id !== id);
            delete state.mem[id];
            save(); renderBookItems(); updateDashboard();
        }

        // --- å¯¼å…¥åŠŸèƒ½ (ä¿®å¤) ---
        function populateImportSelect() {
            const sel = document.getElementById('import-book-select');
            sel.innerHTML = Object.keys(state.books).map(k => `<option value="${k}" ${k === state.activeBookKey ? 'selected' : ''}>${k}</option>`).join('');
        }

        function handleImport() {
            const en = document.getElementById('in-en').value.trim();
            const zh = document.getElementById('in-zh').value.trim();
            const ai = document.getElementById('in-ai').value.trim();
            const note = document.getElementById('in-note').value.trim();
            const bookKey = document.getElementById('import-book-select').value;
            
            if(!en || !zh) return alert("è‹±æ–‡å’Œä¸­æ–‡ä¸ºå¿…å¡«");
            
            const newItem = { id: 'user_'+Date.now(), en, zh, ai: ai || 'No AI example provided.', d: note, cat: "ç”¨æˆ·å½•å…¥" };
            state.books[bookKey].items.push(newItem);
            save();
            ['in-en','in-zh','in-ai','in-note'].forEach(id => document.getElementById(id).value = '');
            alert("å·²å­˜å…¥è¯ä¹¦: " + bookKey);
            updateDashboard();
        }

        // --- å­¦ä¹ ä¸ SRS ---
        function startStudy(mode) {
            let list = [];
            Object.keys(state.books).forEach(k => {
                const sub = state.books[k].items.filter(i => {
                    const m = state.mem[i.id] || {lv:0, next:0};
                    if(mode === 'new') return m.lv === 0;
                    return m.lv > 0 && m.lv < 5 && Date.now() >= m.next;
                });
                list.push(...sub.map(i => ({...i, bookTag: k})));
            });
            if(list.length === 0) return alert("æš‚æ— å¾…å¤ä¹ å†…å®¹ï¼");
            state.queue = list.sort(() => Math.random() - 0.5).slice(0, 20);
            state.idx = 0;
            document.getElementById('study-layer').classList.remove('hide');
            renderStudyCard();
        }

        function renderStudyCard() {
            const item = state.queue[state.idx];
            document.getElementById('activeCard').classList.remove('flipped');
            document.getElementById('card-en').innerText = item.en;
            document.getElementById('card-zh').innerText = item.zh;
            document.getElementById('card-ai').innerText = item.ai || "æš‚æ— AIä¾‹å¥";
            document.getElementById('card-note-edit').value = state.mem[item.id]?.note || "";
            document.getElementById('study-count').innerText = `${state.idx + 1} / ${state.queue.length}`;
            document.getElementById('study-tag').innerText = item.bookTag;
        }

        function updateNoteLive() {
            const item = state.queue[state.idx];
            const note = document.getElementById('card-note-edit').value;
            if(!state.mem[item.id]) state.mem[item.id] = {lv:0, next:0};
            state.mem[item.id].note = note;
            save();
        }

        function handleSRS(score) {
            const item = state.queue[state.idx];
            if(!state.mem[item.id]) state.mem[item.id] = {lv:0, next:0, note:""};
            const m = state.mem[item.id];
            
            if(score === 3) m.lv++;
            else if(score === 1) m.lv = Math.max(0, m.lv - 1);
            
            const intervals = [0, 2*60000, 3600*1000, 24*3600*1000, 72*3600*1000, 7*24*3600*1000];
            m.next = Date.now() + intervals[Math.min(m.lv, 5)];
            
            save(); state.idx++;
            if(state.idx < state.queue.length) renderStudyCard();
            else closeStudy();
        }

        // --- æœç´¢å±•å¼€ä¸ç¬”è®°ä¿®æ”¹ ---
        function renderSearch() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const res = document.getElementById('search-results');
            if(!q) return res.innerHTML = "";
            
            let all = []; Object.values(state.books).forEach(b => all.push(...b.items));
            const filtered = all.filter(i => i.en.toLowerCase().includes(q) || i.zh.includes(q));
            
            res.innerHTML = filtered.map(i => `
                <div class="explore-item bg-white p-6 rounded-[2.5rem] shadow-sm border-2 border-transparent transition-all overflow-hidden" onclick="this.classList.toggle('expanded')">
                    <div class="flex justify-between items-center">
                        <div><h4 class="font-black text-indigo-600">${i.en}</h4><p class="text-xs opacity-40 serif">${i.zh}</p></div>
                        <span class="text-[8px] font-black opacity-20">â–¼</span>
                    </div>
                    <div class="hide mt-4 pt-4 border-t border-slate-50 space-y-3 block-expandable">
                        <div class="bg-indigo-50 p-4 rounded-2xl text-[11px] serif">
                            <p class="font-black mb-1 opacity-40">AI EXAMPLE</p>
                            ${i.ai}
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl text-[11px] serif">
                            <p class="font-black mb-1 opacity-40">PERSONAL NOTE</p>
                            <textarea onchange="updateSearchNote('${i.id}', this.value)" class="w-full bg-transparent outline-none border-none resize-none" placeholder="ç‚¹å‡»æ·»åŠ ç¬”è®°...">${state.mem[i.id]?.note || ""}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateSearchNote(id, val) {
            if(!state.mem[id]) state.mem[id] = {lv:0, next:0};
            state.mem[id].note = val;
            save();
        }

        // --- å½’æ¡£ä¸é‡ç½® ---
        function renderArchive() {
            const list = document.getElementById('archive-list');
            let mastered = [];
            Object.values(state.books).forEach(b => mastered.push(...b.items.filter(i => state.mem[i.id]?.lv >= 5)));
            
            if(mastered.length === 0) return list.innerHTML = `<p class="text-center py-20 opacity-20 font-black italic">æš‚æ— å½’æ¡£è¯æ¡</p>`;
            
            list.innerHTML = mastered.map(i => `
                <div onclick="handleArcSel('${i.id}')" class="bg-white p-6 rounded-[2.2rem] shadow-sm flex justify-between items-center border-2 ${state.arcSel.has(i.id)?'border-indigo-600':'border-transparent'}">
                    <div><h5 class="text-sm font-black italic">${i.en}</h5><p class="text-[10px] opacity-30 serif">${i.zh}</p></div>
                    <span class="text-xl">ğŸ“</span>
                </div>
            `).join('');
        }

        function toggleArchiveEdit() {
            state.arcEdit = !state.arcEdit;
            state.arcSel.clear();
            document.getElementById('batch-bar').classList.toggle('hide', !state.arcEdit);
            document.getElementById('btn-arc-edit').innerText = state.arcEdit ? "é€€å‡ºç®¡ç†" : "æ‰¹é‡ç®¡ç†";
            renderArchive();
        }

        function handleArcSel(id) {
            if(!state.arcEdit) return;
            state.arcSel.has(id) ? state.arcSel.delete(id) : state.arcSel.add(id);
            document.getElementById('arc-sel-count').innerText = state.arcSel.size;
            renderArchive();
        }

        function resetArchived() {
            if(state.arcSel.size === 0) return;
            state.arcSel.forEach(id => {
                if(state.mem[id]) { state.mem[id].lv = 0; state.mem[id].next = 0; }
            });
            save(); toggleArchiveEdit(); updateDashboard();
        }

        // --- å·¥å…· ---
        function updateDashboard() {
            let n = 0, r = 0;
            Object.values(state.books).forEach(b => {
                b.items.forEach(i => {
                    const m = state.mem[i.id] || {lv:0, next:0};
                    if(m.lv === 0) n++;
                    else if(m.lv < 5 && Date.now() >= m.next) r++;
                });
            });
            document.getElementById('num-new').innerText = n;
            document.getElementById('num-review').innerText = r;
        }

        function toggleSidebar(s) {
            document.getElementById('sidebar').style.transform = s ? 'translateX(0)' : 'translateX(100%)';
            document.getElementById('side-overlay').classList.toggle('hide', !s);
            if(s) document.getElementById('side-phone').innerText = state.user.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
        }

        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateDashboard(); }
        
        function speakCurrent() {
            const item = state.queue[state.idx];
            if(!item) return;
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(item.en);
            const accent = document.getElementById('set-accent').value;
            msg.lang = accent === 'us' ? 'en-US' : 'en-GB';
            const voices = window.speechSynthesis.getVoices();
            msg.voice = voices.find(v => v.lang.startsWith(msg.lang) && (v.name.includes('Google') || v.name.includes('Natural'))) || voices[0];
            window.speechSynthesis.speak(msg);
        }

        // è‡ªåŠ¨æ³¨å…¥å±•å¼€æ ·å¼
        const style = document.createElement('style');
        style.textContent = `.expanded .block-expandable { display: block !important; } .expanded span { transform: rotate(180deg); opacity: 1; }`;
        document.head.appendChild(style);

        // åˆå§‹åŒ–
        if(localStorage.getItem('lexi_user')) {
            state.user = localStorage.getItem('lexi_user');
            handleLogin(); // æ¨¡æ‹Ÿè‡ªåŠ¨ç™»å½•
        }
    </script>
</body>
</html>
