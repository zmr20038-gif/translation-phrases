<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LexiFlow MTI v11</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #F8FAFC; --text: #1E293B; --card: #FFFFFF; --accent: #4F46E5; }
        .dark { --bg: #0F172A; --text: #F1F5F9; --card: #1E293B; --accent: #818CF8; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .serif { font-family: 'Noto Serif SC', serif; }
        
        /* å¸ƒå±€é€‚é… */
        .safe-area-bottom { padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); }
        
        /* ä¾§è¾¹æ  */
        #settings-sidebar { transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #settings-sidebar.open { transform: translateX(0); }

        /* å­¦ä¹ å¡ç‰‡ */
        .card-container { perspective: 1000px; width: 100%; height: 100%; position: relative; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; background: var(--card); box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }
        .card-back { transform: rotateY(180deg); border: 2px solid var(--accent); overflow-y: auto; }

        .hide { display: none !important; }
        .active-tab { color: var(--accent) !important; opacity: 1 !important; font-weight: 800; border-bottom: 2px solid var(--accent); }
        
        /* å¤é€‰æ¡†æ ·å¼ */
        .checkbox-wrapper input:checked + div { background-color: var(--accent); border-color: var(--accent); }
        .checkbox-wrapper input:checked + div svg { display: block; }
    </style>
</head>
<body class="select-none min-h-screen">

    <header class="max-w-xl mx-auto px-6 pt-12 pb-4 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-[900] tracking-tighter italic text-slate-800 dark:text-white">Lexi<span class="text-indigo-600">MTI</span>.</h1>
            <p class="text-[10px] font-bold opacity-40 uppercase tracking-widest mt-1">2026 Master of Translation</p>
        </div>
        <button onclick="toggleSidebar(true)" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow-sm text-xl active:scale-90 transition-transform">âš™ï¸</button>
    </header>

    <main id="view-home" class="max-w-xl mx-auto px-6 space-y-6">
        <div class="grid grid-cols-2 gap-4">
            <div onclick="openStudy('new')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] shadow-sm border-b-4 border-indigo-50 dark:border-slate-700 active:scale-95 transition-all">
                <span class="text-[10px] font-black opacity-40 uppercase tracking-widest">éœ€å­¦ä¹  New</span>
                <p id="num-new" class="text-4xl font-black mt-2 text-indigo-600">0</p>
            </div>
            <div onclick="openStudy('review')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] shadow-sm border-b-4 border-emerald-50 dark:border-slate-700 active:scale-95 transition-all">
                <span class="text-[10px] font-black opacity-40 uppercase tracking-widest">å¾…å¤ä¹  Review</span>
                <p id="num-review" class="text-4xl font-black mt-2 text-emerald-500">0</p>
            </div>
        </div>

        <div onclick="switchTab('learned')" class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] shadow-sm active:scale-95 transition-all flex justify-between items-center border border-slate-100 dark:border-slate-700">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center">ğŸ“</div>
                <div>
                    <p class="text-sm font-bold">å·²æŒæ¡è¯æ¡åº“</p>
                    <p class="text-[10px] opacity-40 uppercase">Learned Vocabulary</p>
                </div>
            </div>
            <p id="num-learned-dash" class="text-xl font-black text-slate-400 mr-2">0</p>
        </div>

        <div class="bg-indigo-600 rounded-[2.5rem] p-7 text-white shadow-xl shadow-indigo-100 dark:shadow-none">
            <p class="text-[10px] font-bold opacity-60 uppercase mb-3 tracking-widest italic">Daily Quote</p>
            <p class="text-lg font-bold font-serif leading-relaxed mb-3">"Translation is not a matter of words only: it is a matter of making intelligible a whole culture."</p>
            <p class="text-sm opacity-80 serif">â€œç¿»è¯‘ä¸åªæ˜¯æ–‡å­—åŠŸå¤«ï¼Œæ›´æ˜¯ä¸ºäº†è®©æ•´ä¸ªæ–‡åŒ–å˜å¾—æ˜“äºç†è§£ã€‚â€</p>
            <p class="text-[10px] font-bold text-right mt-4 opacity-50">â€” Anthony Burgess</p>
        </div>
    </main>

    <main id="view-explore" class="max-w-xl mx-auto px-6 hide">
        <div class="flex gap-4 mb-6 overflow-x-auto no-scrollbar pb-2 border-b border-slate-100 dark:border-slate-800">
            <button onclick="setFilter('all')" class="cat-btn text-xs font-bold pb-2 active-tab">å…¨éƒ¨</button>
            <button onclick="setFilter('POL')" class="cat-btn text-xs font-bold pb-2 opacity-40">ğŸ›ï¸ æ”¿æ²»</button>
            <button onclick="setFilter('ECO')" class="cat-btn text-xs font-bold pb-2 opacity-40">ğŸ’° ç»è´¸</button>
            <button onclick="setFilter('TEC')" class="cat-btn text-xs font-bold pb-2 opacity-40">ğŸš€ ç§‘æŠ€</button>
        </div>
        <div id="explore-list" class="space-y-4 pb-32">
            </div>
    </main>

    <main id="view-learned" class="max-w-xl mx-auto px-6 hide">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black">å·²æŒæ¡ç®¡ç†</h2>
            <button onclick="toggleEditMode()" id="btn-edit" class="text-xs font-bold bg-slate-100 dark:bg-slate-800 px-4 py-2 rounded-full">æ‰¹é‡ç®¡ç†</button>
        </div>
        <div id="learned-list" class="space-y-3 pb-32"></div>
    </main>

    <main id="view-books" class="max-w-xl mx-auto px-6 hide">
        <h2 class="text-2xl font-black mb-6">è¯æ¡ä¹¦æ¶</h2>
        <div class="grid grid-cols-2 gap-4">
            <div class="aspect-[3/4] bg-gradient-to-br from-indigo-600 to-blue-700 rounded-2xl p-6 text-white flex flex-col justify-end shadow-lg">
                <p class="text-[10px] opacity-60">SELECTED</p>
                <h3 class="font-black text-xl leading-tight">2026 MTI<br>é«˜é¢‘çƒ­è¯</h3>
            </div>
            <div class="aspect-[3/4] border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-2xl flex items-center justify-center text-slate-300">
                <span class="text-3xl">+</span>
            </div>
        </div>
    </main>

    <section id="study-layer" class="fixed inset-0 bg-slate-50 dark:bg-slate-900 z-[200] hide flex flex-col">
        <div class="px-6 pt-12 flex justify-between items-center">
            <button onclick="closeStudy()" class="text-2xl opacity-20">âœ•</button>
            <span id="study-progress" class="text-[10px] font-black opacity-30 tracking-widest uppercase">Learning 1/10</span>
            <button onclick="speakWord()" class="text-xl">ğŸ”Š</button>
        </div>
        <div class="flex-1 p-6 flex items-center justify-center">
            <div class="card-container" id="studyCard">
                <div class="flip-card-inner" onclick="flipCard()">
                    <div class="card-face card-front">
                        <span id="card-cat" class="text-[9px] font-black text-indigo-500 bg-indigo-50 px-2 py-1 rounded-full mb-6">POLITICS</span>
                        <h2 id="card-en" class="text-3xl font-bold text-center leading-tight">Term</h2>
                        <p class="mt-12 text-[10px] font-bold text-slate-300">TAP TO FLIP</p>
                    </div>
                    <div class="card-face card-back items-start text-left">
                        <h3 id="card-zh" class="text-xl font-bold text-indigo-600 mb-4 serif">ä¸­æ–‡è¯‘æ–‡</h3>
                        <p id="card-d" class="text-xs text-slate-500 leading-relaxed mb-6 font-medium">å®šä¹‰è§£é‡Š...</p>
                        <div class="w-full bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700" onclick="event.stopPropagation()">
                            <p class="text-[9px] font-black text-slate-400 uppercase mb-1">ç¿»è¯‘ç¬”è®°</p>
                            <textarea id="card-note" oninput="saveCurrentNote(this.value)" class="w-full bg-transparent text-xs h-16 outline-none resize-none" placeholder="è®°å½•ä½ çš„ç¿»è¯‘æŠ€å·§..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-6 safe-area-bottom">
            <div class="grid grid-cols-3 gap-3">
                <button onclick="handleLearn(1)" class="py-5 bg-white dark:bg-slate-800 rounded-2xl font-black text-[10px] shadow-sm active:scale-95 transition-all text-slate-400">å¿˜äº† (1åˆ†å)</button>
                <button onclick="handleLearn(2)" class="py-5 bg-white dark:bg-slate-800 rounded-2xl font-black text-[10px] shadow-sm active:scale-95 transition-all text-indigo-400">æ¨¡ç³Š (10åˆ†å)</button>
                <button onclick="handleLearn(3)" class="py-5 bg-indigo-600 rounded-2xl font-black text-[10px] shadow-lg shadow-indigo-100 text-white active:scale-95 transition-all">è®¤è¯† (1å¤©å)</button>
            </div>
        </div>
    </section>

    <div id="settings-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-black/10 backdrop-blur-sm z-[300] hide"></div>
    <aside id="settings-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-900 z-[301] shadow-2xl p-6 flex flex-col overflow-y-auto">
        <div class="mb-8 p-5 bg-slate-50 dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700">
            <div id="login-panel">
                <h3 class="font-bold text-sm mb-4">æ‰‹æœºå·ç™»å½•</h3>
                <input type="tel" id="login-phone" placeholder="æ‰‹æœºå·" class="w-full bg-white dark:bg-slate-900 p-3 rounded-xl text-xs font-bold mb-3 border border-slate-200 dark:border-slate-700 outline-none">
                <button onclick="userLogin()" class="w-full bg-indigo-600 text-white p-3 rounded-xl text-xs font-bold shadow-md">ç¡®è®¤ç™»å½•</button>
            </div>
            <div id="profile-panel" class="hide text-center">
                <div class="w-16 h-16 rounded-full bg-indigo-100 mx-auto mb-3 flex items-center justify-center text-3xl">ğŸ‘¤</div>
                <p id="user-phone" class="font-bold">138****8888</p>
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <div class="bg-white dark:bg-slate-900 p-2 rounded-xl">
                        <p class="text-[8px] opacity-40 uppercase">å­¦è¯é‡</p>
                        <p id="stat-words" class="text-sm font-black text-indigo-500">0</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-2 rounded-xl">
                        <p class="text-[8px] opacity-40 uppercase">ç§¯åˆ†</p>
                        <p id="stat-points" class="text-sm font-black text-amber-500">0</p>
                    </div>
                </div>
                <button onclick="userLogout()" class="mt-4 text-[10px] text-red-500 font-bold">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div class="space-y-6 flex-1">
            <div onclick="switchTab('books'); toggleSidebar(false)" class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl flex justify-between items-center cursor-pointer">
                <span class="text-xs font-bold">ğŸ“š è¯æ¡ä¹¦åº“</span>
                <span class="text-[10px] opacity-40">æ›´æ¢è¯ä¹¦ ></span>
            </div>
            <div>
                <div class="flex justify-between font-black text-indigo-500 mb-2 text-xs"><span>æ¯æ—¥æ–°è¯ç›®æ ‡</span><span id="goal-val">10</span></div>
                <input type="range" min="5" max="50" step="5" value="10" oninput="updateGoal(this.value)" class="w-full h-1 bg-slate-200 rounded-full appearance-none accent-indigo-600">
            </div>
            <button onclick="toggleDarkMode()" class="w-full p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl flex justify-between font-bold text-xs">
                <span>å¤œé—´æ¨¡å¼</span><span id="mode-icon">ğŸŒ™</span>
            </button>
        </div>
    </aside>

    <div id="batch-bar" class="fixed bottom-24 left-6 right-6 bg-white dark:bg-slate-800 shadow-2xl rounded-2xl p-4 flex justify-between items-center border border-slate-100 hide z-[50]">
        <span class="text-xs font-bold ml-2">å·²é€‰ <span id="selected-count" class="text-indigo-600">0</span></span>
        <button onclick="moveToTrash()" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl text-xs font-black">ğŸ—‘ï¸ ç§»å…¥åƒåœ¾ç®±</button>
    </div>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl rounded-full shadow-2xl flex items-center px-8 py-2 gap-12 border border-white/20 z-[100]">
        <button onclick="switchTab('home')" id="btn-home" class="p-2 active-tab text-2xl transition-all">ğŸ </button>
        <button onclick="switchTab('explore')" id="btn-explore" class="p-2 opacity-30 text-2xl transition-all">ğŸ”</button>
    </nav>

    <script>
        const RAW_LIB = [
            { id:'1', cat:'POL', en:'New quality productive forces', zh:'æ–°è´¨ç”Ÿäº§åŠ›', d:'ä»¥åˆ›æ–°èµ·ä¸»å¯¼ä½œç”¨ï¼Œå…·æœ‰é«˜ç§‘æŠ€ã€é«˜æ•ˆèƒ½ã€é«˜è´¨é‡ç‰¹å¾ã€‚' },
            { id:'2', cat:'POL', en:'Community with a shared future', zh:'äººç±»å‘½è¿å…±åŒä½“', d:'æ—¨åœ¨é€šå‘å’Œå¹³ã€å®‰å…¨ã€ç¹è£ã€å¼€æ”¾ã€åŒ…å®¹çš„ä¸–ç•Œã€‚' },
            { id:'3', cat:'ECO', en:'Supply-side structural reform', zh:'ä¾›ç»™ä¾§ç»“æ„æ€§æ”¹é©', d:'ç”¨æ”¹é©çš„åŠæ³•æ¨è¿›ç»“æ„è°ƒæ•´ã€‚' },
            { id:'4', cat:'TEC', en:'Quantum Computing', zh:'é‡å­è®¡ç®—', d:'åŸºäºé‡å­å åŠ åŸç†çš„è®¡ç®—æ¨¡å¼ã€‚' },
            { id:'5', cat:'TEC', en:'Generative AI', zh:'ç”Ÿæˆå¼äººå·¥æ™ºèƒ½', d:'èƒ½å¤Ÿé€šè¿‡å­¦ä¹ è®­ç»ƒç”Ÿæˆå†…å®¹çš„æŠ€æœ¯ã€‚' }
        ].sort((a,b) => a.en.localeCompare(b.en));

        let state = {
            mem: JSON.parse(localStorage.getItem('lexi_v11_mem') || '{}'),
            user: JSON.parse(localStorage.getItem('lexi_v11_user') || 'null'),
            notes: JSON.parse(localStorage.getItem('lexi_v11_notes') || '{}'),
            goal: 10, filter: 'all', queue: [], idx: 0, editMode: false, selectedItems: new Set()
        };

        function init() {
            if(localStorage.getItem('lexi_dark') === 'true') document.body.classList.add('dark');
            updateDashboard();
            updateUserUI();
        }

        // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (å¤ç”¨è‡ª v9/v10) ---
        function updateDashboard() {
            const now = Date.now();
            const news = RAW_LIB.filter(i => (!state.mem[i.id] || state.mem[i.id].lv === 0)).length;
            const reviews = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && state.mem[i.id].lv < 99 && now >= state.mem[i.id].next).length;
            const learned = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && state.mem[i.id].lv < 99).length;
            
            document.getElementById('num-new').innerText = news;
            document.getElementById('num-review').innerText = reviews;
            document.getElementById('num-learned-dash').innerText = learned;
        }

        // --- å­¦ä¹ ç³»ç»Ÿ ---
        function openStudy(mode) {
            const now = Date.now();
            if(mode === 'new') {
                state.queue = RAW_LIB.filter(i => !state.mem[i.id] || state.mem[i.id].lv === 0).slice(0, state.goal);
            } else {
                state.queue = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && state.mem[i.id].lv < 99 && now >= state.mem[i.id].next).slice(0, state.goal);
            }
            if(!state.queue.length) return alert("å½“å‰æ²¡è¯å•¦ï¼");
            state.idx = 0;
            document.getElementById('study-layer').classList.remove('hide');
            renderCard();
        }

        function renderCard() {
            const item = state.queue[state.idx];
            document.getElementById('studyCard').classList.remove('flipped');
            document.getElementById('card-en').innerText = item.en;
            document.getElementById('card-zh').innerText = item.zh;
            document.getElementById('card-cat').innerText = item.cat;
            document.getElementById('card-d').innerText = item.d;
            document.getElementById('card-note').value = state.notes[item.id] || '';
            document.getElementById('study-progress').innerText = `Learning ${state.idx + 1}/${state.queue.length}`;
        }

        function handleLearn(score) {
            const item = state.queue[state.idx];
            if(!state.mem[item.id]) state.mem[item.id] = { lv: 0, next: 0 };
            const m = state.mem[item.id];
            
            // è‰¾å®¾æµ©æ–¯æ¨¡æ‹Ÿé€»è¾‘
            if(score === 3) m.lv += 1;
            else if(score === 1) m.lv = 1;
            
            const intervals = [0, 1, 1440, 4320, 10080]; // åˆ†é’Ÿ
            m.next = Date.now() + (intervals[Math.min(m.lv, 4)] * 60000);
            
            if(state.user && score > 1) { state.user.points += 10; saveUser(); updateUserUI(); }
            saveMem();
            
            state.idx++;
            if(state.idx < state.queue.length) renderCard();
            else closeStudy();
        }

        // --- æ¢ç´¢é¡µé€»è¾‘ (åˆ†ç±» + ç¬”è®°) ---
        function setFilter(cat) { 
            state.filter = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active-tab'));
            event.target.classList.add('active-tab');
            renderExplore();
        }

        function renderExplore() {
            const container = document.getElementById('explore-list');
            const filtered = RAW_LIB.filter(i => state.filter === 'all' || i.cat === state.filter);
            container.innerHTML = filtered.map(i => `
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm">
                    <div class="flex justify-between items-start" onclick="toggleDetail('${i.id}')">
                        <div>
                            <span class="text-[9px] font-black text-slate-300 uppercase">${i.cat}</span>
                            <h4 class="font-bold text-lg mt-1">${i.en}</h4>
                        </div>
                        <span class="text-indigo-500 font-bold">${state.mem[i.id]?.lv > 0 ? 'âœ“' : '+'}</span>
                    </div>
                    <div id="detail-${i.id}" class="hide mt-4 pt-4 border-t border-slate-50 dark:border-slate-700">
                        <p class="text-indigo-600 font-bold serif mb-2">${i.zh}</p>
                        <p class="text-xs text-slate-500 mb-4">${i.d}</p>
                        <textarea oninput="saveNote('${i.id}', this.value)" class="w-full bg-slate-50 dark:bg-slate-900 p-3 rounded-xl text-xs outline-none h-16" placeholder="æ·»åŠ å­¦ä¹ ç¬”è®°...">${state.notes[i.id] || ''}</textarea>
                    </div>
                </div>
            `).join('');
        }

        // --- å·²å­¦ä¹ ç®¡ç† (æ‰¾å›) ---
        function renderLearned() {
            const list = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && state.mem[i.id].lv < 99);
            const container = document.getElementById('learned-list');
            if(!list.length) { container.innerHTML = '<p class="text-center opacity-30 mt-10">å°šæ— æŒæ¡è¯æ¡</p>'; return; }
            container.innerHTML = list.map(i => `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl flex items-center gap-3">
                    <label class="checkbox-wrapper ${state.editMode?'':'hide'}">
                        <input type="checkbox" class="hidden" onchange="toggleSelect('${i.id}')" ${state.selectedItems.has(i.id)?'checked':''}>
                        <div class="w-5 h-5 rounded-full border-2 border-slate-300 flex items-center justify-center"><svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3"/></svg></div>
                    </label>
                    <div class="truncate">
                        <p class="font-bold text-sm">${i.en}</p>
                        <p class="text-xs opacity-40">${i.zh}</p>
                    </div>
                </div>
            `).join('');
        }

        // --- é€šç”¨é€»è¾‘ ---
        function flipCard() { document.getElementById('studyCard').classList.toggle('flipped'); }
        function switchTab(tab) {
            ['home', 'explore', 'books', 'learned'].forEach(t => document.getElementById('view-'+t)?.classList.add('hide'));
            document.getElementById('view-'+tab).classList.remove('hide');
            document.getElementById('btn-home').className = tab==='home'?'active-tab text-2xl':'opacity-30 text-2xl';
            document.getElementById('btn-explore').className = tab==='explore'?'active-tab text-2xl':'opacity-30 text-2xl';
            if(tab === 'explore') renderExplore();
            if(tab === 'learned') renderLearned();
        }
        function userLogin() {
            const phone = document.getElementById('login-phone').value;
            if(phone.length < 11) return alert("æ‰‹æœºå·ä¸æ­£ç¡®");
            state.user = { phone, points: 0 };
            saveUser(); updateUserUI();
        }
        function userLogout() { state.user = null; localStorage.removeItem('lexi_v11_user'); updateUserUI(); }
        function updateUserUI() {
            const isL = !!state.user;
            document.getElementById('login-panel').classList.toggle('hide', isL);
            document.getElementById('profile-panel').classList.toggle('hide', !isL);
            if(isL) {
                document.getElementById('user-phone').innerText = state.user.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
                document.getElementById('stat-points').innerText = state.user.points;
                document.getElementById('stat-words').innerText = Object.values(state.mem).filter(x=>x.lv>0&&x.lv<99).length;
            }
        }
        function saveNote(id, val) { state.notes[id] = val; localStorage.setItem('lexi_v11_notes', JSON.stringify(state.notes)); }
        function saveCurrentNote(v) { saveNote(state.queue[state.idx].id, v); }
        function saveMem() { localStorage.setItem('lexi_v11_mem', JSON.stringify(state.mem)); updateDashboard(); }
        function saveUser() { localStorage.setItem('lexi_v11_user', JSON.stringify(state.user)); }
        function toggleSidebar(s) { document.getElementById('settings-sidebar').classList.toggle('open', s); document.getElementById('settings-overlay').classList.toggle('hide', !s); }
        function toggleDarkMode() { document.body.classList.toggle('dark'); localStorage.setItem('lexi_dark', document.body.classList.contains('dark')); }
        function toggleDetail(id) { document.getElementById('detail-'+id).classList.toggle('hide'); }
        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateDashboard(); }
        function toggleEditMode() { 
            state.editMode = !state.editMode; 
            document.getElementById('batch-bar').classList.toggle('hide', !state.editMode);
            renderLearned(); 
        }
        function toggleSelect(id) {
            state.selectedItems.has(id) ? state.selectedItems.delete(id) : state.selectedItems.add(id);
            document.getElementById('selected-count').innerText = state.selectedItems.size;
        }
        function moveToTrash() {
            state.selectedItems.forEach(id => state.mem[id].lv = 99);
            saveMem(); state.selectedItems.clear(); toggleEditMode();
        }
        function speakWord() { window.speechSynthesis.speak(new SpeechSynthesisUtterance(state.queue[state.idx].en)); }

        init();
    </script>
</body>
</html>
