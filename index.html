<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LexiFlow MTI v7.9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Noto+Serif+SC:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #4F46E5; --bg: #F8FAFC; --card-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); }
        .dark { --bg: #0F172A; }
        
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; transition: background 0.3s ease; min-height: 100vh; color: #1E293B; }
        .dark body { color: #F1F5F9; background-color: #0F172A; }
        .serif { font-family: 'Noto Serif SC', serif; }
        .hide { display: none !important; }
        
        /* å¯¼èˆª */
        .nav-capsule { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; padding: 12px 30px; border-radius: 100px; display: flex; gap: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); z-index: 100; border: 1px solid rgba(0,0,0,0.05); }
        .dark .nav-capsule { background: #1E293B; border-color: rgba(255,255,255,0.1); }
        .nav-link { font-size: 24px; transition: all 0.2s; opacity: 0.2; }
        .nav-link.active { opacity: 1; transform: scale(1.1); }

        /* å¡ç‰‡åŸºç¡€æ ·å¼ */
        .card-base { background: white; border-radius: 2rem; box-shadow: var(--card-shadow); transition: all 0.3s; }
        .dark .card-base { background: #1E293B; border: 1px solid rgba(255,255,255,0.05); }
        
        .expandable-content { max-height: 0; overflow: hidden; transition: all 0.4s ease-out; opacity: 0; }
        .expanded .expandable-content { max-height: 800px; opacity: 1; padding-top: 1rem; }
        .expanded .chevron { transform: rotate(180deg); }

        /* å­¦ä¹ å¡ç‰‡ */
        .card-container { perspective: 2000px; width: 90%; max-width: 380px; height: 500px; margin: auto; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 2.5rem; background: white; padding: 2.5rem; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.08); }
        .dark .card-face { background: #1E293B; border: 1px solid rgba(255,255,255,0.05); }
        .card-back { transform: rotateY(180deg); }
        
        .weight-black { font-weight: 800; }
        .btn-active:active { transform: scale(0.95); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .dot { position: absolute; top: 0; right: 0; width: 8px; height: 8px; background: #EF4444; border-radius: 50%; border: 2px solid white; }
    </style>
</head>
<body>

    <section id="auth-screen" class="fixed inset-0 bg-white dark:bg-slate-900 z-[1000] flex flex-col items-center justify-center p-8 text-slate-800 dark:text-white">
        <h1 class="text-4xl weight-black italic mb-8">Lexi<span class="text-indigo-600">MTI</span></h1>
        <div class="w-full max-w-xs space-y-4">
            <input id="auth-phone" type="tel" placeholder="æ‰‹æœºå·" class="w-full bg-slate-50 dark:bg-slate-800 p-5 rounded-2xl outline-none text-center font-bold">
            <div class="flex gap-2">
                <input id="auth-code" type="number" placeholder="4ä½éªŒè¯ç " class="flex-1 bg-slate-50 dark:bg-slate-800 p-5 rounded-2xl outline-none text-center font-bold">
                <button onclick="alert('æµ‹è¯•ç : 1234')" class="px-4 bg-slate-100 dark:bg-slate-700 rounded-2xl text-[10px] weight-black uppercase">è·å–</button>
            </div>
            <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl weight-black shadow-lg">è¿›å…¥ç³»ç»Ÿ</button>
        </div>
    </section>

    <div id="app-content" class="hide flex flex-col max-w-2xl mx-auto w-full min-h-screen">
        <header class="p-8 flex justify-between items-center">
            <div>
                <h2 class="text-2xl weight-black italic dark:text-white">Lexi<span class="text-indigo-600">MTI</span></h2>
                <p class="text-[8px] weight-black opacity-30 tracking-[0.2em] uppercase dark:text-white">2026 Master of Translation</p>
            </div>
            <button onclick="toggleSidebar(true)" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full shadow-sm flex items-center justify-center border border-slate-100 dark:border-slate-700">â˜°</button>
        </header>

        <main class="flex-1 px-8 pb-32">
            <div id="view-home" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div onclick="prepStudy('new')" class="card-base p-6 border-b-4 border-indigo-500 btn-active">
                        <p class="text-[10px] weight-black opacity-30 uppercase mb-1 dark:text-slate-400">New Words</p>
                        <p id="num-new" class="text-4xl weight-black text-indigo-600">0</p>
                    </div>
                    <div onclick="prepStudy('review')" class="card-base p-6 border-b-4 border-emerald-500 btn-active">
                        <p class="text-[10px] weight-black opacity-30 uppercase mb-1 dark:text-slate-400">Review</p>
                        <p id="num-rev" class="text-4xl weight-black text-emerald-500">0</p>
                    </div>
                </div>

                <div class="card-base p-5 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-slate-50 dark:bg-slate-800 rounded-xl flex items-center justify-center text-lg">ğŸ“š</div>
                        <div>
                            <h4 class="text-xs weight-black dark:text-white">æ´»è·ƒè¯ä¹¦</h4>
                            <p id="plan-text" class="text-[9px] opacity-40 uppercase tracking-widest dark:text-slate-400">Loading...</p>
                        </div>
                    </div>
                    <span id="active-book-count" class="text-xl weight-black opacity-20 italic dark:text-white">0</span>
                </div>

                <div onclick="switchTab('archive-mgr')" class="card-base p-5 flex items-center justify-between btn-active">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-slate-50 dark:bg-slate-800 rounded-xl flex items-center justify-center text-lg">ğŸ“¥</div>
                        <div>
                            <h4 class="text-xs weight-black dark:text-white">å½’æ¡£ç®¡ç†</h4>
                            <p class="text-[9px] opacity-40 uppercase tracking-widest dark:text-slate-400">Archive Manager</p>
                        </div>
                    </div>
                    <span id="mastered-count" class="text-xl weight-black opacity-20 italic dark:text-white">0</span>
                </div>

                <div class="bg-gradient-to-br from-indigo-600 to-blue-700 rounded-[2.5rem] p-8 text-white shadow-xl space-y-4 relative overflow-hidden">
                    <p id="quote-en" class="text-lg weight-black leading-tight italic tracking-tight relative z-10">---</p>
                    <p id="quote-zh" class="text-sm serif opacity-80 relative z-10">---</p>
                </div>
            </div>

            <div id="view-books" class="hide">
                <div class="flex justify-between items-end mb-8"><h3 class="text-2xl weight-black italic dark:text-white">æˆ‘çš„ä¹¦æ¶</h3></div>
                <div id="book-grid" class="grid grid-cols-2 gap-5">
                    </div>
            </div>

            <div id="view-explore" class="hide space-y-6">
                <input type="text" id="search-box" oninput="runSearch()" placeholder="Search terms..." class="w-full p-5 rounded-2xl bg-white dark:bg-slate-800 shadow-sm outline-none font-bold text-sm dark:text-white">
                <div class="flex items-center gap-2 overflow-hidden">
                    <div id="cat-tags-container" class="flex gap-2 overflow-x-auto no-scrollbar py-2 flex-nowrap"></div>
                    <button onclick="createNewCategory()" class="w-10 h-10 bg-indigo-600 text-white rounded-full flex-shrink-0 text-xl font-bold btn-active">+</button>
                </div>
                <div id="search-list" class="space-y-4"></div>
            </div>

            <div id="view-book-detail" class="hide space-y-6">
                <div class="flex items-center gap-4">
                    <button onclick="switchTab('books')" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center dark:text-white">â†</button>
                    <h3 id="book-title-h" class="text-xl weight-black serif dark:text-white">---</h3>
                </div>
                <div id="book-item-list" class="space-y-4"></div>
            </div>

            <div id="view-import" class="hide space-y-6">
                <div class="card-base p-8 space-y-6">
                    <div><p class="text-[9px] weight-black opacity-30 uppercase mb-2 dark:text-white">ç›®æ ‡è¯ä¹¦</p>
                    <select id="import-book-sel" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl text-xs font-bold outline-none dark:text-white"></select></div>
                    <div><p class="text-[9px] weight-black opacity-30 uppercase mb-2 dark:text-white">è¯æ¡åˆ†ç±»</p>
                    <select id="import-cat-sel" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl text-xs font-bold outline-none dark:text-white"></select></div>
                    <input id="in-en" type="text" placeholder="English Term" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl text-lg weight-black outline-none dark:text-white">
                    <input id="in-zh" type="text" placeholder="ä¸­æ–‡ç¿»è¯‘" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl text-lg serif outline-none dark:text-white">
                    <textarea id="in-ai" placeholder="è§£é‡Šä¸ä¾‹å¥..." class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl text-xs h-32 resize-none serif outline-none dark:text-white"></textarea>
                    <button onclick="doImport()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl weight-black shadow-lg btn-active">å­˜å…¥è¯åº“</button>
                </div>
            </div>

            <div id="view-archive-mgr" class="hide space-y-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button onclick="switchTab('home')" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center dark:text-white">â†</button>
                        <h3 class="text-xl weight-black serif dark:text-white">å¾…å½’æ¡£è¯æ¡</h3>
                    </div>
                    <button onclick="batchArchive()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] weight-black">å…¨éƒ¨å½’æ¡£</button>
                </div>
                <div id="archive-list" class="space-y-4"></div>
            </div>
        </main>

        <nav class="nav-capsule">
            <button onclick="switchTab('home')" id="nav-home" class="nav-link active">ğŸ </button>
            <button onclick="switchTab('explore')" id="nav-explore" class="nav-link">ğŸ”</button>
            <button onclick="switchTab('books')" id="nav-books" class="nav-link">ğŸ“š</button>
            <button onclick="switchTab('import')" id="nav-import" class="nav-link">ğŸ“¥</button>
        </nav>
    </div>

    <section id="study-layer" class="fixed inset-0 bg-slate-50 dark:bg-slate-900 z-[200] hide flex flex-col">
        <header class="p-8 flex justify-between items-center">
            <button onclick="closeStudy()" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full shadow-sm flex items-center justify-center dark:text-white">âœ•</button>
            <div id="study-p" class="text-[10px] weight-black opacity-30 dark:text-white">0 / 0</div>
            <button onclick="playTTS()" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full shadow-sm flex items-center justify-center dark:text-white">ğŸ”Š</button>
        </header>
        <div class="flex-1 flex items-center justify-center p-6">
            <div class="card-container" id="studyCard">
                <div class="flip-card-inner" id="study-card-inner" onclick="handleCardFlip(event)">
                    <div class="card-face flex items-center justify-center px-10 text-center">
                        <span id="card-source" class="absolute top-6 px-3 py-1 bg-slate-100 dark:bg-slate-700 rounded-full text-[8px] weight-black opacity-40 uppercase tracking-widest dark:text-white">Source</span>
                        <h2 id="card-en" class="text-3xl weight-black italic tracking-tighter dark:text-white">Term</h2>
                    </div>
                    <div class="card-face card-back no-scrollbar overflow-y-auto">
                        <div class="back-content-wrapper py-10 space-y-8">
                            <div class="text-center px-4">
                                <h3 id="card-zh" class="text-2xl weight-black text-indigo-600 serif mb-4">ç¿»è¯‘</h3>
                                <div id="card-ai-box" class="text-xs serif text-slate-500 leading-relaxed space-y-4 text-left dark:text-slate-400"></div>
                            </div>
                            <div onclick="event.stopPropagation()" class="px-2 border-t border-slate-100 dark:border-slate-800 pt-4">
                                <p class="text-[8px] weight-black opacity-20 uppercase mb-2 dark:text-white">Notebook</p>
                                <textarea id="card-note" oninput="syncNote()" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl text-[10px] outline-none serif min-h-[100px] dark:text-white"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="p-10 pb-16 flex gap-4 max-w-2xl mx-auto w-full">
            <button onclick="finishSRS(1)" class="flex-1 py-5 bg-slate-100 dark:bg-slate-800 rounded-2xl weight-black text-[10px] uppercase text-slate-400 btn-active">é—å¿˜</button>
            <button onclick="finishSRS(2)" class="flex-1 py-5 bg-indigo-50 dark:bg-indigo-900/30 rounded-2xl weight-black text-[10px] uppercase text-indigo-400 btn-active">æ¨¡ç³Š</button>
            <button onclick="finishSRS(3)" class="flex-1 py-5 bg-indigo-600 text-white rounded-2xl weight-black text-[10px] uppercase shadow-lg shadow-indigo-100 btn-active">è®¤è¯†</button>
        </footer>
    </section>

    <div id="notice-layer" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[500] hide flex items-end sm:items-center justify-center p-4">
        <div class="w-full max-w-md bg-white dark:bg-slate-900 rounded-[2.5rem] p-8 space-y-6">
            <div class="flex justify-between items-center border-b dark:border-slate-800 pb-4">
                <h3 class="text-xl weight-black italic dark:text-white">ç³»ç»Ÿå…¬å‘Š</h3>
                <button onclick="toggleNotice(false)" class="text-xs opacity-40 weight-black uppercase dark:text-white">Close</button>
            </div>
            <div id="notice-content" class="max-h-96 overflow-y-auto space-y-4 no-scrollbar"></div>
        </div>
    </div>

    <div id="side-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[300] hide"></div>
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-72 bg-white z-[301] p-10 translate-x-full transition-transform duration-300 flex flex-col shadow-2xl">
        <div class="flex items-center gap-4 mb-8">
            <div id="user-avatar" class="w-12 h-12 rounded-2xl flex items-center justify-center text-white font-bold text-xl shadow-lg">?</div>
            <div>
                <p id="user-id-display" class="text-xs weight-black dark:text-white">æœªç™»å½•ç”¨æˆ·</p>
                <p class="text-[8px] opacity-40 uppercase font-bold dark:text-white">Lexi User ID</p>
            </div>
        </div>
        <div class="flex-1 space-y-8 overflow-y-auto no-scrollbar">
            <button onclick="showAnnouncements()" class="w-full flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl relative">
                <span class="text-xs font-bold">ç³»ç»Ÿå…¬å‘Š</span>
                <div id="new-notice-dot" class="dot hide"></div>
                <span class="opacity-30">ğŸ“£</span>
            </button>
            <div>
                <p class="text-[10px] weight-black opacity-30 mb-4 uppercase">å­¦ä¹ é™é‡: <span id="limit-val">20</span></p>
                <input type="range" id="daily-limit" min="5" max="100" step="5" class="w-full accent-indigo-600">
            </div>
            <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl">
                <span class="text-xs font-bold">å¤œé—´æ¨¡å¼</span>
                <input type="checkbox" id="dark-toggle" onchange="toggleDarkMode()" class="w-5 h-5 accent-indigo-600">
            </div>
            <div><p class="text-[10px] weight-black opacity-30 mb-4 uppercase italic">æ´»è·ƒè¯ä¹¦</p><div id="book-picker" class="space-y-3"></div></div>
        </div>
        <div class="pt-8 space-y-4">
            <button onclick="saveSettings()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl weight-black text-xs uppercase btn-active">ä¿å­˜è®¾ç½®</button>
            <button onclick="handleLogout()" class="w-full py-4 bg-slate-100 dark:bg-slate-800 text-red-500 rounded-2xl weight-black text-xs uppercase btn-active">é€€å‡º/ç™»å½•</button>
        </div>
    </aside>

    <script>
        const APP_ANNOUNCEMENTS = [
            { id: 1, date: "2026-02-11", title: "v7.9 äº¤äº’å›æ­£", body: "1. æ¢å¤å­¦ä¹ é¡µåº•éƒ¨åˆ¤å®šæŒ‰é’®ã€‚\n2. ä¹¦æ¶æ¢å¤æ·»åŠ è¯ä¹¦å…¥å£ã€‚\n3. åˆ†ç±»æ ‡ç­¾æ¢å¤æ¨ªå‘æ»‘åŠ¨ã€‚" }
        ];

        let state = {
            user: null, books: {}, mem: {}, settings: { dailyLimit: 20, selectedBooks: [], dark: false, lastNoticeId: 0 },
            activeTab: 'home', curCat: 'ALL', queue: [], idx: 0, categories: ["æ”¿æ²»", "ç»è´¸", "ç§‘æŠ€", "æ–‡åŒ–", "ä¿—è¯­"]
        };

        // --- æ ¸å¿ƒæ›´æ–°é€»è¾‘ï¼šé¦–é¡µå¯¹é½ ---
        function updateDash() {
            let n = 0, r = 0, masterCount = 0;
            const activeBooks = state.settings.selectedBooks;
            activeBooks.forEach(bk => {
                if(!state.books[bk]) return;
                state.books[bk].items.forEach(i => {
                    const m = state.mem[i.id] || {lv:0, isArchived: false};
                    if(m.isArchived) return;
                    if(m.lv === 0) n++; else if(m.lv < 5 && Date.now() >= (m.next||0)) r++;
                    else if(m.lv >= 5) masterCount++;
                });
            });

            document.getElementById('num-new').innerText = n;
            document.getElementById('num-rev').innerText = r;
            document.getElementById('mastered-count').innerText = masterCount;
            document.getElementById('active-book-count').innerText = activeBooks.length;
            
            // æè¿°æ–‡å­—é€»è¾‘
            const planText = document.getElementById('plan-text');
            if(activeBooks.length === 0) planText.innerText = "æœªé€‰ä¸­è¯ä¹¦";
            else if(activeBooks.length === 1) planText.innerText = activeBooks[0];
            else planText.innerText = `${activeBooks[0]} ç­‰`;
        }

        // --- æ ¸å¿ƒæ›´æ–°é€»è¾‘ï¼šä¹¦æ¶â€œ+â€å…¥å£ ---
        function renderBooks() {
            const colors = ["from-indigo-600 to-blue-700", "from-rose-500 to-pink-600", "from-emerald-500 to-teal-600"];
            const grid = document.getElementById('book-grid');
            let html = Object.keys(state.books).map((k, idx) => `
                <div onclick="openBook('${k}')" class="aspect-[3/4] rounded-3xl bg-gradient-to-br ${colors[idx%3]} p-6 flex flex-col justify-between text-white shadow-xl btn-active relative">
                    ${state.settings.selectedBooks.includes(k) ? '<div class="absolute top-4 right-4 text-[8px] font-bold bg-white/20 px-2 py-1 rounded-full uppercase">Active</div>' : ''}
                    <div><h4 class="text-lg weight-black serif leading-tight mt-2">${k}</h4></div>
                    <p class="text-[10px] weight-black opacity-70">${state.books[k].items.length} æ¡ç›®</p>
                </div>`).join('');
            
            // æ·»åŠ æ–°å»ºå…¥å£
            html += `
                <div onclick="switchTab('import')" class="aspect-[3/4] rounded-3xl border-2 border-dashed border-slate-200 dark:border-slate-700 flex flex-col items-center justify-center gap-2 opacity-40 btn-active">
                    <span class="text-4xl font-light dark:text-white">+</span>
                    <span class="text-[10px] weight-black uppercase dark:text-white">å¯¼å…¥/æ–°å»º</span>
                </div>`;
            grid.innerHTML = html;
        }

        // --- å…¶ä½™ä¿æŒåŠŸèƒ½çš„é©±åŠ¨é€»è¾‘ ---
        function handleLogin() {
            const p = document.getElementById('auth-phone').value;
            if(!p || document.getElementById('auth-code').value !== '1234') return alert("æµ‹è¯•ç 1234");
            state.user = p; localStorage.setItem('lexi_v7_user', p);
            document.getElementById('auth-screen').classList.add('hide');
            document.getElementById('app-content').classList.remove('hide');
            loadData();
        }

        function loadData() {
            const saved = localStorage.getItem(`lexi_v7_data_${state.user}`);
            if(saved) {
                const d = JSON.parse(saved);
                state.books = d.books || {}; state.mem = d.mem || {}; 
                state.settings = d.settings || { dailyLimit: 20, selectedBooks: [], dark: false, lastNoticeId: 0 };
                state.categories = d.categories || ["æ”¿æ²»", "ç»è´¸", "ç§‘æŠ€", "æ–‡åŒ–", "ä¿—è¯­"];
            } else {
                state.books = { "2026 MTI æ ¸å¿ƒè¯æ±‡": { items: [] } };
                state.settings = { dailyLimit: 20, selectedBooks: ["2026 MTI æ ¸å¿ƒè¯æ±‡"], dark: false, lastNoticeId: 0 };
            }
            state.settings.dark = false;
            document.documentElement.classList.remove('dark');
            updateUserInfo(); initQuote(); updateDash(); switchTab('home'); save();
        }

        function save() { localStorage.setItem(`lexi_v7_data_${state.user}`, JSON.stringify({ books: state.books, mem: state.mem, settings: state.settings, categories: state.categories })); }

        function switchTab(t) {
            state.activeTab = t;
            ['home','explore','books','import','book-detail','archive-mgr'].forEach(v => document.getElementById('view-'+v).classList.add('hide'));
            document.getElementById('view-'+t).classList.remove('hide');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const navId = ['book-detail','archive-mgr'].includes(t) ? 'nav-books' : 'nav-' + t;
            if(document.getElementById(navId)) document.getElementById(navId).classList.add('active');
            if(t === 'books') renderBooks();
            if(t === 'explore' || t === 'import') updateCatTags();
            if(t === 'explore') runSearch();
            if(t === 'archive-mgr') renderArchiveMgr();
        }

        function prepStudy(mode) {
            let pool = [];
            state.settings.selectedBooks.forEach(bk => {
                state.books[bk]?.items.forEach(i => {
                    const m = state.mem[i.id] || {lv:0, isArchived: false};
                    if(!m.isArchived) {
                        if(mode === 'new' && m.lv === 0) pool.push({...i, from: bk});
                        else if(mode === 'review' && m.lv > 0 && m.lv < 5 && Date.now() >= (m.next||0)) pool.push({...i, from: bk});
                    }
                });
            });
            if(!pool.length) return alert("æš‚æ— å¾…å­¦å†…å®¹");
            state.queue = mode === 'new' ? pool.slice(0, state.settings.dailyLimit) : pool.sort(() => Math.random() - 0.5).slice(0, 30);
            state.idx = 0; document.getElementById('study-layer').classList.remove('hide'); renderCard();
        }

        function renderCard() {
            const i = state.queue[state.idx];
            document.getElementById('studyCard').classList.remove('flipped');
            document.getElementById('card-en').innerText = i.en;
            document.getElementById('card-zh').innerText = i.zh;
            document.getElementById('card-source').innerText = i.from;
            document.getElementById('card-ai-box').innerHTML = i.ai.split('\n').map(l => `<p>${l}</p>`).join('');
            document.getElementById('card-note').value = state.mem[i.id]?.note || "";
            document.getElementById('study-p').innerText = `${state.idx + 1} / ${state.queue.length}`;
        }

        function finishSRS(score) {
            const i = state.queue[state.idx];
            if(!state.mem[i.id]) state.mem[i.id] = {lv:0, next:0, note:"", isArchived: false};
            const m = state.mem[i.id];
            if(score === 3) m.lv++; else if(score === 1) m.lv = Math.max(0, m.lv - 1);
            else if(score === 2) { state.queue.push(i); }
            const intervals = [0, 60000, 86400000, 259200000, 604800000, 1296000000];
            m.next = Date.now() + (score === 3 ? intervals[Math.min(m.lv, 5)] : 0);
            save(); state.idx++;
            if(state.idx < state.queue.length) renderCard(); else closeStudy();
        }

        function renderArchiveMgr() {
            const list = document.getElementById('archive-list');
            let items = [];
            state.settings.selectedBooks.forEach(bk => {
                state.books[bk].items.forEach(i => {
                    const m = state.mem[i.id];
                    if(m && m.lv >= 5 && !m.isArchived) items.push({...i, from: bk});
                });
            });
            if(!items.length) { list.innerHTML = `<div class="py-20 text-center opacity-10 weight-black italic dark:text-white">æš‚æ— è¯æ¡</div>`; return; }
            list.innerHTML = items.map(i => `
                <div class="card-base p-6 flex justify-between items-center">
                    <div><h5 class="weight-black dark:text-white">${i.en}</h5><p class="text-[8px] opacity-40 uppercase">${i.from}</p></div>
                    <button onclick="singleArchive('${i.id}')" class="text-[9px] weight-black text-indigo-600 px-3 py-1 rounded-lg uppercase">å½’æ¡£</button>
                </div>`).join('');
        }

        // --- å…¶ä½™é€šç”¨å‡½æ•° ---
        function toggleSidebar(s) {
            document.getElementById('sidebar').style.transform = s ? 'translateX(0)' : 'translateX(100%)';
            document.getElementById('side-overlay').classList.toggle('hide', !s);
            if(s) {
                document.getElementById('limit-val').innerText = state.settings.dailyLimit;
                document.getElementById('book-picker').innerHTML = Object.keys(state.books).map(k => `
                    <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-xl">
                        <span class="text-xs font-bold dark:text-white">${k}</span>
                        <input type="checkbox" value="${k}" ${state.settings.selectedBooks.includes(k)?'checked':''} class="book-chk w-5 h-5 accent-indigo-600">
                    </div>`).join('');
            }
        }
        function saveSettings() {
            state.settings.selectedBooks = Array.from(document.querySelectorAll('.book-chk:checked')).map(c => c.value);
            state.settings.dailyLimit = parseInt(document.getElementById('daily-limit').value);
            save(); toggleSidebar(false); updateDash();
        }
        function updateUserInfo() {
            const idDisp = document.getElementById('user-id-display');
            if(state.user) {
                idDisp.innerText = state.user.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
                const avatar = document.getElementById('user-avatar');
                avatar.style.backgroundColor = '#4F46E5'; avatar.innerText = state.user.slice(-1);
            }
        }
        function showAnnouncements() {
            document.getElementById('notice-content').innerHTML = APP_ANNOUNCEMENTS.map(a => `<div class="p-5 bg-slate-50 dark:bg-slate-800 rounded-2xl"><h4 class="weight-black text-sm dark:text-white">${a.title}</h4><p class="text-[11px] opacity-60 mt-2">${a.body.replace(/\n/g, '<br>')}</p></div>`).join('');
            toggleNotice(true);
        }
        function toggleNotice(s) { document.getElementById('notice-layer').classList.toggle('hide', !s); }
        function updateCatTags() {
            document.getElementById('cat-tags-container').innerHTML = ["ALL", ...state.categories].map(c => `<button onclick="setCatFilter('${c}')" class="px-5 py-2 rounded-full text-[10px] weight-black flex-shrink-0 transition-all ${state.curCat===c?'bg-indigo-600 text-white':'bg-white dark:bg-slate-800 dark:text-white shadow-sm'}">${c}</button>`).join('');
            document.getElementById('import-cat-sel').innerHTML = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('import-book-sel').innerHTML = Object.keys(state.books).map(k => `<option value="${k}">${k}</option>`).join('');
        }
        function setCatFilter(cat) { state.curCat = cat; updateCatTags(); runSearch(); }
        function runSearch() {
            const q = document.getElementById('search-box').value.toLowerCase();
            let all = []; Object.values(state.books).forEach(b => all = all.concat(b.items));
            const filtered = all.filter(i => (i.en.toLowerCase().includes(q) || i.zh.includes(q)) && (state.curCat === 'ALL' || i.cat === state.curCat));
            const container = document.getElementById('search-list');
            if(!filtered.length) { container.innerHTML = `<div class="py-20 text-center opacity-10 italic dark:text-white">NO DATA</div>`; return; }
            container.innerHTML = filtered.map(i => `
                <div class="card-base border border-slate-50 dark:border-slate-800 transition-all overflow-hidden" onclick="this.classList.toggle('expanded')">
                    <div class="p-6 flex justify-between items-center cursor-pointer">
                        <div class="flex-1"><h5 class="text-lg weight-black tracking-tighter dark:text-white">${i.en}</h5><span class="text-[8px] weight-black text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded-full uppercase">${i.cat}</span></div>
                        <span class="chevron transition-transform opacity-20 text-[10px] dark:text-white">â–¼</span>
                    </div>
                    <div class="expandable-content px-6 pb-6 border-t border-slate-50 dark:border-slate-800">
                        <div class="pt-4 space-y-4">
                            <p class="text-xl weight-black serif text-indigo-600">${i.zh}</p>
                            <div class="text-xs serif text-slate-500 dark:text-slate-400">${i.ai.replace(/\n/g, '<br>')}</div>
                            <div class="flex justify-end pt-2"><button onclick="deleteItem(event, '${i.id}')" class="text-[9px] text-red-400 weight-black uppercase">Delete</button></div>
                        </div>
                    </div>
                </div>`).join('');
        }
        function handleCardFlip(e) { if(!e.target.closest('textarea') && !e.target.closest('button')) document.getElementById('studyCard').classList.toggle('flipped'); }
        function syncNote() {
            const i = state.queue[state.idx];
            if(!state.mem[i.id]) state.mem[i.id] = { lv:0, next:0, note:"", isArchived: false };
            state.mem[i.id].note = document.getElementById('card-note').value;
            save();
        }
        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateDash(); }
        function toggleDarkMode() { state.settings.dark = document.getElementById('dark-toggle').checked; document.documentElement.classList.toggle('dark', state.settings.dark); save(); }
        function handleLogout() { if(confirm("ç¡®è®¤é€€å‡ºï¼Ÿ")) { localStorage.removeItem('lexi_v7_user'); location.reload(); } }
        function playTTS() { const i = state.queue[state.idx]; window.speechSynthesis.speak(new SpeechSynthesisUtterance(i.en)); }
        function initQuote() { document.getElementById('quote-en').innerText = "The limits of my language mean the limits of my world."; document.getElementById('quote-zh').innerText = "è¯­è¨€çš„è¾¹ç•Œï¼Œå³æ˜¯ä¸–ç•Œçš„è¾¹ç•Œã€‚"; }
        function singleArchive(id) { state.mem[id].isArchived = true; save(); renderArchiveMgr(); updateDash(); }
        function batchArchive() { state.settings.selectedBooks.forEach(bk => state.books[bk].items.forEach(i => { if((state.mem[i.id]?.lv||0)>=5) state.mem[i.id].isArchived=true; })); save(); renderArchiveMgr(); updateDash(); }
        function openBook(k) { state.activeBook = k; document.getElementById('book-title-h').innerText = k; switchTab('book-detail'); renderBookContent(); }
        function renderBookContent() { /* å¤ç”¨ search-list çš„é€»è¾‘è¿›è¡Œæ¸²æŸ“ */ }
        function deleteItem(e, id) { e.stopPropagation(); if(confirm("åˆ é™¤ï¼Ÿ")) { Object.keys(state.books).forEach(bk => state.books[bk].items = state.books[bk].items.filter(it => it.id !== id)); save(); runSearch(); updateDash(); } }
        function createNewCategory() { const n = prompt("åç§°:"); if(n) { state.categories.push(n); save(); updateCatTags(); } }
        function doImport() {
            const en = document.getElementById('in-en').value; const zh = document.getElementById('in-zh').value; const book = document.getElementById('import-book-sel').value;
            if(!en || !zh) return alert("å¿…å¡«");
            state.books[book].items.push({ id: 'u'+Date.now(), en, zh, cat: document.getElementById('import-cat-sel').value, ai: document.getElementById('in-ai').value });
            save(); alert("æˆåŠŸ"); updateDash();
        }

        if(localStorage.getItem('lexi_v7_user')) {
            state.user = localStorage.getItem('lexi_v7_user');
            document.getElementById('auth-screen').classList.add('hide');
            document.getElementById('app-content').classList.remove('hide');
            loadData();
        }
    </script>
</body>
</html>
