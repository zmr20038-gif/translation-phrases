<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LexiFlow Pro v5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #F8FAFC; --text: #1E293B; --card: #FFFFFF; --accent: #6366F1; }
        .dark { --bg: #0F172A; --text: #F1F5F9; --card: #1E293B; --accent: #818CF8; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.3s; overflow-x: hidden; }

        /* ä¾§è¾¹æ  */
        #settings-sidebar { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #settings-sidebar.open { transform: translateX(0); }

        /* å¡ç‰‡ç¿»è½¬ */
        .flip-card { perspective: 1000px; width: 100%; height: 420px; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            border-radius: 2.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem;
            background: var(--card); box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05);
        }
        .flip-card-back { transform: rotateY(180deg); border: 2px solid var(--accent); }

        /* ADD æŒ‰é’®åŠ¨ç”» */
        @keyframes added-pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .btn-added { animation: added-pop 0.3s ease-out; background-color: #10B981 !important; color: white !important; }

        .hide { display: none !important; }
        .nav-link.active { color: var(--accent); font-weight: 800; }
    </style>
</head>
<body class="pb-24">

    <header class="max-w-md mx-auto px-6 pt-12 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-[800] tracking-tighter">LexiFlow</h1>
            <p class="text-[10px] font-black opacity-30 uppercase tracking-[0.2em]">Adaptive Learning</p>
        </div>
        <button onclick="toggleSidebar(true)" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow-sm">âš™ï¸</button>
    </header>

    <main id="view-home" class="max-w-md mx-auto px-6 mt-10">
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div onclick="openStudy('new')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.2rem] shadow-sm cursor-pointer border border-transparent hover:border-indigo-200 transition-all">
                <span class="text-[9px] font-black opacity-30 uppercase tracking-widest">éœ€å­¦ä¹  New</span>
                <p id="num-new" class="text-4xl font-black mt-2 text-indigo-500">0</p>
            </div>
            <div onclick="openStudy('review')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.2rem] shadow-sm cursor-pointer border border-transparent hover:border-emerald-200 transition-all">
                <span class="text-[9px] font-black opacity-30 uppercase tracking-widest">å¤ä¹  Review</span>
                <p id="num-review" class="text-4xl font-black mt-2 text-emerald-500">0</p>
            </div>
        </div>
        <div class="bg-indigo-600 p-8 rounded-[2.5rem] text-white shadow-xl shadow-indigo-100 relative overflow-hidden">
            <div class="relative z-10">
                <h3 class="font-black text-[10px] opacity-60 uppercase tracking-widest mb-2">Today's Progress</h3>
                <p class="text-lg font-bold">è¯ä¹¦ï¼š<span id="current-book-display">é»˜è®¤ä¸“ä¸šè¯åº“</span></p>
                <div class="mt-4 bg-white/20 h-1.5 rounded-full overflow-hidden">
                    <div id="goal-progress" class="bg-white h-full transition-all duration-700" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </main>

    <main id="view-explore" class="max-w-md mx-auto px-6 mt-8 hide">
        <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-2">
            <button onclick="setFilter('all')" class="filter-tag px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm border border-transparent">å…¨éƒ¨</button>
            <button onclick="setFilter('legal')" class="filter-tag px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">âš–ï¸ æ³•å¾‹</button>
            <button onclick="setFilter('gaming')" class="filter-tag px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">ğŸ® æ¸¸æˆ</button>
            <button onclick="setFilter('food')" class="filter-tag px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">ğŸ³ é£Ÿç‰©</button>
        </div>
        <div id="explore-list" class="space-y-4 pb-12"></div>
    </main>

    <div id="settings-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-black/10 backdrop-blur-sm z-[300] hide"></div>
    <aside id="settings-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-900 z-[301] shadow-2xl p-8 flex flex-col">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-2xl font-black tracking-tighter">Preferences</h2>
            <button onclick="toggleSidebar(false)" class="text-xl">âœ•</button>
        </div>

        <div class="flex-1 space-y-10">
            <div>
                <label class="text-[10px] font-black opacity-30 uppercase tracking-widest block mb-4">Interface</label>
                <button onclick="toggleDarkMode()" id="mode-btn" class="w-full py-4 bg-slate-50 dark:bg-slate-800 rounded-2xl flex justify-between px-5 items-center">
                    <span class="font-bold text-sm">æš—è‰²æ¨¡å¼</span>
                    <span id="mode-icon">ğŸŒ</span>
                </button>
            </div>

            <div>
                <label class="text-[10px] font-black opacity-30 uppercase tracking-widest block mb-4">Select Vocabulary Book</label>
                <select id="book-select" onchange="changeBook(this.value)" class="w-full py-4 bg-slate-50 dark:bg-slate-800 rounded-2xl px-4 font-bold text-sm outline-none">
                    <option value="default">é»˜è®¤ä¸“ä¸šè¯åº“</option>
                    <option value="gre">GRE æ ¸å¿ƒè¯æ±‡</option>
                    <option value="ielts">é›…æ€ç²¾é€‰è¯æ±‡</option>
                </select>
            </div>

            <div>
                <label class="text-[10px] font-black opacity-30 uppercase tracking-widest block mb-2">Daily Learning Goal</label>
                <div class="flex justify-between items-center mb-4">
                    <span id="goal-val" class="text-2xl font-black text-indigo-500">10</span>
                    <span class="text-xs font-bold opacity-30">Words / Day</span>
                </div>
                <input type="range" min="5" max="50" step="5" value="10" oninput="updateGoal(this.value)" class="w-full h-1.5 bg-slate-100 rounded-full appearance-none accent-indigo-600">
            </div>

            <div class="pt-10">
                <button onclick="clearData('progress')" class="w-full py-4 text-[10px] font-black uppercase tracking-widest text-orange-400 border border-orange-100 rounded-2xl mb-3">Clear Progress Only</button>
                <button onclick="clearData('all')" class="w-full py-4 text-[10px] font-black uppercase tracking-widest text-red-500 bg-red-50 rounded-2xl">Reset Everything</button>
            </div>
        </div>
    </aside>

    <section id="study-layer" class="fixed inset-0 bg-white dark:bg-slate-900 z-[200] hide flex flex-col p-8">
        <div class="flex justify-between items-center mb-6">
            <button onclick="closeStudy()" class="text-2xl opacity-20">âœ•</button>
            <div id="study-progress" class="text-[10px] font-black opacity-30 tracking-widest">1 / 10</div>
            <div class="w-6"></div>
        </div>
        <div class="flex-1 flex items-center justify-center">
            <div class="flip-card" id="mainCard">
                <div class="flip-card-inner">
                    <div class="flip-card-front" onclick="this.parentElement.parentElement.classList.toggle('flipped')">
                        <span id="card-cat" class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-4">CATEGORY</span>
                        <h2 id="card-en" class="text-4xl font-black text-center tracking-tighter">Term</h2>
                        <p class="mt-12 text-[9px] opacity-20 uppercase font-black tracking-widest">Tap to see definition</p>
                    </div>
                    <div class="flip-card-back">
                        <h3 id="card-zh" class="text-2xl font-bold text-indigo-500 mb-4">ç¿»è¯‘</h3>
                        <p id="card-d" class="text-sm opacity-60 text-center leading-relaxed px-4">è§£é‡Šå†…å®¹</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-3 mt-8" id="study-controls">
            <button onclick="handleLearn(1)" class="py-5 bg-slate-100 dark:bg-slate-800 rounded-[1.8rem] font-black text-[10px] uppercase">Forget</button>
            <button onclick="handleLearn(2)" class="py-5 bg-indigo-50 dark:bg-slate-800 rounded-[1.8rem] font-black text-[10px] text-indigo-400 uppercase">Hard</button>
            <button onclick="handleLearn(3)" class="py-5 bg-indigo-600 rounded-[1.8rem] font-black text-[10px] text-white shadow-lg uppercase">Know</button>
        </div>
    </section>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-64 h-20 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl rounded-[2.5rem] shadow-2xl flex items-center justify-around border border-white/20 z-[100]">
        <button onclick="switchTab('home')" id="btn-home" class="nav-link active text-xl">ğŸ </button>
        <button onclick="switchTab('explore')" id="btn-explore" class="nav-link text-slate-300 text-xl">ğŸ”</button>
    </nav>

    <script>
        // è¯åº“ A-Z
        const RAW_LIB = [
            { id:'g1', cat:'gaming', en:'Aggro', zh:'ä»‡æ¨å€¼', d:'è¡¡é‡æ€ªç‰©å¯¹ä¸åŒç©å®¶æ”»å‡»æ¬²æœ›çš„æ•°å€¼ã€‚' },
            { id:'f1', cat:'food', en:'Al Dente', zh:'å¼¹ç‰™', d:'å½¢å®¹æ„é¢æˆ–ç±³é¥­ä¸­å¿ƒä¿ç•™ä¸€ä¸åš¼åŠ²ã€‚' },
            { id:'l1', cat:'legal', en:'Bona Fide', zh:'å–„æ„', d:'æ³•å¾‹æœ¯è¯­ï¼ŒæŒ‡ä¸»è§‚å‡ºäºçœŸè¯šã€æ— æ¬ºè¯ˆæ„å›¾ã€‚' },
            { id:'l3', cat:'legal', en:'Due Diligence', zh:'å°½èŒè°ƒæŸ¥', d:'å¯¹èµ„äº§åŠé£é™©çš„å…¨é¢è°ƒæŸ¥ã€‚' },
            { id:'g2', cat:'gaming', en:'Fog of War', zh:'æˆ˜äº‰è¿·é›¾', d:'é®è”½æœªæ¢ç´¢åŒºåŸŸçš„è§†è§‰æ•ˆæœã€‚' },
            { id:'l2', cat:'legal', en:'Force Majeure', zh:'ä¸å¯æŠ—åŠ›', d:'ä¸èƒ½é¢„è§ã€é¿å…ä¸”å…‹æœçš„å®¢è§‚æƒ…å†µã€‚' },
            { id:'f2', cat:'food', en:'Maillard Reaction', zh:'ç¾æ‹‰å¾·ååº”', d:'åŠ çƒ­æ—¶å‘ç”Ÿçš„è¤å˜ååº”ï¼Œé¦™æ°”ä¹‹æºã€‚' },
            { id:'g3', cat:'gaming', en:'Metagame', zh:'å…ƒæ¸¸æˆ', d:'å½“å‰æœ€é«˜æ•ˆçš„æˆ˜æœ¯ç»„åˆè¶‹åŠ¿ã€‚' },
            { id:'l4', cat:'legal', en:'Statute of Limitations', zh:'è¯‰è®¼æ—¶æ•ˆ', d:'æ³•å¾‹è§„å®šæƒåˆ©è¡Œä½¿çš„æ—¶é—´é™åˆ¶ã€‚' },
            { id:'f3', cat:'food', en:'Umami', zh:'é²œå‘³', d:'é™¤äº†é…¸ç”œè‹¦å’¸ä¹‹å¤–çš„ç¬¬äº”ç§åŸºæœ¬å‘³é“ã€‚' }
        ].sort((a,b) => a.en.localeCompare(b.en));

        let state = {
            mem: JSON.parse(localStorage.getItem('lexi_v6_mem') || '{}'),
            notes: JSON.parse(localStorage.getItem('lexi_v6_notes') || '{}'),
            goal: parseInt(localStorage.getItem('lexi_v6_goal') || '10'),
            dark: localStorage.getItem('lexi_v6_dark') === 'true',
            book: localStorage.getItem('lexi_v6_book') || 'default',
            filter: 'all', queue: [], idx: 0
        };

        // --- ä¾§è¾¹æ é€»è¾‘ ---
        function toggleSidebar(show) {
            document.getElementById('settings-sidebar').classList.toggle('open', show);
            document.getElementById('settings-overlay').classList.toggle('hide', !show);
        }

        function toggleDarkMode() {
            state.dark = !state.dark;
            document.body.classList.toggle('dark', state.dark);
            document.getElementById('mode-icon').innerText = state.dark ? 'ğŸŒ™' : 'ğŸŒ';
            localStorage.setItem('lexi_v6_dark', state.dark);
        }

        function updateGoal(val) {
            state.goal = parseInt(val);
            document.getElementById('goal-val').innerText = val;
            localStorage.setItem('lexi_v6_goal', val);
            autoAllocateNew(); // è°ƒæ•´æ»‘å—æ—¶ç«‹å³è¡¥é½éœ€å­¦ä¹ æ•°é‡
            updateHomeCounts();
        }

        function changeBook(val) {
            state.book = val;
            localStorage.setItem('lexi_v6_book', val);
            document.getElementById('current-book-display').innerText = 
                val === 'default' ? 'é»˜è®¤ä¸“ä¸šè¯åº“' : (val === 'gre' ? 'GRE æ ¸å¿ƒè¯æ±‡' : 'é›…æ€ç²¾é€‰è¯æ±‡');
            alert(`å·²åˆ‡æ¢åˆ°ï¼š${val.toUpperCase()}ã€‚ç³»ç»Ÿå°†æ ¹æ®æ–°è¯ä¹¦åˆ†é…ä»»åŠ¡ã€‚`);
        }

        // --- æ ¸å¿ƒè°ƒåº¦ï¼šè¡¥é½æ–°è¯ ---
        function autoAllocateNew() {
            // è®¡ç®—å½“å‰æ­£åœ¨å­¦ä¹ ä¸­ï¼ˆlv=0ï¼‰çš„è¯æ¡æ•°é‡
            let currentlyLearning = Object.keys(state.mem).filter(id => state.mem[id].lv === 0);
            
            // å¦‚æœä¸è¶³æ¯æ—¥ç›®æ ‡ï¼Œä»æœªå­¦è¿‡çš„æ± å­é‡Œæ
            if (currentlyLearning.length < state.goal) {
                let unlearned = RAW_LIB.filter(i => !state.mem[i.id]);
                let needed = state.goal - currentlyLearning.length;
                
                // éšæœºæ´—ç‰Œæ± å­
                unlearned.sort(() => Math.random() - 0.5);
                
                for (let i = 0; i < Math.min(needed, unlearned.length); i++) {
                    state.mem[unlearned[i].id] = { lv: 0, next: 0 };
                }
                save();
            }
        }

        // --- å­¦ä¹ ä¸å¤ä¹  ---
        function openStudy(type) {
            const now = Date.now();
            if(type === 'new') {
                state.queue = RAW_LIB.filter(i => state.mem[i.id] && state.mem[i.id].lv === 0).slice(0, state.goal);
            } else {
                state.queue = RAW_LIB.filter(i => {
                    const m = state.mem[i.id];
                    return m && m.lv > 0 && now >= m.next;
                });
            }
            if(state.queue.length === 0) return alert("å½“å‰æ²¡æœ‰å¾…å¤„ç†çš„ä»»åŠ¡ï¼");
            state.idx = 0;
            document.getElementById('study-layer').classList.remove('hide');
            showStudyCard();
        }

        function handleLearn(score) {
            document.getElementById('mainCard').classList.add('flipped');
            document.getElementById('study-controls').style.pointerEvents = 'none';

            const item = state.queue[state.idx];
            const m = state.mem[item.id];
            
            if(score === 3) m.lv += 1;
            else if(score === 1) m.lv = Math.max(1, m.lv - 1);

            const intervals = [0, 0.1, 1, 2, 4, 7, 15, 30, 60];
            m.next = Date.now() + (intervals[Math.min(m.lv, 8)] * 86400000);
            save();

            setTimeout(() => {
                state.idx++;
                if(state.idx < state.queue.length) showStudyCard();
                else closeStudy();
            }, 1000);
        }

        // --- æ¢ç´¢é¡µåé¦ˆä¼˜åŒ– ---
        function renderExplore() {
            const container = document.getElementById('explore-list');
            const filtered = RAW_LIB.filter(i => state.filter === 'all' || i.cat === state.filter);
            
            container.innerHTML = filtered.map(i => `
                <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-6 shadow-sm border border-slate-50 dark:border-slate-700">
                    <div class="flex justify-between items-start" onclick="toggleDetail('${i.id}')">
                        <div>
                            <span class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">${i.cat}</span>
                            <h4 class="text-lg font-black mt-1 tracking-tighter">${i.en}</h4>
                        </div>
                        <button id="btn-add-${i.id}" onclick="addToPlan(event, '${i.id}')" 
                                class="transition-all duration-300 text-[10px] font-black ${state.mem[i.id] ? 'btn-added' : 'bg-indigo-50 dark:bg-slate-700 text-indigo-500'} px-4 py-2 rounded-full">
                            ${state.mem[i.id] ? 'âœ“ ADDED' : '+ ADD'}
                        </button>
                    </div>
                    <div id="detail-${i.id}" class="hide mt-4 pt-4 border-t border-slate-50 dark:border-slate-700">
                        <p class="text-sm font-bold text-indigo-500 mb-2">${i.zh}</p>
                        <p class="text-xs opacity-60 mb-4">${i.d}</p>
                        <div class="bg-slate-50 dark:bg-slate-900 p-3 rounded-xl">
                            <textarea onchange="saveNote('${i.id}', this.value)" placeholder="My personal notes..." class="w-full bg-transparent text-xs focus:outline-none min-h-[60px]">${state.notes[i.id] || ''}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addToPlan(e, id) {
            e.stopPropagation();
            if(state.mem[id]) return;
            
            const btn = document.getElementById(`btn-add-${id}`);
            btn.classList.add('btn-added');
            btn.innerHTML = 'âœ“ ADDED';
            
            state.mem[id] = { lv: 0, next: 0 };
            save();
            updateHomeCounts();
        }

        // --- é€šç”¨æ–¹æ³• ---
        function updateHomeCounts() {
            const news = RAW_LIB.filter(i => state.mem[i.id] && state.mem[i.id].lv === 0).length;
            const reviews = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && Date.now() >= state.mem[i.id].next).length;
            document.getElementById('num-new').innerText = news;
            document.getElementById('num-review').innerText = reviews;
            
            // è¿›åº¦æ¡é€»è¾‘ï¼šè¿™é‡Œå®šä¹‰ä¸ºï¼š(å·²å­¦å®Œ/ç›®æ ‡)*100
            let finishedToday = RAW_LIB.filter(i => state.mem[i.id] && state.mem[i.id].lv > 0 && state.mem[i.id].next > Date.now()).length;
            document.getElementById('goal-progress').style.width = Math.min(100, (finishedToday / state.goal) * 100) + '%';
        }

        function clearData(type) {
            if(!confirm("Are you sure? This cannot be undone.")) return;
            if(type === 'all') { localStorage.clear(); location.reload(); }
            else { state.mem = {}; save(); autoAllocateNew(); updateHomeCounts(); toggleSidebar(false); }
        }

        function save() { localStorage.setItem('lexi_v6_mem', JSON.stringify(state.mem)); }
        function showStudyCard() {
            const item = state.queue[state.idx];
            document.getElementById('mainCard').classList.remove('flipped');
            document.getElementById('card-en').innerText = item.en;
            document.getElementById('card-zh').innerText = item.zh;
            document.getElementById('card-d').innerText = item.d;
            document.getElementById('card-cat').innerText = item.cat;
            document.getElementById('study-progress').innerText = `${state.idx + 1} / ${state.queue.length}`;
            document.getElementById('study-controls').style.pointerEvents = 'auto';
        }
        function toggleDetail(id) { document.getElementById(`detail-${id}`).classList.toggle('hide'); }
        function saveNote(id, val) { state.notes[id] = val; localStorage.setItem('lexi_v6_notes', JSON.stringify(state.notes)); }
        function switchTab(tab) {
            document.getElementById('view-home').classList.toggle('hide', tab !== 'home');
            document.getElementById('view-explore').classList.toggle('hide', tab !== 'explore');
            document.getElementById('btn-home').classList.toggle('active', tab === 'home');
            document.getElementById('btn-explore').classList.toggle('active', tab === 'explore');
            if(tab === 'explore') renderExplore();
        }
        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateHomeCounts(); }
        function setFilter(cat) { state.filter = cat; renderExplore(); }

        // åˆå§‹åŒ–
        if(state.dark) { document.body.classList.add('dark'); document.getElementById('mode-icon').innerText = 'ğŸŒ™'; }
        document.getElementById('goal-val').innerText = state.goal;
        document.getElementById('book-select').value = state.book;
        autoAllocateNew(); // å¯åŠ¨å³åˆ†é…
        updateHomeCounts();
    </script>
</body>
</html>
