<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LexiFlow Ultimate v6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #F8FAFC; --text: #1E293B; --card: #FFFFFF; --accent: #6366F1; }
        .dark { --bg: #0F172A; --text: #F1F5F9; --card: #1E293B; --accent: #818CF8; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.3s; overflow-x: hidden; }

        /* ä¾§è¾¹æ  */
        #settings-sidebar { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #settings-sidebar.open { transform: translateX(0); }

        /* å¡ç‰‡åŠ¨ç”»ä¸æ‰‹åŠ¿ */
        .card-container { perspective: 1000px; width: 100%; height: 450px; position: relative; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; cursor: pointer; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 2.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; background: var(--card); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); }
        .card-back { transform: rotateY(180deg); border: 2px solid var(--accent); }

        /* ç»Ÿè®¡å›¾è¡¨å ä½ */
        .stat-bar { height: 8px; border-radius: 4px; background: #E2E8F0; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--accent); transition: width 0.5s ease; }

        .hide { display: none !important; }
        .active-tab { color: var(--accent); transform: translateY(-4px); }
    </style>
</head>
<body class="pb-24">

    <header class="max-w-md mx-auto px-6 pt-10 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-[900] tracking-tighter italic">LexiFlow<span class="text-indigo-500">.</span></h1>
            <p id="rank-tag" class="text-[9px] font-black opacity-40 uppercase tracking-widest text-indigo-600">å¾‹æ”¿å…ˆé”‹ Lv.1</p>
        </div>
        <div class="flex gap-3">
            <button onclick="switchTab('stats')" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow-sm text-sm">ğŸ“Š</button>
            <button onclick="toggleSidebar(true)" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow-sm">âš™ï¸</button>
        </div>
    </header>

    <main id="view-home" class="max-w-md mx-auto px-6 mt-8">
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div onclick="openStudy('new')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] shadow-sm active:scale-95 transition-all border-b-4 border-indigo-100 dark:border-slate-700">
                <span class="text-[9px] font-black opacity-30 uppercase tracking-widest">éœ€å­¦ä¹ </span>
                <p id="num-new" class="text-4xl font-black mt-1 text-indigo-500">0</p>
            </div>
            <div onclick="openStudy('review')" class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] shadow-sm active:scale-95 transition-all border-b-4 border-emerald-100 dark:border-slate-700">
                <span class="text-[9px] font-black opacity-30 uppercase tracking-widest">å¾…å¤ä¹ </span>
                <p id="num-review" class="text-4xl font-black mt-1 text-emerald-500">0</p>
            </div>
        </div>

        <div class="bg-indigo-600 p-8 rounded-[3rem] text-white shadow-xl shadow-indigo-200 relative overflow-hidden">
            <div class="flex justify-between items-start mb-6">
                <h3 class="font-black text-[10px] opacity-60 uppercase tracking-widest">Next Review</h3>
                <span id="countdown" class="text-[10px] font-bold bg-white/20 px-3 py-1 rounded-full italic">å‡†å¤‡å°±ç»ª</span>
            </div>
            <p class="text-xl font-bold leading-tight mb-4">"Words are our most inexhaustible source of magic."</p>
            <div class="stat-bar bg-white/20"><div id="home-progress" class="stat-fill bg-white" style="width: 30%"></div></div>
        </div>
    </main>

    <main id="view-stats" class="max-w-md mx-auto px-6 mt-8 hide">
        <h2 class="text-2xl font-black mb-6">è®°å¿†æ•°æ®ä¸­å¿ƒ</h2>
        <div class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] mb-6 shadow-sm">
            <p class="text-[10px] font-black opacity-30 uppercase tracking-widest mb-4">è‰¾å®¾æµ©æ–¯åˆ†å¸ƒ (è®°å¿†æŒä¹…åº¦)</p>
            <div id="ebbinghaus-stats" class="space-y-4">
                </div>
        </div>
        <div class="bg-emerald-500 p-6 rounded-[2.5rem] text-white">
            <p class="text-xs opacity-80">ç´¯è®¡æŒæ¡è¯æ¡</p>
            <p id="total-mastered" class="text-4xl font-black">0</p>
        </div>
    </main>

    <main id="view-explore" class="max-w-md mx-auto px-6 mt-8 hide">
        <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar">
            <button onclick="setFilter('all')" class="px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">å…¨éƒ¨</button>
            <button onclick="setFilter('legal')" class="px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">âš–ï¸ æ³•å¾‹</button>
            <button onclick="setFilter('gaming')" class="px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">ğŸ® æ¸¸æˆ</button>
            <button onclick="setFilter('food')" class="px-5 py-2 bg-white dark:bg-slate-800 rounded-full text-xs font-bold shadow-sm">ğŸ³ é£Ÿç‰©</button>
        </div>
        <div id="explore-list" class="space-y-4 pb-20"></div>
    </main>

    <section id="study-layer" class="fixed inset-0 bg-white dark:bg-slate-900 z-[200] hide flex flex-col p-8">
        <div class="flex justify-between items-center mb-6">
            <button onclick="closeStudy()" class="text-2xl opacity-20">âœ•</button>
            <div id="study-progress" class="text-[10px] font-black opacity-30 tracking-widest">1 / 10</div>
            <button onclick="speakWord()" class="text-xl">ğŸ”Š</button>
        </div>
        
        <div class="flex-1 flex items-center justify-center">
            <div class="card-container" id="studyCard">
                <div class="flip-card-inner" onclick="this.parentElement.classList.toggle('flipped')">
                    <div class="card-face card-front">
                        <span id="card-cat" class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-4">Category</span>
                        <h2 id="card-en" class="text-5xl font-[900] tracking-tighter text-center">Word</h2>
                        <p class="mt-20 text-[9px] opacity-20 font-black tracking-widest uppercase animate-bounce">ç‚¹å‡»æˆ–æ»‘åŠ¨</p>
                    </div>
                    <div class="card-face card-back">
                        <h3 id="card-zh" class="text-2xl font-bold text-indigo-500 mb-2">ç¿»è¯‘</h3>
                        <p id="card-d" class="text-sm opacity-50 text-center leading-relaxed mb-6 px-4 italic">è¯¦ç»†å®šä¹‰...</p>
                        <div class="w-full p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl">
                            <span class="text-[8px] font-black opacity-30 uppercase block mb-1">ğŸ¬ AI åœºæ™¯è”æƒ³</span>
                            <p id="card-example" class="text-xs leading-relaxed font-medium">Loading classic scene...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mt-8">
            <button onclick="handleLearn(1)" class="py-5 bg-slate-100 dark:bg-slate-800 rounded-[2rem] font-black text-[10px] uppercase">Forget</button>
            <button onclick="handleLearn(2)" class="py-5 bg-indigo-50 dark:bg-slate-800 rounded-[2rem] font-black text-[10px] text-indigo-400 uppercase">Hard</button>
            <button onclick="handleLearn(3)" class="py-5 bg-indigo-600 rounded-[2rem] font-black text-[10px] text-white shadow-lg uppercase">Know</button>
        </div>
    </section>

    <div id="settings-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-black/10 backdrop-blur-sm z-[300] hide"></div>
    <aside id="settings-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-900 z-[301] shadow-2xl p-8 overflow-y-auto">
        <h2 class="text-2xl font-black mb-10">Lexi Settings</h2>
        
        <div class="space-y-8">
            <div>
                <label class="text-[10px] font-black opacity-30 uppercase mb-3 block tracking-widest">Interface</label>
                <button onclick="toggleDarkMode()" class="w-full p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl flex justify-between font-bold text-sm">
                    <span>å¤–è§‚æ¨¡å¼</span><span id="mode-icon">ğŸŒ</span>
                </button>
            </div>

            <div>
                <label class="text-[10px] font-black opacity-30 uppercase mb-3 block tracking-widest">Import Dictionary (.txt)</label>
                <input type="file" id="fileInput" onchange="handleFileUpload(event)" class="text-xs font-bold block w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-600">
            </div>

            <div>
                <label class="text-[10px] font-black opacity-30 uppercase mb-2 block tracking-widest">Daily Goal</label>
                <div class="flex justify-between font-black text-indigo-500 mb-2"><span id="goal-val">10</span><span>Words</span></div>
                <input type="range" min="5" max="50" step="5" value="10" oninput="updateGoal(this.value)" class="w-full h-1.5 bg-slate-100 rounded-full appearance-none accent-indigo-600">
            </div>

            <div class="pt-6 space-y-3">
                <button onclick="exportData()" class="w-full py-4 bg-emerald-50 text-emerald-600 text-[10px] font-black uppercase rounded-2xl tracking-widest">Export Backup (JSON)</button>
                <button onclick="clearData()" class="w-full py-4 text-red-500 text-[10px] font-black uppercase rounded-2xl tracking-widest border border-red-50">Reset All Data</button>
            </div>
        </div>
    </aside>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-72 h-20 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl rounded-[2.5rem] shadow-2xl flex items-center justify-around z-[100] px-4">
        <button onclick="switchTab('home')" id="btn-home" class="nav-link text-2xl p-3 active-tab">ğŸ </button>
        <button onclick="switchTab('explore')" id="btn-explore" class="nav-link text-2xl p-3 opacity-30">ğŸ”</button>
        <button onclick="switchTab('stats')" id="btn-stats" class="nav-link text-2xl p-3 opacity-30">ğŸ“ˆ</button>
    </nav>

    <script>
        // æ ¸å¿ƒè¯åº“
        let RAW_LIB = [
            { id:'l1', cat:'legal', en:'Bona Fide', zh:'å–„æ„', d:'ä¸»è§‚å‡ºäºçœŸè¯šã€æ— æ¬ºè¯ˆæ„å›¾ã€‚', scenes: ["ã€Šé‡‘è£…å¾‹å¸ˆã€‹ï¼šHarvey è´¨ç–‘å¯¹æ–¹æ˜¯å¦ Bona Fide å±¥è¡ŒåˆåŒã€‚"] },
            { id:'g1', cat:'gaming', en:'Aggro', zh:'ä»‡æ¨å€¼', d:'æ€ªç‰©å¯¹ç©å®¶æ”»å‡»æ¬²æœ›çš„æ•°å€¼ã€‚', scenes: ["ã€Šå¤´å·ç©å®¶ã€‹ï¼šåœ¨è¿™ç§ç­‰çº§çš„å‰¯æœ¬é‡Œï¼Œåƒä¸‡åˆ«ä¹±æ‹‰ Aggroã€‚"] },
            { id:'f1', cat:'food', en:'Al Dente', zh:'å¼¹ç‰™', d:'æ„é¢ä¸­å¿ƒä¿ç•™ä¸€ä¸åš¼åŠ²ã€‚', scenes: ["ã€Šç¾é£Ÿæ€»åŠ¨å‘˜ã€‹ï¼šå®Œç¾çš„æ„å¤§åˆ©é¢å¿…é¡»ä¿æŒ Al Dente çš„å£æ„Ÿã€‚"] },
            { id:'l2', cat:'legal', en:'Pro Bono', zh:'å…¬ç›ŠæœåŠ¡', d:'ä¸ºå…¬ä¼—åˆ©ç›Šæä¾›çš„å…è´¹æ³•å¾‹æœåŠ¡ã€‚', scenes: ["ã€Šå‚²éª¨è´¤å¦»ã€‹ï¼šAlicia å†³å®šæ¥æ‰‹è¿™ä¸ª Pro Bono æ¡ˆä»¶ã€‚"] },
            { id:'l3', cat:'legal', en:'Subpoena', zh:'ä¼ ç¥¨', d:'æ³•é™¢ä¼ å”¤è¯äººåˆ°åº­çš„å‘½ä»¤ã€‚', scenes: ["ã€Šçº¸ç‰Œå±‹ã€‹ï¼šä»–æ”¶åˆ°äº†ä¸€ä»½æ¥è‡ªå›½ä¼šçš„ Subpoenaã€‚"] }
        ];

        let state = {
            mem: JSON.parse(localStorage.getItem('lexi_v7_mem') || '{}'),
            notes: JSON.parse(localStorage.getItem('lexi_v7_notes') || '{}'),
            goal: parseInt(localStorage.getItem('lexi_v7_goal') || '10'),
            dark: localStorage.getItem('lexi_v7_dark') === 'true',
            filter: 'all', queue: [], idx: 0
        };

        // --- åˆå§‹åŒ– & è”åŠ¨ ---
        function init() {
            if(state.dark) document.body.classList.add('dark');
            document.getElementById('goal-val').innerText = state.goal;
            autoAllocate();
            updateDashboard();
            renderStats();
        }

        function autoAllocate() {
            let learning = Object.keys(state.mem).filter(id => state.mem[id].lv === 0);
            if(learning.length < state.goal) {
                let pool = RAW_LIB.filter(i => !state.mem[i.id]).sort(() => Math.random() - 0.5);
                for(let i=0; i < Math.min(state.goal - learning.length, pool.length); i++) {
                    state.mem[pool[i].id] = { lv: 0, next: 0 };
                }
                save();
            }
        }

        // --- å­¦ä¹ é€»è¾‘ (å« AI åœºæ™¯) ---
        function openStudy(type) {
            const now = Date.now();
            state.queue = RAW_LIB.filter(i => {
                const m = state.mem[i.id];
                return type === 'new' ? (m && m.lv === 0) : (m && m.lv > 0 && now >= m.next);
            }).slice(0, state.goal);
            
            if(!state.queue.length) return alert("æš‚æ— å¾…å¤„ç†è¯æ¡ï¼");
            state.idx = 0;
            document.getElementById('study-layer').classList.remove('hide');
            showCard();
        }

        function showCard() {
            const item = state.queue[state.idx];
            const card = document.getElementById('studyCard');
            card.classList.remove('flipped');
            document.getElementById('card-en').innerText = item.en;
            document.getElementById('card-zh').innerText = item.zh;
            document.getElementById('card-d').innerText = item.d;
            document.getElementById('card-cat').innerText = item.cat;
            document.getElementById('study-progress').innerText = `${state.idx+1} / ${state.queue.length}`;
            
            // æ¨¡æ‹Ÿå½±è§†åœºæ™¯ç”Ÿæˆ
            const scenePool = item.scenes || ["ã€Šè€å‹è®°ã€‹ä¸­æŸä¸ªæ—¥å¸¸å¯¹è¯è¯­å¢ƒã€‚"];
            document.getElementById('card-example').innerText = scenePool[Math.floor(Math.random()*scenePool.length)];
        }

        function handleLearn(score) {
            // Haptic feedback
            if(window.navigator.vibrate) window.navigator.vibrate(10);
            
            const item = state.queue[state.idx];
            const m = state.mem[item.id];
            if(score === 3) m.lv += 1; else if(score === 1) m.lv = Math.max(1, m.lv - 1);
            
            const intervals = [0, 0.1, 1, 2, 4, 7, 15, 30, 60];
            m.next = Date.now() + (intervals[Math.min(m.lv, 8)] * 86400000);
            save();

            document.getElementById('studyCard').classList.add('flipped');
            setTimeout(() => {
                state.idx++;
                if(state.idx < state.queue.length) showCard(); else closeStudy();
            }, 1200);
        }

        function speakWord() {
            const msg = new SpeechSynthesisUtterance(state.queue[state.idx].en);
            msg.lang = 'en-US';
            window.speechSynthesis.speak(msg);
        }

        // --- æ•°æ®ä¸ç»Ÿè®¡ ---
        function renderStats() {
            const levels = [0, 0, 0, 0, 0, 0, 0, 0, 0];
            Object.values(state.mem).forEach(m => levels[Math.min(m.lv, 8)]++);
            
            const container = document.getElementById('ebbinghaus-stats');
            container.innerHTML = levels.map((count, i) => `
                <div>
                    <div class="flex justify-between text-[10px] font-bold mb-1 uppercase opacity-50">
                        <span>Level ${i} ${i===8?'(Mastered)':''}</span><span>${count} words</span>
                    </div>
                    <div class="stat-bar"><div class="stat-fill" style="width: ${(count/RAW_LIB.length)*100}%"></div></div>
                </div>
            `).join('');
            
            document.getElementById('total-mastered').innerText = levels[8];
            
            // ç§°å·ç³»ç»Ÿ
            const titles = ["è¯æ±‡å­¦å¾’", "è¯­è¨€è¡Œè€…", "å¾‹æ”¿å…ˆé”‹", "åšå­¦è€…", "è¯­è¨€å¤§å¸ˆ"];
            const rank = Math.min(Math.floor(levels.reduce((a,b)=>a+b, 0)/5), 4);
            document.getElementById('rank-tag').innerText = `${titles[rank]} Lv.${rank+1}`;
        }

        // --- ä¾§è¾¹æ åŠŸèƒ½ ---
        function toggleSidebar(show) {
            document.getElementById('settings-sidebar').classList.toggle('open', show);
            document.getElementById('settings-overlay').classList.toggle('hide', !show);
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const lines = event.target.result.split('\n');
                lines.forEach(line => {
                    if(line.trim()) {
                        const [en, zh] = line.split(',');
                        RAW_LIB.push({ id: 'custom_'+Date.now()+Math.random(), cat: 'custom', en: en.trim(), zh: zh?.trim()||'æœªå®šä¹‰', d: 'ç”¨æˆ·ä¸Šä¼ è¯æ¡' });
                    }
                });
                alert("è¯ä¹¦ä¸Šä¼ æˆåŠŸï¼å·²åŠ å…¥è¯åº“ã€‚");
                renderExplore();
            };
            reader.readAsText(file);
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "lexiflow_backup.json");
            downloadAnchorNode.click();
        }

        // --- åŸºç¡€è¾…åŠ© ---
        function switchTab(tab) {
            ['home', 'explore', 'stats'].forEach(t => {
                document.getElementById('view-'+t).classList.toggle('hide', t !== tab);
                document.getElementById('btn-'+t).classList.toggle('active-tab', t === tab);
                document.getElementById('btn-'+t).classList.toggle('opacity-30', t !== tab);
            });
            if(tab === 'explore') renderExplore();
            if(tab === 'stats') renderStats();
        }

        function updateDashboard() {
            const now = Date.now();
            const news = RAW_LIB.filter(i => state.mem[i.id]?.lv === 0).length;
            const reviews = RAW_LIB.filter(i => state.mem[i.id]?.lv > 0 && now >= state.mem[i.id].next).length;
            document.getElementById('num-new').innerText = news;
            document.getElementById('num-review').innerText = reviews;
        }

        function save() { localStorage.setItem('lexi_v7_mem', JSON.stringify(state.mem)); }
        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateDashboard(); }
        function toggleDarkMode() {
            state.dark = !state.dark;
            document.body.classList.toggle('dark', state.dark);
            localStorage.setItem('lexi_v7_dark', state.dark);
        }

        function renderExplore() {
            const container = document.getElementById('explore-list');
            const filtered = RAW_LIB.filter(i => state.filter === 'all' || i.cat === state.filter);
            container.innerHTML = filtered.map(i => `
                <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] shadow-sm flex justify-between items-center">
                    <div>
                        <span class="text-[8px] font-black opacity-30 uppercase">${i.cat}</span>
                        <h4 class="text-lg font-black">${i.en}</h4>
                        <p class="text-xs opacity-50">${i.zh}</p>
                    </div>
                    ${state.mem[i.id] ? 'âœ…' : `<button onclick="addToPlan('${i.id}')" class="bg-indigo-50 dark:bg-slate-700 text-indigo-500 text-[10px] font-black px-4 py-2 rounded-full">ADD</button>`}
                </div>
            `).join('');
        }

        function addToPlan(id) {
            state.mem[id] = { lv: 0, next: 0 };
            save(); renderExplore(); updateDashboard();
        }

        init();
    </script>
</body>
</html>
