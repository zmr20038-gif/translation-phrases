<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LexiFlow MTI v7.0 Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Noto+Serif+SC:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #4F46E5; --bg: #F8FAFC; --card-shadow: 0 25px 60px -15px rgba(0,0,0,0.06); }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; min-height: 100vh; color: #1E293B; }
        .serif { font-family: 'Noto Serif SC', serif; }
        .hide { display: none !important; }
        
        /* æ·±åº¦ä¼˜åŒ–ï¼šæ›´å¹³æ»‘çš„åˆ—è¡¨å±•å¼€ */
        .expandable-content { max-height: 0; overflow: hidden; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; }
        .expanded { border-color: var(--accent) !important; background: #FFF !important; transform: translateY(-2px); }
        .expanded .expandable-content { max-height: 1000px; opacity: 1; padding-top: 1.5rem; }
        .expanded .chevron { transform: rotate(180deg); opacity: 1; color: var(--accent); }

        /* æ·±åº¦ä¼˜åŒ–ï¼šå¡ç‰‡ç‰©ç†æ„Ÿ */
        .card-container { perspective: 2000px; width: 90%; max-width: 380px; height: 540px; margin: auto; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.15); transform-style: preserve-3d; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 3.5rem; background: white; padding: 2.5rem; display: flex; flex-direction: column; box-shadow: var(--card-shadow); border: 1px solid rgba(255,255,255,0.8); }
        .card-back { transform: rotateY(180deg); background: #FFF; }
        
        .back-content-wrapper { margin: auto 0; width: 100%; }

        /* ç»ç’ƒæ‹Ÿæ€å¯¼èˆª */
        .nav-glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: saturate(180%) blur(25px); border-top: 1px solid rgba(0,0,0,0.04); }
        .active-tag { background: var(--accent) !important; color: white !important; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); }
        
        /* è¾“å…¥æ¡†ç„¦ç‚¹ä¼˜åŒ– */
        input:focus, textarea:focus { background: white !important; border-color: rgba(79, 70, 229, 0.2) !important; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.03); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æŒ‰é’®ç‚¹å‡»åé¦ˆ */
        .btn-active:active { transform: scale(0.96); opacity: 0.9; }
    </style>
</head>
<body class="select-none">

    <section id="auth-screen" class="fixed inset-0 bg-white z-[1000] flex flex-col items-center justify-center p-8">
        <div class="mb-16 text-center">
            <div class="inline-block p-4 rounded-3xl bg-indigo-50 mb-6">
                <span class="text-4xl">ğŸ–‹ï¸</span>
            </div>
            <h1 class="text-5xl font-black italic tracking-tighter mb-2">Lexi<span class="text-indigo-600">MTI</span></h1>
            <p class="text-[10px] font-bold opacity-30 tracking-[0.3em] uppercase">Advanced Workspace</p>
        </div>
        <div class="w-full max-w-sm space-y-4">
            <input id="auth-phone" type="tel" placeholder="Phone Number" class="w-full bg-slate-50 p-6 rounded-3xl outline-none border border-transparent transition-all font-bold text-center text-xl">
            <div class="flex gap-3">
                <input id="auth-code" type="number" placeholder="Code" class="flex-1 bg-slate-50 p-6 rounded-3xl outline-none border border-transparent transition-all font-bold text-center text-xl">
                <button onclick="vibrate(); alert('Code: 1234')" class="px-6 bg-slate-900 text-white rounded-3xl text-[10px] font-black uppercase tracking-widest">Get</button>
            </div>
            <button onclick="vibrate(); handleLogin()" class="w-full bg-indigo-600 text-white py-6 rounded-[2rem] font-black shadow-2xl shadow-indigo-200 btn-active transition-all mt-6 text-sm uppercase">Launch Experience</button>
        </div>
    </section>

    <div id="app-content" class="hide flex-1 flex flex-col max-w-2xl mx-auto w-full relative min-h-screen">
        <header class="p-8 flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-black italic tracking-tighter">LexiFlow <span class="text-indigo-600">v7.0</span></h2>
                <div id="online-indicator" class="flex items-center gap-1 mt-1">
                    <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
                    <span class="text-[8px] font-black opacity-30 uppercase tracking-widest">Local Database Syncing</span>
                </div>
            </div>
            <button onclick="vibrate(); toggleSidebar(true)" class="w-12 h-12 bg-white rounded-2xl shadow-sm border border-slate-50 flex items-center justify-center">âš™ï¸</button>
        </header>

        <main class="flex-1 px-8 overflow-y-auto no-scrollbar pb-36">
            <div id="view-home" class="space-y-8">
                <div class="grid grid-cols-2 gap-5">
                    <div onclick="vibrate(); prepStudy('new')" class="bg-white p-8 rounded-[3rem] shadow-sm btn-active transition-all border border-slate-50">
                        <p class="text-[10px] font-black opacity-30 uppercase mb-2 tracking-tighter">New Entry</p>
                        <p id="num-new" class="text-5xl font-black text-indigo-600 tracking-tighter">0</p>
                    </div>
                    <div onclick="vibrate(); prepStudy('review')" class="bg-white p-8 rounded-[3rem] shadow-sm btn-active transition-all border border-slate-50">
                        <p class="text-[10px] font-black opacity-30 uppercase mb-2 tracking-tighter">Reviewing</p>
                        <p id="num-rev" class="text-5xl font-black text-emerald-500 tracking-tighter">0</p>
                    </div>
                </div>

                <div class="bg-slate-900 rounded-[3.5rem] p-10 text-white relative overflow-hidden min-h-[180px] flex flex-col justify-center shadow-2xl shadow-slate-200">
                    <div class="relative z-10">
                        <p class="text-[10px] font-black opacity-40 uppercase mb-3 tracking-[0.2em]">Selected Engine</p>
                        <h3 id="plan-text" class="text-2xl font-black serif leading-tight">---</h3>
                    </div>
                    <div class="absolute -right-6 -bottom-10 text-[10rem] opacity-5 font-black italic">MTI</div>
                </div>

                <div class="bg-white border border-slate-100 rounded-[3rem] p-10 space-y-6 shadow-sm">
                    <div class="flex justify-between items-center">
                        <span id="quote-date" class="text-[10px] font-black opacity-40 uppercase tracking-widest">---</span>
                        <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 font-serif text-xl">â€œ</div>
                    </div>
                    <p id="quote-en" class="text-lg font-bold italic leading-relaxed text-slate-800 tracking-tight">---</p>
                    <p id="quote-zh" class="text-sm serif text-slate-400 leading-loose">---</p>
                </div>
            </div>

            <div id="view-explore" class="hide space-y-6">
                <div class="sticky top-0 bg-[#F8FAFC]/90 backdrop-blur-md pb-4 z-20">
                    <input type="text" id="search-box" oninput="runSearch()" placeholder="Search terms or tags..." class="w-full p-6 rounded-[2rem] bg-white shadow-sm outline-none font-bold text-sm border-2 border-transparent transition-all">
                    <div id="cat-tags-container" class="flex gap-2 overflow-x-auto no-scrollbar py-4"></div>
                </div>
                <div id="search-list" class="space-y-4"></div>
            </div>

            <div id="view-books" class="hide">
                <div class="flex justify-between items-center mb-8 px-2">
                    <h3 class="text-3xl font-black italic tracking-tighter">Archive</h3>
                    <button onclick="createNewBook()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl text-[10px] font-black shadow-lg shadow-indigo-100">+ NEW</button>
                </div>
                <div id="book-grid" class="grid grid-cols-2 gap-5"></div>
            </div>

            <div id="view-book-detail" class="hide">
                <div class="flex items-center gap-6 mb-10 px-2">
                    <button onclick="switchTab('books')" class="w-14 h-14 bg-white rounded-3xl flex items-center justify-center shadow-sm text-lg btn-active">â†</button>
                    <div>
                        <h3 id="book-title-h" class="text-2xl font-black serif">---</h3>
                        <p id="book-count-h" class="text-[10px] font-bold opacity-30 uppercase tracking-widest"></p>
                    </div>
                </div>
                <div id="book-item-list" class="space-y-4"></div>
            </div>

            <div id="view-import" class="hide">
                <div class="bg-white rounded-[3.5rem] p-10 space-y-8 shadow-sm border border-slate-50">
                    <div class="space-y-1">
                        <p class="text-[10px] font-black opacity-30 ml-2 uppercase tracking-widest">Destination</p>
                        <select id="import-book-sel" class="w-full bg-slate-50 p-5 rounded-3xl text-xs font-black outline-none border-none appearance-none"></select>
                    </div>
                    <div class="space-y-3">
                        <p class="text-[10px] font-black opacity-30 ml-2 uppercase tracking-widest">Tag Classification</p>
                        <div id="import-tag-hints" class="flex gap-2 overflow-x-auto no-scrollbar"></div>
                        <input id="in-cat" type="text" placeholder="Enter custom tag..." class="w-full bg-slate-50 p-5 rounded-3xl text-xs outline-none border-2 border-transparent">
                    </div>
                    <div class="space-y-4">
                        <input id="in-en" type="text" placeholder="English Term" class="w-full p-6 rounded-3xl bg-slate-50 outline-none font-black text-xl border-2 border-transparent">
                        <input id="in-zh" type="text" placeholder="æ ¸å¿ƒä¸­æ–‡ç¿»è¯‘" class="w-full p-6 rounded-3xl bg-slate-50 outline-none font-bold text-xl serif border-2 border-transparent">
                        <textarea id="in-ai" placeholder="Description & Examples..." class="w-full p-6 rounded-3xl bg-slate-50 outline-none text-xs h-40 resize-none serif leading-relaxed border-2 border-transparent"></textarea>
                    </div>
                    <button onclick="vibrate(); doImport()" class="w-full bg-indigo-600 text-white py-7 rounded-[2.5rem] font-black shadow-2xl shadow-indigo-100 btn-active transition-all uppercase text-xs tracking-widest">Add to Library</button>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 nav-glass p-8 pb-12 flex justify-around items-center z-[100]">
            <button onclick="vibrate(); switchTab('home')" id="nav-home" class="text-2xl btn-active">ğŸ </button>
            <button onclick="vibrate(); switchTab('explore')" id="nav-explore" class="text-2xl opacity-20 btn-active">ğŸ”</button>
            <button onclick="vibrate(); switchTab('books')" id="nav-books" class="text-2xl opacity-20 btn-active">ğŸ“š</button>
            <button onclick="vibrate(); switchTab('import')" id="nav-import" class="text-2xl opacity-20 btn-active">ğŸ“¥</button>
        </nav>
    </div>

    <section id="study-layer" class="fixed inset-0 bg-white z-[200] hide flex flex-col">
        <header class="p-10 flex justify-between items-center">
            <button onclick="vibrate(); closeStudy()" class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center font-black">âœ•</button>
            <div id="study-p" class="text-[11px] font-black bg-slate-900 text-white px-5 py-2 rounded-full shadow-lg">0 / 0</div>
            <button onclick="vibrate(); playTTS()" class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center">ğŸ”Š</button>
        </header>
        
        <div class="flex-1 flex items-center justify-center p-6 pb-12">
            <div class="card-container" id="studyCard">
                <div class="flip-card-inner" id="study-card-inner" onclick="handleCardFlip(event)">
                    <div class="card-face flex items-center justify-center px-10 text-center border-b-[12px] border-indigo-600">
                        <h2 id="card-en" class="text-4xl font-black italic tracking-tighter leading-tight text-slate-800">Term</h2>
                    </div>
                    <div class="card-face card-back no-scrollbar overflow-y-auto">
                        <div class="back-content-wrapper space-y-10">
                            <div class="text-center px-4">
                                <h3 id="card-zh" class="text-3xl font-black text-indigo-600 serif mb-6 tracking-tight">ä¸­æ–‡ç¿»è¯‘</h3>
                                <div id="card-ai-box" class="text-sm serif text-slate-500 leading-relaxed space-y-6"></div>
                            </div>
                            <div onclick="event.stopPropagation()" class="px-2">
                                <p class="text-[9px] font-black opacity-20 uppercase mb-3 ml-2 tracking-widest text-center">Researcher Notes</p>
                                <textarea id="card-note" oninput="syncNote()" class="w-full bg-slate-50 p-6 rounded-[2rem] text-xs outline-none serif min-h-[140px] border-2 border-transparent focus:border-indigo-100 transition-all shadow-inner" placeholder="Enter observation..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="p-10 pb-16 bg-white flex gap-5 max-w-2xl mx-auto w-full border-t border-slate-50">
            <button onclick="vibrate(); finishSRS(1)" class="flex-1 py-7 bg-slate-100 rounded-[2.5rem] font-black text-[10px] uppercase text-slate-400 tracking-[0.2em]">Forgot</button>
            <button onclick="vibrate(); finishSRS(2)" class="flex-1 py-7 bg-indigo-50 rounded-[2.5rem] font-black text-[10px] uppercase text-indigo-400 tracking-[0.2em]">Blurry</button>
            <button onclick="vibrate(); finishSRS(3)" class="flex-1 py-7 bg-indigo-600 text-white rounded-[2.5rem] font-black text-[10px] uppercase shadow-2xl shadow-indigo-200 tracking-[0.2em]">Mastered</button>
        </footer>
    </section>

    <div id="side-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-slate-900/40 backdrop-blur-md z-[300] hide"></div>
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white z-[301] p-12 translate-x-full transition-transform duration-500 flex flex-col shadow-[-20px_0_50px_rgba(0,0,0,0.05)]">
        <h3 class="text-3xl font-black italic border-b pb-8 mb-10">Console</h3>
        <div class="flex-1 space-y-12 overflow-y-auto no-scrollbar">
            <div>
                <p class="text-[10px] font-black opacity-30 mb-5 uppercase tracking-widest text-indigo-600">Daily Quota: <span id="limit-val">20</span></p>
                <input type="range" id="daily-limit" min="5" max="50" step="5" class="w-full accent-indigo-600 h-1.5 bg-slate-100 rounded-lg appearance-none cursor-pointer">
            </div>
            <div>
                <p class="text-[10px] font-black opacity-30 mb-5 uppercase tracking-widest text-indigo-600">Active Pipeline</p>
                <div id="book-picker" class="space-y-4"></div>
            </div>
        </div>
        <button onclick="vibrate(); saveSettings()" class="w-full py-7 bg-slate-900 text-white rounded-[2.5rem] font-black text-xs mt-8 shadow-2xl btn-active uppercase tracking-widest">Apply Config</button>
    </aside>

    <script>
        // --- æ ¸å¿ƒä¼˜åŒ–é€»è¾‘ï¼šæ’ç‰ˆä¸äº¤äº’ ---

        const TEST_STUBS = [
            {id:'t1', en:'Whole-process people\'s democracy', zh:'å…¨è¿‡ç¨‹äººæ°‘æ°‘ä¸»', cat:'æ”¿æ²»', ai:'Concept: A key innovation in China\'s political system.\nExample: Whole-process people\'s democracy ensures that people are the masters of the country.\nè¯‘æ–‡ï¼šå…¨è¿‡ç¨‹äººæ°‘æ°‘ä¸»ç¡®ä¿äº†äººæ°‘å½“å®¶ä½œä¸»ã€‚'},
            {id:'t2', en:'High-quality development', zh:'é«˜è´¨é‡å‘å±•', cat:'ç»æµ', ai:'Concept: Economic growth that is efficient and sustainable.\nExample: We must prioritize high-quality development in our modernization drive.\nè¯‘æ–‡ï¼šåœ¨ç°ä»£åŒ–å»ºè®¾ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠé«˜è´¨é‡å‘å±•æ”¾åœ¨é¦–ä½ã€‚'},
            {id:'t3', en:'Cultural soft power', zh:'æ–‡åŒ–è½¯å®åŠ›', cat:'æ–‡åŒ–', ai:'Concept: Influence through culture and values.\nExample: Promoting traditional festivals enhances a nation\'s cultural soft power.\nè¯‘æ–‡ï¼šæ¨å¹¿ä¼ ç»ŸèŠ‚æ—¥èƒ½å¢å¼ºä¸€ä¸ªå›½å®¶çš„æ–‡åŒ–è½¯å®åŠ›ã€‚'}
        ];

        const QUOTES = [
            {en:"Translation is not a matter of words only: it is a matter of making the whole culture intelligible.", zh:"ç¿»è¯‘ä¸ä»…æ˜¯æ–‡å­—ä¹‹äº‹ï¼Œæ›´æ˜¯è®©æ•´ä¸ªæ–‡åŒ–å˜å¾—æ˜“äºç†è§£ä¹‹äº‹ã€‚"},
            {en:"To translate, one must have a style of his own, for the translation will have no rhythm.", zh:"è¯‘è€…é¡»æœ‰å…¶æ ¼ï¼Œå¦åˆ™è¯‘æ–‡å°†æ¯«æ— éŸµå¾‹å¯è¨€ã€‚"},
            {en:"The translator is the invisible bridge between worlds.", zh:"è¯‘è€…æ˜¯ä¸–ç•Œä¹‹é—´éšå½¢çš„æ¡¥æ¢ã€‚"}
        ];

        let state = {
            user: null, books: {}, mem: {},
            settings: { dailyLimit: 20, selectedBooks: [] },
            activeTab: 'home', curCat: 'ALL', queue: [], idx: 0,
            activeBook: null
        };

        // æ™ºèƒ½åé¦ˆï¼šéœ‡åŠ¨
        function vibrate() { if(window.navigator.vibrate) window.navigator.vibrate(10); }

        // --- æ ¸å¿ƒæ¸²æŸ“å¼•æ“ï¼šæ™ºèƒ½è¯†åˆ«å†…å®¹å±‚çº§ ---
        function formatAIContent(text) {
            if(!text) return `<p class="opacity-20 italic">No description provided.</p>`;
            return text.split('\n').map(line => {
                if(line.startsWith('Example:') || line.startsWith('ä¾‹å¥:')) 
                    return `<p class="font-black text-slate-800 mt-4 text-xs tracking-tight uppercase border-l-4 border-indigo-600 pl-3">${line}</p>`;
                if(line.startsWith('è¯‘æ–‡:')) 
                    return `<p class="text-indigo-500 italic mb-4 text-xs font-medium bg-indigo-50/50 p-3 rounded-xl">${line}</p>`;
                if(line.startsWith('Concept:') || line.startsWith('æ¦‚å¿µ:'))
                    return `<p class="text-[10px] font-black opacity-30 uppercase tracking-[0.2em] mb-1">${line}</p>`;
                return `<p class="mb-2 leading-relaxed opacity-70 font-medium">${line}</p>`;
            }).join('');
        }

        function renderItems(containerId, items) {
            const container = document.getElementById(containerId);
            if(!items || !items.length) {
                container.innerHTML = `<div class="py-24 text-center opacity-10 font-black italic text-2xl tracking-widest">NO DATA</div>`;
                return;
            }
            
            container.innerHTML = items.map(i => `
                <div class="bg-white rounded-[2.5rem] border-2 border-transparent shadow-sm transition-all overflow-hidden" onclick="vibrate(); this.classList.toggle('expanded')">
                    <div class="p-7 flex justify-between items-center cursor-pointer">
                        <div class="flex-1">
                            <h5 class="text-xl font-black text-slate-800 tracking-tighter">${i.en}</h5>
                            <div class="flex gap-2 mt-2">
                                <span class="text-[8px] font-black text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full uppercase tracking-widest">${i.cat}</span>
                            </div>
                        </div>
                        <span class="chevron transition-transform opacity-10 text-[10px]">â–¼</span>
                    </div>
                    <div class="expandable-content px-8 pb-8">
                        <div class="border-t border-slate-50 pt-6 space-y-6">
                            <div>
                                <p class="text-[9px] font-black text-slate-300 uppercase mb-2 tracking-[0.2em]">Translation</p>
                                <p class="text-2xl font-black serif text-indigo-600 tracking-tight">${i.zh}</p>
                            </div>
                            <div>
                                <p class="text-[9px] font-black text-slate-300 uppercase mb-2 tracking-[0.2em]">Analysis</p>
                                <div class="text-sm serif text-slate-600">${formatAIContent(i.ai)}</div>
                            </div>
                            <div class="flex justify-end pt-4">
                                <button onclick="deleteItem(event, '${i.id}')" class="text-[9px] text-red-300 font-black uppercase tracking-[0.3em] hover:text-red-600 transition-colors">Terminate</button>
                            </div>
                        </div>
                    </div>
                </div>`).join('');
        }

        // --- æ•°æ®å®‰å…¨ä¸æŒä¹…åŒ– ---
        function handleLogin() {
            const p = document.getElementById('auth-phone').value;
            const c = document.getElementById('auth-code').value;
            if(!p || c !== '1234') return alert("Access Denied: Invalid Credentials");
            state.user = p;
            localStorage.setItem('lexi_v7_user', p);
            document.getElementById('auth-screen').classList.add('hide');
            document.getElementById('app-content').classList.remove('hide');
            loadData();
        }

        function loadData() {
            const saved = localStorage.getItem(`lexi_v7_data_${state.user}`);
            if(saved) {
                const d = JSON.parse(saved);
                state.books = d.books || {}; state.mem = d.mem || {}; state.settings = d.settings || { dailyLimit: 20, selectedBooks: [] };
            } else {
                state.books = { "MTIæ ¸å¿ƒæœ¯è¯­": { color:"from-slate-800 to-slate-900", items: TEST_STUBS } };
                state.mem = {}; state.settings = { dailyLimit: 20, selectedBooks: ["MTIæ ¸å¿ƒæœ¯è¯­"] };
            }
            initQuote(); save(); updateDash(); switchTab('home');
        }

        function save() { localStorage.setItem(`lexi_v7_data_${state.user}`, JSON.stringify({books: state.books, mem: state.mem, settings: state.settings})); }

        function doImport() {
            const en = document.getElementById('in-en').value.trim();
            const zh = document.getElementById('in-zh').value.trim();
            const cat = document.getElementById('in-cat').value.trim() || "GENERAL";
            const bookName = document.getElementById('import-book-sel').value;
            
            if(!en || !zh || !bookName) return alert("Validation Error: Missing Fields");
            
            const newItem = { id: 'u'+Date.now(), en, zh, cat, ai: document.getElementById('in-ai').value };
            if(!state.books[bookName]) state.books[bookName] = { color: "from-slate-600 to-slate-800", items: [] };
            state.books[bookName].items = [...state.books[bookName].items, newItem];
            
            save(); alert("Sequence Integrated Successfully");
            ['in-en','in-zh','in-cat','in-ai'].forEach(id => document.getElementById(id).value = '');
            updateCatTags(); updateDash();
        }

        // --- å­¦ä¹ ç³»ç»Ÿï¼šåŠ å›ºå‚ç›´å±…ä¸­ ---
        function handleCardFlip(e) {
            if(e.target.closest('textarea') || e.target.closest('button')) return;
            vibrate();
            document.getElementById('studyCard').classList.toggle('flipped');
        }

        function renderCard() {
            const i = state.queue[state.idx];
            document.getElementById('studyCard').classList.remove('flipped');
            document.getElementById('card-en').innerText = i.en;
            document.getElementById('card-zh').innerText = i.zh;
            document.getElementById('card-ai-box').innerHTML = formatAIContent(i.ai);
            document.getElementById('card-note').value = state.mem[i.id]?.note || "";
            document.getElementById('study-p').innerText = `${state.idx + 1} / ${state.queue.length}`;
        }

        function syncNote() {
            const i = state.queue[state.idx];
            if(!state.mem[i.id]) state.mem[i.id] = { lv:0, next:0, note:"" };
            state.mem[i.id].note = document.getElementById('card-note').value;
            save();
        }

        // --- å¯¼èˆªä¸åè¨€ ---
        function initQuote() {
            const now = new Date();
            document.getElementById('quote-date').innerText = now.toLocaleDateString('en-US', { weekday:'long', month:'short', day:'numeric' });
            const q = QUOTES[now.getDate() % QUOTES.length];
            document.getElementById('quote-en').innerText = q.en;
            document.getElementById('quote-zh').innerText = q.zh;
        }

        function switchTab(t) {
            state.activeTab = t;
            ['home','explore','books','import','book-detail'].forEach(v => document.getElementById('view-'+v).classList.add('hide'));
            document.getElementById('view-'+t).classList.remove('hide');
            document.querySelectorAll('nav button').forEach(b => b.classList.add('opacity-20'));
            const navId = t === 'book-detail' ? 'nav-books' : 'nav-' + t;
            document.getElementById(navId).classList.remove('opacity-20');
            if(t === 'explore') { updateCatTags(); runSearch(); }
            if(t === 'import') updateCatTags();
            if(t === 'books') renderBooks();
        }

        function updateCatTags() {
            let cats = new Set();
            Object.values(state.books).forEach(b => b.items.forEach(i => { if(i.cat) cats.add(i.cat); }));
            
            document.getElementById('cat-tags-container').innerHTML = `<button onclick="vibrate(); setCatFilter('ALL')" class="px-6 py-2 rounded-full text-[10px] font-black bg-white border border-slate-100 whitespace-nowrap ${state.curCat==='ALL'?'active-tag':''}">ALL</button>` + 
                Array.from(cats).map(c => `<button onclick="vibrate(); setCatFilter('${c}')" class="px-6 py-2 rounded-full text-[10px] font-black bg-white border border-slate-100 whitespace-nowrap ${state.curCat===c?'active-tag':''}"> ${c} </button>`).join('');
            
            document.getElementById('import-tag-hints').innerHTML = Array.from(cats).map(c => `<button onclick="vibrate(); document.getElementById('in-cat').value='${c}'" class="px-4 py-2 bg-slate-50 rounded-xl text-[9px] font-black text-slate-400 uppercase">${c}</button>`).join('');
            document.getElementById('import-book-sel').innerHTML = Object.keys(state.books).map(k => `<option value="${k}">${k}</option>`).join('');
        }

        function setCatFilter(cat) { state.curCat = cat; updateCatTags(); runSearch(); }

        function runSearch() {
            const q = document.getElementById('search-box').value.toLowerCase();
            let all = []; Object.values(state.books).forEach(b => all = all.concat(b.items));
            const filtered = all.filter(i => (i.en.toLowerCase().includes(q) || i.zh.includes(q)) && (state.curCat === 'ALL' || i.cat === state.curCat));
            renderItems('search-list', filtered);
        }

        function renderBooks() {
            document.getElementById('book-grid').innerHTML = Object.keys(state.books).map(k => `
                <div onclick="vibrate(); openBook('${k}')" class="aspect-[4/5] rounded-[3.5rem] bg-gradient-to-br ${state.books[k].color || 'from-slate-700 to-slate-900'} p-8 flex flex-col justify-end text-white shadow-xl btn-active transition-all relative overflow-hidden border border-white/10">
                    <p class="text-[9px] font-black opacity-50 uppercase mb-2 tracking-widest">${state.books[k].items.length} Elements</p>
                    <h4 class="text-xl font-black serif leading-tight">${k}</h4>
                </div>`).join('');
        }

        function openBook(k) { state.activeBook = k; document.getElementById('book-title-h').innerText = k; document.getElementById('book-count-h').innerText = state.books[k].items.length + " æ¡æœ¯è¯­å·²å°±ç»ª"; renderBookContent(); switchTab('book-detail'); }
        function renderBookContent() { renderItems('book-item-list', state.books[state.activeBook].items); }

        function createNewBook() {
            const n = prompt("Designate Archive Name:");
            if(n && !state.books[n]) {
                state.books[n] = { color: "from-indigo-900 to-slate-900", items: [] };
                save(); renderBooks();
            }
        }

        function updateDash() {
            let n = 0, r = 0;
            state.settings.selectedBooks.forEach(k => {
                if(!state.books[k]) return;
                state.books[k].items.forEach(i => {
                    const m = state.mem[i.id] || {lv:0, next:0};
                    if(m.lv === 0) n++; else if(m.lv < 5 && Date.now() >= m.next) r++;
                });
            });
            document.getElementById('num-new').innerText = n;
            document.getElementById('num-rev').innerText = r;
            document.getElementById('plan-text').innerText = state.settings.selectedBooks.join(' â€¢ ') || "No active pipeline";
        }

        function prepStudy(mode) {
            let pool = [];
            state.settings.selectedBooks.forEach(k => {
                state.books[k]?.items.forEach(i => {
                    const m = state.mem[i.id] || {lv:0, next:0};
                    if(mode === 'new' && m.lv === 0) pool.push(i);
                    else if(mode === 'review' && m.lv > 0 && m.lv < 5 && Date.now() >= m.next) pool.push(i);
                });
            });
            if(!pool.length) return alert("System Check: No queued items.");
            state.queue = mode === 'new' ? pool.slice(0, state.settings.dailyLimit) : pool.sort(() => Math.random() - 0.5).slice(0, 30);
            state.idx = 0;
            document.getElementById('study-layer').classList.remove('hide');
            renderCard();
        }

        function finishSRS(score) {
            const i = state.queue[state.idx];
            if(!state.mem[i.id]) state.mem[i.id] = {lv:0, next:0, note:""};
            const m = state.mem[i.id];
            if(score === 3) m.lv++; 
            else if(score === 1) m.lv = Math.max(0, m.lv - 1);
            else if(score === 2) { state.queue.push(i); }
            const intervals = [0, 60000, 86400000, 259200000, 604800000, 1296000000];
            m.next = Date.now() + (score === 3 ? intervals[Math.min(m.lv, 5)] : 0);
            save(); state.idx++;
            if(state.idx < state.queue.length) renderCard(); else closeStudy();
        }

        function closeStudy() { document.getElementById('study-layer').classList.add('hide'); updateDash(); }
        function playTTS() { const i = state.queue[state.idx]; const msg = new SpeechSynthesisUtterance(i.en); msg.lang = 'en-US'; window.speechSynthesis.speak(msg); }

        function toggleSidebar(s) {
            document.getElementById('sidebar').style.transform = s ? 'translateX(0)' : 'translateX(100%)';
            document.getElementById('side-overlay').classList.toggle('hide', !s);
            if(s) {
                document.getElementById('limit-val').innerText = state.settings.dailyLimit;
                document.getElementById('book-picker').innerHTML = Object.keys(state.books).map(k => `
                    <div class="flex items-center justify-between p-6 bg-slate-50 rounded-[2rem]">
                        <span class="text-[11px] font-black uppercase tracking-widest">${k}</span>
                        <input type="checkbox" value="${k}" ${state.settings.selectedBooks.includes(k)?'checked':''} class="book-chk w-6 h-6 accent-indigo-600">
                    </div>`).join('');
                document.getElementById('daily-limit').oninput = (e) => document.getElementById('limit-val').innerText = e.target.value;
            }
        }

        function saveSettings() {
            const chks = Array.from(document.querySelectorAll('.book-chk:checked')).map(c => c.value);
            if(!chks.length) return alert("Error: Pipeline must contain at least one archive.");
            state.settings.dailyLimit = parseInt(document.getElementById('daily-limit').value);
            state.settings.selectedBooks = chks.slice(0, 2);
            save(); toggleSidebar(false); updateDash();
        }

        function deleteItem(e, id) {
            e.stopPropagation();
            if(!confirm("Execute permanent deletion?")) return;
            Object.keys(state.books).forEach(bk => { state.books[bk].items = state.books[bk].items.filter(item => item.id !== id); });
            save();
            state.activeTab === 'book-detail' ? renderBookContent() : runSearch();
            updateDash();
        }

        if(localStorage.getItem('lexi_v7_user')) {
            state.user = localStorage.getItem('lexi_v7_user');
            document.getElementById('auth-screen').classList.add('hide');
            document.getElementById('app-content').classList.remove('hide');
            loadData();
        }
    </script>
</body>
</html>
